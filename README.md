# RILARC Scenario Generator - webapp

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
éŸ³å£°ãƒ»ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‹ã‚‰ã€YouTube/TikTokå‘ã‘ã®æ§‹é€ åŒ–ã‚·ãƒŠãƒªã‚ªï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚»ãƒªãƒ•ãƒ»ç”»åƒãƒ»æ¼«ç”»ãƒ»å‹•ç”»ï¼‰ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚

- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: webapp
- **ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼**: Hono + Cloudflare Pages/Workers + D1 Database + R2 Storage
- **æœ¬ç•ªURL**: https://webapp-c7n.pages.dev
- **GitHub**: https://github.com/matiuskuma2/webapp
- **æœ€çµ‚æ›´æ–°**: 2026-02-03ï¼ˆBGMã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆ¶å¾¡å¯¾å¿œ - audio_offset_ms, video_start_ms, video_end_msï¼‰

---

## ä¸»è¦æ©Ÿèƒ½

### 1. å…¥åŠ›å¯¾å¿œ
- **éŸ³å£°å…¥åŠ›**: MP3/WAV/M4A/OGG/WebMï¼ˆæœ€å¤§25MBï¼‰
- **ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›**: ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ï¼ˆæœ€å¤§åˆ¶é™ãªã—ï¼‰

### 2. è‡ªå‹•å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
1. **Parse**: é•·æ–‡ã‚’æ„å‘³å˜ä½ï¼ˆ500-1500æ–‡å­—ï¼‰ã®ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²
2. **Format**: å„ãƒãƒ£ãƒ³ã‚¯ã‚’OpenAI GPT-4oã§ã‚·ãƒŠãƒªã‚ªåŒ–ï¼ˆ2ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
3. **Image Generation**: Gemini APIã§å„ã‚·ãƒ¼ãƒ³ã®ç”»åƒç”Ÿæˆ
4. **Export**: ç”»åƒZIPã€ã‚»ãƒªãƒ•CSVã€å…¨ãƒ•ã‚¡ã‚¤ãƒ«ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

### 2.5 ã‚·ãƒ¼ãƒ³åˆ†å‰²ãƒ¢ãƒ¼ãƒ‰ï¼ˆFormatï¼‰

#### 2ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†å‰²æ–¹å¼

| ãƒ¢ãƒ¼ãƒ‰ | åç§° | å‹•ä½œ |
|-------|------|------|
| `preserve` | åŸæ–‡ç¶­æŒï¼ˆå°æœ¬ãƒ¢ãƒ¼ãƒ‰ï¼‰ | dialogue=åŸæ–‡ãã®ã¾ã¾ï¼ˆæ”¹å¤‰ç¦æ­¢ï¼‰ã€æ”¹è¡Œã§åˆ†å‰²ã€image_promptã®ã¿AIç”Ÿæˆ |
| `ai` | AIæ•´ç†ãƒ¢ãƒ¼ãƒ‰ | AIãŒæ„å›³ã‚’èª­ã¿å–ã£ã¦æ•´å½¢ã€30-500æ–‡å­—ç¨‹åº¦ã€çœç•¥ã¯æ¥µåŠ›é¿ã‘ã‚‹ |

#### reset=true ã®ä»•æ§˜ï¼ˆç¢ºå®šç‰ˆï¼‰

**å‰Šé™¤å¯¾è±¡ï¼ˆåˆ¶ä½œç‰©ï¼‰**:
- scene_balloonsï¼ˆå¹ãå‡ºã—ï¼‰
- scene_audio_cuesï¼ˆSFXï¼‰
- scene_telopsï¼ˆãƒ†ãƒ­ãƒƒãƒ—ï¼‰
- scene_motionï¼ˆãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- scene_style_settingsï¼ˆã‚·ãƒ¼ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
- scene_utterancesï¼ˆç™ºè©±ï¼‰
- scene_character_mapï¼ˆã‚­ãƒ£ãƒ©å‰²å½“ï¼‰
- scene_character_traitsï¼ˆã‚­ãƒ£ãƒ©ç‰¹å¾´ï¼‰
- audio_generationsï¼ˆéŸ³å£°ï¼‰
- image_generationsï¼ˆç”»åƒï¼‰
- scenesï¼ˆã‚·ãƒ¼ãƒ³æœ¬ä½“ï¼‰

**ä¿æŒå¯¾è±¡ï¼ˆè¨­å®šï¼‰**:
- video_buildsï¼ˆãƒ“ãƒ«ãƒ‰å±¥æ­´ - ç›£æŸ»ç”¨ï¼‰
- project_audio_tracksï¼ˆBGMè¨­å®š - projectå˜ä½ï¼‰
- project_character_modelsï¼ˆã‚­ãƒ£ãƒ©å®šç¾© - projectå˜ä½ï¼‰
- project_style_settingsï¼ˆã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š - projectå˜ä½ï¼‰

#### API
```
POST /api/projects/:id/format
Body: {
  "split_mode": "preserve" | "ai",
  "target_scene_count": 5,
  "reset": true
}
```

#### preserve ãƒ¢ãƒ¼ãƒ‰ã®è©³ç´°
- **æ”¹è¡Œæ­£è¦åŒ–**: CRLFâ†’LFã€NBSPâ†’åŠè§’ç©ºç™½ã€å…¨è§’ç©ºç™½â†’åŠè§’ç©ºç™½
- **æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯**: åˆ†å‰²å¾Œã«æ–‡å­—æ•°ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹æ¤œè¨¼ï¼ˆç©ºç™½é™¤ãï¼‰
- **æ®µè½èª¿æ•´**: æ®µè½æ•° > target â†’ çµåˆï¼ˆ\n\nã§ç¹‹ãï¼‰ã€æ®µè½æ•° < target â†’ æ–‡å¢ƒç•Œã§åˆ†å‰²

#### AI ãƒ¢ãƒ¼ãƒ‰ã®è©³ç´°
- **targeté…åˆ†**: `chunkTarget = ceil(remainingTarget / pendingChunks.length)`
- **ä¸Šé™**: MAX_SCENES_PER_CHUNK = 5ï¼ˆ1 chunkã‚ãŸã‚Šæœ€å¤§5ã‚·ãƒ¼ãƒ³ï¼‰
- **æ–‡å­—æ•°åˆ¶é™**: 30-500æ–‡å­—ï¼ˆçœç•¥å›é¿ã®ãŸã‚ç·©å’Œæ¸ˆã¿ï¼‰

### 3. ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
- ã‚·ãƒ¼ãƒ³å˜ä½ã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å€‹åˆ¥ä¸Šæ›¸ãå¯èƒ½
- ç”»åƒç”Ÿæˆæ™‚ã« `prefix + prompt + suffix` ã®å½¢å¼ã§é©ç”¨
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ: æ—¥æœ¬ã‚¢ãƒ‹ãƒ¡é¢¨ã€ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ¼ã‚·ãƒ£ãƒ«é¢¨ã€ã‚·ãƒãƒèª¿

### 4. ãƒ†ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆ2ç³»çµ±ï¼‰

#### 4.1 Remotion ãƒ†ãƒ­ãƒƒãƒ—ï¼ˆå‹•ç”»å­—å¹•ï¼‰
å‹•ç”»ç”Ÿæˆæ™‚ã«å‹•çš„ã«æç”»ã•ã‚Œã‚‹å­—å¹•/ãƒ†ãƒ­ãƒƒãƒ—ã€‚å¾Œã‹ã‚‰è‡ªç”±ã«èª¿æ•´å¯èƒ½ã€‚

| è¨­å®šã‚«ãƒ†ã‚´ãƒª | é …ç›® |
|------------|------|
| **ãƒ—ãƒªã‚»ãƒƒãƒˆ** | minimal / outline / band / pop / cinematic |
| **ã‚µã‚¤ã‚º** | sm / md / lg |
| **ä½ç½®** | bottom / center / top |
| **ã‚«ã‚¹ã‚¿ãƒ ** | æ–‡å­—è‰²ã€ç¸å–ã‚Šè‰²/å¤ªã•ã€èƒŒæ™¯è‰²/é€éã€ãƒ•ã‚©ãƒ³ãƒˆã€å¤ªã• |
| **Typography** | æœ€å¤§è¡Œæ•°(1-5)ã€è¡Œé–“(100-200%)ã€æ–‡å­—é–“(-2~6px) |

- **æ°¸ç¶šåŒ–**: `PUT /api/projects/:id/telop-settings` ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ—¢å®šã¨ã—ã¦ä¿å­˜å¯èƒ½
- **SSOT**: `projects.settings_json.telops_remotion`

#### 4.2 æ¼«ç”»ç„¼ãè¾¼ã¿ãƒ†ãƒ­ãƒƒãƒ—
ç”»åƒ(PNG)ã«ç„¼ãè¾¼ã¾ã‚Œã‚‹å¹ãå‡ºã—/ãƒ†ãƒ­ãƒƒãƒ—ã€‚å†ç„¼ãè¾¼ã¿ãŒå¿…è¦ã€‚

| è¨­å®š | é …ç›® |
|-----|------|
| **ãƒ—ãƒªã‚»ãƒƒãƒˆ** | minimal / outline / band / pop / cinematic |
| **ã‚µã‚¤ã‚º** | sm / md / lg |
| **ä½ç½®** | bottom / center / top |

- **ä¿å­˜**: `PUT /api/projects/:id/comic-telop-settings`
- **ä¸€æ‹¬äºˆç´„**: `POST /api/projects/:id/comic/rebake`
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸŸ¡äºˆç´„ä¸­ / ğŸŸ æœªåæ˜  / âœ…æœ€æ–° / âšªæœªå…¬é–‹
- **SSOT**: `projects.settings_json.telops_comic`

> è©³ç´°ã¯ [`docs/TELOP_COMPLETE_REFERENCE.md`](docs/TELOP_COMPLETE_REFERENCE.md) ã‚’å‚ç…§

---

## ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆCloudflare D1ï¼‰
```
projects (1) â”€â”€< (N) transcriptions
    â”‚
    â”œâ”€â”€< (N) text_chunks
    â”‚
    â”œâ”€â”€< (1) project_style_settings â”€â”€> (1) style_presets
    â”‚
    â””â”€â”€< (N) scenes (1) â”€â”€< (N) image_generations
                    â”‚
                    â””â”€â”€< (1) scene_style_settings â”€â”€> (1) style_presets
```

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆCloudflare R2ï¼‰
- **audio/**: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«
- **images/**: ç”Ÿæˆç”»åƒï¼ˆ`images/{project_id}/scene_{idx}/{generation_id}_{timestamp}.png`ï¼‰

---

## API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
- `POST /api/projects` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
- `GET /api/projects` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
- `GET /api/projects/:id` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°
- `GET /api/projects/:id/scenes` - ã‚·ãƒ¼ãƒ³ä¸€è¦§ï¼ˆ`?view=board` ã§Builderç”¨æœ€å°æƒ…å ±ï¼‰

### å…¥åŠ›å‡¦ç†
- `POST /api/projects/:id/upload` - éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- `POST /api/projects/:id/source/text` - ãƒ†ã‚­ã‚¹ãƒˆä¿å­˜
- `POST /api/projects/:id/transcribe` - éŸ³å£°æ–‡å­—èµ·ã“ã—ï¼ˆOpenAI Whisperï¼‰
- `POST /api/projects/:id/parse` - ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²ï¼ˆchunkåŒ–ï¼‰

### ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ
- `POST /api/projects/:id/format` - ã‚·ãƒŠãƒªã‚ªç”Ÿæˆï¼ˆchunkå˜ä½å‡¦ç†ï¼‰
- `GET /api/projects/:id/format/status` - é€²æ—ç¢ºèª

### ç”»åƒç”Ÿæˆ
- `POST /api/scenes/:id/generate-image` - ã‚·ãƒ¼ãƒ³å˜ä½“ç”»åƒç”Ÿæˆ
- `POST /api/projects/:id/generate-images` - ãƒãƒƒãƒç”»åƒç”Ÿæˆï¼ˆ1ä»¶ãšã¤å‡¦ç†ï¼‰
- `GET /api/projects/:id/generate-images/status` - ç”»åƒç”Ÿæˆé€²æ—

### ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆ
- `GET /api/style-presets` - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§
- `GET /api/style-presets/:id` - ãƒ—ãƒªã‚»ãƒƒãƒˆè©³ç´°
- `POST /api/style-presets` - æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆä½œæˆ
- `PUT /api/style-presets/:id` - ãƒ—ãƒªã‚»ãƒƒãƒˆæ›´æ–°
- `DELETE /api/style-presets/:id` - ãƒ—ãƒªã‚»ãƒƒãƒˆå‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆï¼‰
- `GET /api/projects/:id/style-settings` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«å–å¾—
- `PUT /api/projects/:id/style-settings` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
- `PUT /api/scenes/:id/style` - ã‚·ãƒ¼ãƒ³å€‹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š

### ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- `GET /api/projects/:id/download/images` - ç”»åƒZIP
- `GET /api/projects/:id/download/csv` - ã‚»ãƒªãƒ•CSV
- `GET /api/projects/:id/download/all` - å…¨ãƒ•ã‚¡ã‚¤ãƒ«ZIP

### 5. BGMç®¡ç†æ©Ÿèƒ½

#### 5.1 ã‚·ãƒ¼ãƒ³åˆ¥BGM
ã‚·ãƒ¼ãƒ³ã”ã¨ã«å€‹åˆ¥ã®BGMã‚’è¨­å®šå¯èƒ½ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“BGMã‚ˆã‚Šå„ªå…ˆã•ã‚Œã‚‹ã€‚

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ |
|----------|------|
| `start_ms` | ã‚·ãƒ¼ãƒ³å†…ã®å†ç”Ÿé–‹å§‹ä½ç½®ï¼ˆmsï¼‰ |
| `end_ms` | ã‚·ãƒ¼ãƒ³å†…ã®å†ç”Ÿçµ‚äº†ä½ç½®ï¼ˆms, null=ã‚·ãƒ¼ãƒ³çµ‚äº†ã¾ã§ï¼‰ |
| `audio_offset_ms` | BGMãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿé–‹å§‹ä½ç½®ï¼ˆmsï¼‰ |
| `volume_override` | éŸ³é‡ï¼ˆ0.0-1.0ï¼‰ |
| `loop_override` | ãƒ«ãƒ¼ãƒ—è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: OFFï¼‰ |

- **API**: `/api/scenes/:sceneId/audio-assignments`
- **SSOT**: `scene_audio_assignments`

#### 5.2 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“BGM
å‹•ç”»å…¨ä½“ã‚’é€šã—ã¦å†ç”Ÿã•ã‚Œã‚‹BGMã€‚ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆ¶å¾¡ã‚’ã‚µãƒãƒ¼ãƒˆã€‚

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ |
|----------|------|
| `video_start_ms` | å‹•ç”»ä¸Šã®å†ç”Ÿé–‹å§‹ä½ç½®ï¼ˆmsï¼‰ |
| `video_end_ms` | å‹•ç”»ä¸Šã®å†ç”Ÿçµ‚äº†ä½ç½®ï¼ˆms, null=å‹•ç”»çµ‚äº†ã¾ã§ï¼‰ |
| `audio_offset_ms` | BGMãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿé–‹å§‹ä½ç½®ï¼ˆmsï¼‰ |
| `volume` | éŸ³é‡ï¼ˆ0.0-1.0ï¼‰ |
| `loop` | ãƒ«ãƒ¼ãƒ—è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: OFFï¼‰ |

- **API**: `/api/projects/:projectId/audio-tracks`
- **SSOT**: `project_audio_tracks`

#### 5.3 BGMãƒ€ãƒƒã‚­ãƒ³ã‚°
ã‚·ãƒ¼ãƒ³åˆ¥BGMå†ç”Ÿä¸­ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“BGMã®éŸ³é‡ãŒè‡ªå‹•çš„ã«ä¸‹ãŒã‚‹ï¼ˆå®Œå…¨ãƒŸãƒ¥ãƒ¼ãƒˆï¼‰ã€‚
ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆï¼ˆ120msï¼‰ã§ã‚¹ãƒ ãƒ¼ã‚ºãªåˆ‡ã‚Šæ›¿ãˆã‚’å®Ÿç¾ã€‚

---

## é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### å¿…è¦ãªç’°å¢ƒå¤‰æ•°ï¼ˆ`.dev.vars`ï¼‰
```bash
OPENAI_API_KEY=sk-...
GEMINI_API_KEY=...
CLOUDFLARE_ACCOUNT_ID=...
```

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨èµ·å‹•
```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ãƒ­ãƒ¼ã‚«ãƒ«DBåˆæœŸåŒ–
npm run db:migrate:local

# ãƒ“ãƒ«ãƒ‰
npm run build

# PM2ã§èµ·å‹•ï¼ˆsandboxç’°å¢ƒï¼‰
pm2 start ecosystem.config.cjs

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºï¼ˆVite dev serverï¼‰
npm run dev
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«DBæ“ä½œ
npm run db:console:local

# æœ¬ç•ªDBæ“ä½œï¼ˆè¦æ³¨æ„ï¼‰
npm run db:console:prod

# ãƒ­ãƒ¼ã‚«ãƒ«DBãƒªã‚»ãƒƒãƒˆ
npm run db:reset
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤

### å‰ææ¡ä»¶
1. Cloudflare API Key ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
2. D1 Database `webapp-production` ãŒä½œæˆæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
3. R2 Bucket ãŒä½œæˆæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨

### ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
```bash
# 1. ãƒ“ãƒ«ãƒ‰
npm run build

# 2. ãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy:prod

# ã¾ãŸã¯ç›´æ¥
npx wrangler pages deploy dist --project-name webapp
```

### åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚
```bash
# 1. D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
npx wrangler d1 create webapp-production

# 2. wrangler.jsonc ã« database_id ã‚’è¨­å®š

# 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
npm run db:migrate:prod
```

---

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
```
webapp/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.tsx              # Honoã‚¢ãƒ—ãƒªã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ routes/                # APIãƒ«ãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ projects.ts        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
â”‚   â”‚   â”œâ”€â”€ parsing.ts         # ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²
â”‚   â”‚   â”œâ”€â”€ transcriptions.ts  # éŸ³å£°æ–‡å­—èµ·ã“ã—
â”‚   â”‚   â”œâ”€â”€ formatting.ts      # ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ image-generation.ts # ç”»åƒç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ styles.ts          # ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆ
â”‚   â”‚   â”œâ”€â”€ downloads.ts       # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â”‚   â””â”€â”€ images.ts          # R2ç”»åƒé…ä¿¡
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ image-prompt-builder.ts  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆcomposeStyledPromptå«ã‚€ï¼‰
â”‚   â”‚   â”œâ”€â”€ rilarc-validator.ts      # RILARCScenarioV1ã‚¹ã‚­ãƒ¼ãƒãƒãƒªãƒ‡ãƒ¼ã‚¿
â”‚   â”‚   â””â”€â”€ style-prompt-composer.ts # ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆæˆ
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ bindings.ts        # Cloudflare Bindingså‹å®šç¾©
â”œâ”€â”€ public/
â”‚   â””â”€â”€ static/
â”‚       â”œâ”€â”€ app.js             # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
â”‚       â”œâ”€â”€ project-editor.js  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¨ãƒ‡ã‚£ã‚¿UI
â”‚       â””â”€â”€ styles.css         # TailwindCSSã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿
â”œâ”€â”€ migrations/                # D1ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ 0001_initial_schema.sql
â”‚   â”œâ”€â”€ 0002_add_source_type.sql
â”‚   â”œâ”€â”€ 0003_add_error_tracking.sql
â”‚   â”œâ”€â”€ 0004_add_text_chunks.sql
â”‚   â”œâ”€â”€ 0005_format_chunked_processing.sql
â”‚   â”œâ”€â”€ 0006_extend_error_message.sql
â”‚   â”œâ”€â”€ 0007_add_runs_system.sql
â”‚   â””â”€â”€ 0008_add_style_presets.sql
â”œâ”€â”€ docs/                      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ 00_INDEX.md
â”‚   â”œâ”€â”€ 04_DB_SCHEMA.md
â”‚   â”œâ”€â”€ 05_API_SPEC.md
â”‚   â””â”€â”€ ...
â”œâ”€â”€ wrangler.jsonc             # Cloudflareè¨­å®š
â”œâ”€â”€ package.json
â”œâ”€â”€ ecosystem.config.cjs       # PM2è¨­å®š
â””â”€â”€ README.md                  # æœ¬ãƒ•ã‚¡ã‚¤ãƒ«
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ç”»åƒç”ŸæˆãŒé€”ä¸­ã§æ­¢ã¾ã‚‹
**åŸå› **: UIã®ãƒãƒ¼ãƒªãƒ³ã‚°ãŒæ­¢ã¾ã£ã¦ã„ã‚‹ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„
**å¯¾å‡¦**:
1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆ`Ctrl+Shift+R` ã¾ãŸã¯ `Cmd+Shift+R`ï¼‰
2. æ‰‹å‹•ã§ãƒãƒƒãƒç”ŸæˆAPIã‚’å‘¼ã³å‡ºã™:
   ```bash
   curl -X POST https://your-app.pages.dev/api/projects/:id/generate-images
   ```

### Parse APIã‚¹ã‚­ãƒƒãƒ—ã«ã‚ˆã‚‹INVALID_STATUSã‚¨ãƒ©ãƒ¼
**åŸå› **: ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Parse API ãŒå‘¼ã°ã‚Œã¦ã„ãªã„
**å¯¾å‡¦**: UIã§ã€Œã‚·ãƒ¼ãƒ³åˆ†å‰²ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã« Parse â†’ Format ãŒå®Ÿè¡Œã•ã‚Œã¾ã™

### ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„
**åŸå› **: API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚­ãƒ¼ã®ä¸ä¸€è‡´ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
**ç¢ºèª**: `GET /api/style-presets` ãŒ `{style_presets: [...]}` ã‚’è¿”ã™ã“ã¨

---

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **Hono**: è»½é‡Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **Cloudflare Pages Functions**: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹å®Ÿè¡Œç’°å¢ƒ
- **Cloudflare D1**: SQLiteãƒ™ãƒ¼ã‚¹ã®ã‚¨ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **Cloudflare R2**: S3äº’æ›ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **Vanilla JavaScript**: ã‚·ãƒ³ãƒ—ãƒ«ãªDOMæ“ä½œ
- **TailwindCSS**: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆCSS
- **Axios**: HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- **FontAwesome**: ã‚¢ã‚¤ã‚³ãƒ³

### å¤–éƒ¨API
- **OpenAI GPT-4o**: ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ
- **OpenAI Whisper**: éŸ³å£°æ–‡å­—èµ·ã“ã—
- **Google Gemini**: ç”»åƒç”Ÿæˆã€Chat Editä¼šè©±AI

---

## Chat Editæ©Ÿèƒ½ï¼ˆå‹•ç”»èª¿æ•´AIï¼‰

### æ¦‚è¦
å®Œæˆã—ãŸå‹•ç”»ã«å¯¾ã—ã¦ã€è‡ªç„¶è¨€èªã§èª¿æ•´æŒ‡ç¤ºã‚’å‡ºã›ã‚‹AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã€‚ChatGPTã®ã‚ˆã†ãªä¼šè©±ä½“é¨“ã§å‹•ç”»ç·¨é›†ãŒã§ãã¾ã™ã€‚

### å¯¾å¿œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§

| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | èª¬æ˜ | ä¾‹æ–‡ |
|-----------|------|------|
| `bgm.set_volume` | BGMéŸ³é‡èª¿æ•´ | ã€ŒBGMã‚’å°‘ã—ä¸‹ã’ã¦ã€ |
| `bgm.set_loop` | BGMãƒ«ãƒ¼ãƒ—è¨­å®š | ã€ŒBGMã‚’ãƒ«ãƒ¼ãƒ—OFFã€ |
| `sfx.set_volume` | SEéŸ³é‡èª¿æ•´ | ã€ŒSEã‚’å¤§ããã€ |
| `sfx.add_from_library` | SEè¿½åŠ  | ã€Œé©šãã®SEã‚’è¿½åŠ ã—ã¦ã€ |
| `sfx.remove` | SEå‰Šé™¤ | ã€Œã‚·ãƒ¼ãƒ³2ã®SEã‚’æ¶ˆã—ã¦ã€ |
| `balloon.adjust_window` | å¹ãå‡ºã—è¡¨ç¤ºæ™‚é–“ | ã€Œå¹ãå‡ºã—ã‚’ã‚‚ã†å°‘ã—é•·ãã€ |
| `balloon.adjust_position` | å¹ãå‡ºã—ä½ç½® | ã€Œå¹ãå‡ºã—ã‚’ä¸Šã«ç§»å‹•ã€ |
| `balloon.set_policy` | å¹ãå‡ºã—è¡¨ç¤ºãƒ«ãƒ¼ãƒ« | ã€Œå¸¸ã«è¡¨ç¤ºã€ã€Œå–‹ã‚‹æ™‚ã ã‘ã€ |
| `telop.set_enabled` | ãƒ†ãƒ­ãƒƒãƒ—å…¨ä½“ON/OFF | ã€Œãƒ†ãƒ­ãƒƒãƒ—ã‚’æ¶ˆã—ã¦ã€ |
| `telop.set_enabled_scene` | ã‚·ãƒ¼ãƒ³å˜ä½ãƒ†ãƒ­ãƒƒãƒ—ON/OFF | ã€Œã‚·ãƒ¼ãƒ³1ã®ãƒ†ãƒ­ãƒƒãƒ—ã‚’OFFã€ |
| `telop.set_position` | ãƒ†ãƒ­ãƒƒãƒ—ä½ç½® | ã€Œãƒ†ãƒ­ãƒƒãƒ—ã‚’ä¸Šã«ã€ |
| `telop.set_size` | ãƒ†ãƒ­ãƒƒãƒ—ã‚µã‚¤ã‚º | ã€Œãƒ†ãƒ­ãƒƒãƒ—ã‚’å¤§ããã€ |

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
POST /api/projects/:projectId/chat-edits/chat
Body: {
  "user_message": "BGMãŒã†ã‚‹ã•ã„ã‹ã‚‚",
  "context": {
    "scene_idx": 1,
    "balloon_no": 1,
    "video_build_id": 123
  },
  "history": [
    {"role": "user", "content": "ã‚ˆã‚ã—ãã­"},
    {"role": "assistant", "content": "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼..."}
  ]
}

Response: {
  "ok": true,
  "assistant_message": "BGMãŒæ°—ã«ãªã‚Šã¾ã™ã­ã€‚éŸ³é‡ã‚’ä¸‹ã’ã¾ã—ã‚‡ã†ã‹ï¼Ÿ",
  "suggestion": {
    "needs_confirmation": true,
    "summary": "Before: BGMéŸ³é‡ 100%\nAfter: BGMéŸ³é‡ 50%",
    "intent": {
      "schema": "rilarc_intent_v1",
      "actions": [{"action": "bgm.set_volume", "volume": 0.5}]
    },
    "rejected_actions": []
  }
}
```

### ãƒ•ãƒ­ãƒ¼
1. **ä¼šè©±**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› â†’ AIä¼šè©±ï¼ˆassistant_messageï¼‰
2. **ææ¡ˆ**: ç·¨é›†ææ¡ˆãŒã‚ã‚Œã°ææ¡ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆsuggestionï¼‰
3. **ç¢ºèª**: ã€Œç¢ºèªã™ã‚‹ã€â†’ dry-runï¼ˆå¤‰æ›´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
4. **é©ç”¨**: ã€Œã“ã®å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹ã€â†’ applyï¼ˆæ–°ãƒ“ãƒ«ãƒ‰ç”Ÿæˆï¼‰

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
UIã«ã¯ã‚ˆãä½¿ã†æ“ä½œã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚ã‚Šã¾ã™ï¼š
- BGM: å°ã•ã / å¤§ãã / ãƒ«ãƒ¼ãƒ—ON/OFF
- ãƒ†ãƒ­ãƒƒãƒ—: å…¨éƒ¨OFF / å…¨éƒ¨ON / ã“ã®ã‚·ãƒ¼ãƒ³OFF / ã“ã®ã‚·ãƒ¼ãƒ³ON / ä½ç½®å¤‰æ›´ / ã‚µã‚¤ã‚ºå¤‰æ›´

---

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

è©³ç´°ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ `docs/` ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

- **00_INDEX.md**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç´¢å¼•
- **04_DB_SCHEMA.md**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®Œå…¨ç‰ˆ
- **05_API_SPEC.md**: APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜
- **09_AI_DEV_RULES.md**: AIé–‹ç™ºè€…å‘ã‘ãƒ«ãƒ¼ãƒ«
- **BUTTON_PROGRESS_FIX.md**: ç”»åƒç”Ÿæˆãƒœã‚¿ãƒ³ã¨é€²æ—è¡¨ç¤ºã®å®Œå…¨ä¿®æ­£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ â­ é‡è¦

---

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹
Proprietary - All rights reserved

---

æœ€çµ‚æ›´æ–°: 2026-01-26

---

## ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆï¼ˆå‹•ç”»ç”Ÿæˆé–¢é€£ï¼‰

æœ¬ãƒªãƒã‚¸ãƒˆãƒªã«ã¯ã€ãƒ¡ã‚¤ãƒ³ã®Cloudflare Pagesã‚¢ãƒ—ãƒªã«åŠ ãˆã¦ã€å‹•ç”»ç”Ÿæˆã«å¿…è¦ãªã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloudflare                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ webapp           â”‚  â”‚ webapp-cron      â”‚                     â”‚
â”‚  â”‚ (Pages + D1 + R2)â”‚  â”‚ (Workers Cron)   â”‚                     â”‚
â”‚  â”‚                  â”‚  â”‚ æ¯æ—¥UTC19:00     â”‚                     â”‚
â”‚  â”‚ POST /video/buildâ”‚  â”‚ å‹•ç”»30æ—¥è‡ªå‹•å‰Šé™¤ â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTPS + SigV4
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AWS (ap-northeast-1)                                            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ API Gateway      â”‚â”€â”€â”€â–¶â”‚ aws-orchestrator (Lambda)        â”‚   â”‚
â”‚  â”‚ POST /video/buildâ”‚    â”‚ rilarc-video-build-orch          â”‚   â”‚
â”‚  â”‚     /start       â”‚    â”‚ Remotion Lambda ã‚’å‘¼ã³å‡ºã—        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                           â”‚                      â”‚
â”‚                                           â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Remotion Lambda (remotion-render-4-0-404-mem2048mb...)   â”‚   â”‚
â”‚  â”‚ ãƒ»video-build-remotion ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒ³ãƒ‰ãƒ«                  â”‚   â”‚
â”‚  â”‚ ãƒ»S3ã«ã‚µã‚¤ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿                                   â”‚   â”‚
â”‚  â”‚ ãƒ»å‹•ç”»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                           â”‚                      â”‚
â”‚                                           â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ S3 Buckets                                                â”‚   â”‚
â”‚  â”‚ ãƒ»remotionlambda-apnortheast1-xxx (Remotionå†…éƒ¨)          â”‚   â”‚
â”‚  â”‚ ãƒ»rilarc-remotion-renders-prod-202601 (å‡ºåŠ›å‹•ç”»)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ API Gateway      â”‚â”€â”€â”€â–¶â”‚ aws-video-proxy (Lambda)         â”‚   â”‚
â”‚  â”‚ POST /video      â”‚    â”‚ rilarc-video-proxy               â”‚   â”‚
â”‚  â”‚     /generate    â”‚    â”‚ Google Veo APIãƒ—ãƒ­ã‚­ã‚·            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§

| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ | ç”¨é€” | æœ¬ç•ªé–¢æ•°å/URL |
|-------------|-----------|------|---------------|
| `video-build-remotion/` | AWS Lambda (Remotion) | å‹•ç”»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ | S3ã‚µã‚¤ãƒˆ: rilarc-video-build |
| `aws-orchestrator/` | AWS Lambda | Remotionå‘¼ã³å‡ºã—ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ | rilarc-video-build-orch |
| `aws-orchestrator-b2/` | AWS Lambda (äºˆå‚™) | Remotion Lambda SDKç‰ˆ | - |
| `aws-video-proxy/` | AWS Lambda | Google Veo APIãƒ—ãƒ­ã‚­ã‚· | rilarc-video-proxy |
| `webapp-cron/` | Cloudflare Workers | å®šæœŸã‚¸ãƒ§ãƒ–ï¼ˆå‹•ç”»å‰Šé™¤ç­‰ï¼‰ | webapp-cron |

### ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

#### 1. video-build-remotionï¼ˆRemotion Lambdaï¼‰

```bash
cd video-build-remotion
npm install
npm run deploy  # Remotion ã‚µã‚¤ãƒˆ + Lambda ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
```

ç’°å¢ƒå¤‰æ•°:
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `AWS_REGION` (default: ap-northeast-1)

#### 2. aws-orchestratorï¼ˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ Lambdaï¼‰

```bash
cd aws-orchestrator
npm install
zip -r function.zip index.mjs node_modules
aws lambda update-function-code \
  --function-name rilarc-video-build-orch \
  --zip-file fileb://function.zip \
  --region ap-northeast-1
```

#### 3. aws-video-proxyï¼ˆVeoãƒ—ãƒ­ã‚­ã‚· Lambdaï¼‰

```bash
cd aws-video-proxy
npm install
npm run build
npm run package
npm run deploy
```

#### 4. webapp-cronï¼ˆCloudflare Workers Cronï¼‰

```bash
cd webapp-cron
npm install
npx wrangler deploy
```

### ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ

#### AWS Lambdaå…±é€š
- `AWS_REGION`: ap-northeast-1
- `REMOTION_FUNCTION_NAME`: remotion-render-4-0-404-mem2048mb-disk2048mb-240sec
- `REMOTION_SERVE_URL`: S3ã‚µã‚¤ãƒˆURL
- `OUTPUT_BUCKET`: rilarc-remotion-renders-prod-202601

#### aws-video-proxy
- `GOOGLE_API_KEY`: Google Veo API ã‚­ãƒ¼

#### webapp-cron
- D1ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: webapp-production (51860cd3-bfa8-4eab-8a11-aa230adee686)
- R2ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: webapp-bucket

---

## Video Build æ©Ÿèƒ½ï¼ˆæœ€æ–°ï¼‰

### æ¦‚è¦
å…¨ã‚·ãƒ¼ãƒ³ã®ç´ æï¼ˆç”»åƒ/æ¼«ç”»/å‹•ç”»ï¼‹éŸ³å£°ï¼‰ã‚’åˆç®—ã—ã¦ã€1æœ¬ã®å‹•ç”»ï¼ˆMP4ï¼‰ã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ã€‚

### SSOTå®šç¾©
- **è¡¨ç¤ºç´ æ**: `scenes.display_asset_type` ('image' | 'comic' | 'video') ã«åŸºã¥ã„ã¦ SSOT ã‚’åˆ‡ã‚Šæ›¿ãˆ
  - image â†’ `image_generations` (is_active=1, asset_type='ai' OR NULL)
  - comic â†’ `image_generations` (is_active=1, asset_type='comic')
  - video â†’ `video_generations` (is_active=1, status='completed')
- **éŸ³å£°**: `audio_generations` (is_active=1, status='completed')
- **å°ºè¨ˆç®—**: éŸ³å£°å°º + 500ms ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆéŸ³å£°ãªã—: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3000msï¼‰

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `GET /api/video-builds/usage` - åˆ©ç”¨çŠ¶æ³ï¼ˆæœˆé–“/åŒæ™‚ï¼‰
- `GET /api/projects/:id/video-builds/preflight` - Preflightæ¤œè¨¼
- `GET /api/projects/:id/video-builds` - ãƒ“ãƒ«ãƒ‰ä¸€è¦§
- `POST /api/projects/:id/video-builds` - ãƒ“ãƒ«ãƒ‰é–‹å§‹
- `POST /api/video-builds/:id/refresh` - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°

### è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `docs/VIDEO_BUILD_SSOT.md` - SSOT & ä¾å­˜é–¢ä¿‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

---

## Phase1.7 æ¼«ç”»æ©Ÿèƒ½

### ä¸»è¦æ©Ÿèƒ½
- **æ¼«ç”»ã‚¨ãƒ‡ã‚£ã‚¿**: 6ç¨®é¡ã®å¹ãå‡ºã—ï¼ˆspeech_round, speech_oval, thought_oval, telop_bar, caption, whisperï¼‰
- **æ¡ç”¨åˆ‡æ›¿**: ã‚·ãƒ¼ãƒ³ã‚«ãƒ¼ãƒ‰ã§ã€Œç”»åƒã‚’æ¡ç”¨ã€ã€Œæ¼«ç”»ã‚’æ¡ç”¨ã€ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ‡æ›¿
- **ç™ºè©±ã”ã¨ã®éŸ³å£°**: æ¼«ç”»ãƒ¢ãƒ¼ãƒ‰ã§ã¯æœ€å¤§3ç™ºè©±ã€ãã‚Œãã‚Œã«éŸ³å£°è¨­å®š
- **display_image SSOT**: API/UI/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§æ¡ç”¨ç´ æã‚’çµ±ä¸€

### SSOTè¨­è¨ˆ
- `scenes.display_asset_type`: 'image' | 'comic'ï¼ˆå°†æ¥çš„ã« 'video' ã‚‚è¿½åŠ äºˆå®šï¼‰
- `scenes.comic_data`: { draft: {...}, published: {...} }
- `image_generations.asset_type`: 'ai' | 'comic'

### è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `docs/PHASE17_IMPLEMENTATION_STATUS.md` - å®Ÿè£…çŠ¶æ³
- `docs/PHASE17_NEXT_STEPS_ANALYSIS.md` - æ¬¡ã‚¹ãƒ†ãƒƒãƒ—åˆ†æ

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é‹ç”¨æ‰‹é †ï¼ˆPhase X-2ï¼‰

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç•ªå·è¡çªã®å±¥æ­´ï¼ˆé‹ç”¨äº‹æ•…é˜²æ­¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰

#### èƒŒæ™¯

2026-01-01ã«Phase X-2å®Ÿè£…ä¸­ã€`0007_world_character_bible.sql` ãŒæ—¢å­˜ã® `0007_add_runs_system.sql` ã¨ç•ªå·è¡çªã—ã¾ã—ãŸã€‚

#### è§£æ±ºæ–¹é‡ï¼šNO-OPæ–¹å¼

æ—¢ã«GitHubã«pushæ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã¨ç’°å¢ƒé–“ã§é©ç”¨å±¥æ­´ãŒå‰²ã‚Œã‚‹ãŸã‚ã€ä»¥ä¸‹ã®æ–¹é‡ã‚’æ¡ç”¨ï¼š

1. **`0007_world_character_bible.sql`**: NO-OPåŒ–ï¼ˆ`SELECT 1 WHERE 1=0;` ã®ã¿ï¼‰
   - Gitå±¥æ­´ã‚’ä¿å…¨
   - é©ç”¨æ¸ˆã¿ç’°å¢ƒã§ã‚‚ç„¡å®³
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã§è² å‚µåŒ–ã‚’é˜²æ­¢

2. **`0010_world_character_bible.sql`**: å®Ÿéš›ã®ã‚¹ã‚­ãƒ¼ãƒé©ç”¨
   - `world_settings`
   - `project_character_models`
   - `scene_character_map`
   - å…¨ã¦ `IF NOT EXISTS` ä»˜ãï¼ˆç’°å¢ƒå·®ã§è½ã¡ãªã„ï¼‰

3. **`0011_add_character_aliases.sql`**: `aliases_json` ã‚«ãƒ©ãƒ è¿½åŠ 

#### å¾©æ—§æ‰‹é †

**æ—¢ã« `0007_world_character_bible.sql` ã‚’é©ç”¨ã—ãŸç’°å¢ƒã®å ´åˆ**:

```bash
# 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
npx wrangler d1 migrations list webapp-production --local

# 2. 0010ã‚’é©ç”¨ï¼ˆIF NOT EXISTS ãªã®ã§å®‰å…¨ï¼‰
npx wrangler d1 migrations apply webapp-production --local

# 3. ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
npx wrangler d1 execute webapp-production --local --command="
SELECT name FROM sqlite_master 
WHERE type='table' 
AND name IN ('world_settings', 'project_character_models', 'scene_character_map');
"
```

**ã‚¯ãƒªãƒ¼ãƒ³ç’°å¢ƒã®å ´åˆ**:

```bash
# é€šå¸¸é€šã‚Šé©ç”¨ï¼ˆ0007ã¯NO-OPã€0010ãŒå®Ÿéš›ã®é©ç”¨ï¼‰
npx wrangler d1 migrations apply webapp-production --local
```

#### æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨

```bash
# æœ¬ç•ªDBç¢ºèªï¼ˆæ³¨æ„ï¼šæœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ï¼‰
npx wrangler d1 migrations list webapp-production --remote

# æœ¬ç•ªé©ç”¨ï¼ˆå¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾Œã«å®Ÿè¡Œï¼‰
npx wrangler d1 migrations apply webapp-production --remote
```

#### ãªãœã“ã®æ–¹é‡ã‹

- **Gitå±¥æ­´ã®æ•´åˆæ€§ç¶­æŒ**: ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã¯ç’°å¢ƒé–“ã®ä¸æ•´åˆã‚’ç”Ÿã‚€
- **ã¹ãç­‰æ€§**: `IF NOT EXISTS` ã«ã‚ˆã‚Šä½•åº¦å®Ÿè¡Œã—ã¦ã‚‚å®‰å…¨
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–**: æ„å›³çš„ãªè¨­è¨ˆã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º

---

## 2026-01-20 è¿½åŠ æ©Ÿèƒ½

### speech_typeï¼ˆã‚»ãƒªãƒ•/ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤å®šï¼‰
- **DB**: `scenes.speech_type` ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆ'dialogue' | 'narration'ï¼‰
- **AIåˆ¤å®š**: ã‚·ãƒ¼ãƒ³åˆ†å‰²æ™‚ã«AIãŒè‡ªå‹•åˆ†é¡
  - dialogue: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç™ºè¨€ï¼ˆã€Œã€å†…ã®å°è©ï¼‰
  - narration: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€èª¬æ˜ã€çŠ¶æ³æå†™
- **API**: ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒ³å–å¾—APIã§ `speech_type` ã‚’è¿”å´
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: `0019_add_scene_speech_type.sql`

### reset-to-input å®‰å…¨åŒ–
- **ãƒ–ãƒ­ãƒƒã‚¯æ¡ä»¶è¿½åŠ **:
  - Video Buildï¼ˆæœ€çµ‚å‹•ç”»ï¼‰ãŒå­˜åœ¨ â†’ ãƒªã‚»ãƒƒãƒˆä¸å¯
  - æ¼«ç”»åŒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ â†’ ãƒªã‚»ãƒƒãƒˆä¸å¯
  - ã‚·ãƒ¼ãƒ³å‹•ç”»ãŒå­˜åœ¨ â†’ ãƒªã‚»ãƒƒãƒˆä¸å¯
- **ãƒœã‚¿ãƒ³éæ´»æ€§åŒ–**: ä¸Šè¨˜æ¡ä»¶ã§ãƒœã‚¿ãƒ³ãŒã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ + ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³
- **R2ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: ãƒªã‚»ãƒƒãƒˆæ™‚ã«ç”»åƒ/éŸ³å£°/å‹•ç”»ã®R2ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
- **è­¦å‘Šãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¼·åŒ–**: å‰Šé™¤ä»¶æ•°æ˜ç¤º + ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¿…é ˆ

### ElevenLabséŸ³å£°æœ‰åŠ¹åŒ–
- **voice-presets.json**: ElevenLabs 8ãƒœã‚¤ã‚¹ã‚’ `status: 'active'` ã«å¤‰æ›´
- **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šUI**: Voice Presetãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã€ŒGoogle TTSã€ã€ŒElevenLabs (Premium)ã€ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤º

### ãã®ä»–ä¿®æ­£
- ã‚·ãƒ¼ãƒ³åˆ†å‰²ã€Œã‚„ã‚Šç›´ã™ã€ãƒœã‚¿ãƒ³é‡è¤‡å‰Šé™¤ï¼ˆå°ãƒœã‚¿ãƒ³ã®ã¿æ®‹ã™ï¼‰
- ã‚·ãƒ¼ãƒ³ã‚«ãƒ†ã‚´ãƒªæ—¥æœ¬èªåŒ–ï¼ˆHookâ†’å°å…¥ãƒ»ã¤ã‹ã¿ ç­‰ï¼‰
- S3ç½²åä»˜ãURLæœŸé™åˆ‡ã‚Œãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- éŸ³å£°å†ç”Ÿæˆé€£æ‰“é˜²æ­¢ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰
- Google Fontsè¿½åŠ ãƒ­ãƒ¼ãƒ‰ï¼ˆæ‰‹æ›¸ããƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œï¼‰

### Phase X-4/X-5: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç‰¹å¾´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### æ¦‚è¦
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä¸€è²«ã—ãŸæå†™ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã€ç‰©èªå…¨ä½“ã®å…±é€šç‰¹å¾´ã¨ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ç®¡ç†ã€‚

#### å„ªå…ˆé †ä½ï¼ˆç”»åƒç”Ÿæˆæ™‚ï¼‰
1. **å‚ç…§ç”»åƒ** - å¸¸ã«ä½¿ç”¨ï¼ˆè¦–è¦šçš„ä¸€è²«æ€§ç¶­æŒï¼‰
2. **ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰** - ã‚ã‚Œã°æœ€å„ªå…ˆ
3. **å…±é€šç‰¹å¾´ï¼ˆstory_traitsï¼‰** - ç‰©èªå…¨ä½“ã§é©ç”¨
4. **appearance_description** - æ‰‹å‹•è¨­å®šã®å¤–è¦‹èª¬æ˜
5. **æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆæŒ‡ç¤º** - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¿½åŠ ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```
project_character_models
â”œâ”€â”€ character_key, character_name
â”œâ”€â”€ appearance_description (æ‰‹å‹•è¨­å®š)
â”œâ”€â”€ story_traits (ç‰©èªå…¨ä½“ã®ç‰¹å¾´)
â””â”€â”€ reference_image_r2_url (å‚ç…§ç”»åƒ)

scene_character_traits
â”œâ”€â”€ scene_id, character_key
â”œâ”€â”€ override_type ('transform' ãªã©)
â””â”€â”€ trait_description (ã‚·ãƒ¼ãƒ³åˆ¥ç‰¹å¾´)

scenes
â””â”€â”€ is_prompt_customized (0/1) - ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ãƒ©ã‚°
```

#### æ©Ÿèƒ½
1. **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç‰¹å¾´ã‚µãƒãƒªãƒ¼è¡¨ç¤º**: ã‚·ãƒ¼ãƒ³åˆ†å‰²ç”»é¢ã§å…¨ã‚­ãƒ£ãƒ©ã®å…±é€šç‰¹å¾´ã¨ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ä¸€è¦§è¡¨ç¤º
2. **ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰è¿½åŠ **: å„ã‚·ãƒ¼ãƒ³ã§ã€Œã‚·ãƒ¼ãƒ³åˆ¥ç‰¹å¾´ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šå¯èƒ½
3. **ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¯¾å¿œ**: Builderã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†æ™‚ã¯æ—¥æœ¬èªæŒ‡ç¤ºãƒ»è‡ªå‹•ç‰¹å¾´è¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—
4. **è‡ªå‹•ç‰¹å¾´æŠ½å‡º**: ã‚·ãƒ¼ãƒ³åˆ†å‰²æ™‚ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç‰¹å¾´ã‚’è‡ªå‹•æŠ½å‡º

#### ä½¿ç”¨ä¾‹
```
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ãƒ™ãƒ«
å…±é€šç‰¹å¾´: å°ã•ãªå¦–ç²¾ã€ã‚­ãƒ©ã‚­ãƒ©ã¨å…‰ã‚‹ç¾½ã€é’ã„ãƒ‰ãƒ¬ã‚¹
ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰:
  #10: äººé–“ã®å§¿ã«å¤‰èº«ã€‚å¦–ç²¾ã®ç¾½ã¯æ¶ˆãˆã€æ™®é€šã®å°‘å¥³ã®å§¿
```

#### API
- `GET /api/projects/:id/character-traits-summary` - ç‰¹å¾´ã‚µãƒãƒªãƒ¼å–å¾—
- `PUT /api/projects/:id/characters/:key/story-traits` - å…±é€šç‰¹å¾´æ›´æ–°
- `GET /api/scenes/:id/character-traits` - ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å–å¾—
- `POST /api/scenes/:id/character-traits` - ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰è¿½åŠ 
- `DELETE /api/scenes/:id/character-traits/:key` - ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å‰Šé™¤

---

## 2026-01-21 R1.5 è¿½åŠ æ©Ÿèƒ½

### è¤‡æ•°è©±è€…éŸ³å£°ï¼ˆscene_utterances SSOTï¼‰

#### æ¦‚è¦
ã‚·ãƒ¼ãƒ³å†…ã®ç™ºè©±ã‚’ã€Œèª°ãŒã€ã€Œä½•ã‚’ã€ã€Œã©ã®é †ç•ªã§ã€å–‹ã‚‹ã‹ã‚’ç®¡ç†ã™ã‚‹SSOTã‚·ã‚¹ãƒ†ãƒ ã€‚
éŸ³å£°ã¨ãƒ†ãƒ­ãƒƒãƒ—ã®ä¸¡æ–¹ã«ä½¿ç”¨ã•ã‚Œã‚‹å˜ä¸€æƒ…å ±æºã€‚

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
scene_utterances
â”œâ”€â”€ id (PK)
â”œâ”€â”€ scene_id (FK â†’ scenes.id)
â”œâ”€â”€ order_no (ã‚·ãƒ¼ãƒ³å†…ã®å†ç”Ÿé †)
â”œâ”€â”€ role ('narration' | 'dialogue')
â”œâ”€â”€ character_key (dialogueã®å ´åˆå¿…é ˆ)
â”œâ”€â”€ text (ç™ºè©±ãƒ†ã‚­ã‚¹ãƒˆ/å­—å¹•)
â”œâ”€â”€ audio_generation_id (FK â†’ audio_generations.id)
â”œâ”€â”€ duration_ms (éŸ³å£°é•·ã•ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
â””â”€â”€ created_at, updated_at
```

#### æ©Ÿèƒ½
1. **Lazy Migration**: ã‚·ãƒ¼ãƒ³ã®éŸ³å£°ã‚¿ãƒ–ã‚’é–‹ãã¨ã€æ—¢å­˜ã®`dialogue`ã‹ã‚‰è‡ªå‹•çš„ã«ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³utteranceã‚’1ä»¶ä½œæˆ
2. **è¤‡æ•°è©±è€…**: narrationï¼ˆãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰ã¨dialogueï¼ˆã‚­ãƒ£ãƒ©ã‚»ãƒªãƒ•ï¼‰ã‚’æ··åœ¨å¯èƒ½
3. **ç™ºè©±å˜ä½ã®éŸ³å£°ç”Ÿæˆ**: å„utteranceã«å€‹åˆ¥ã«éŸ³å£°ã‚’ç”Ÿæˆå¯èƒ½
4. **ä¸¦ã³æ›¿ãˆ**: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§order_noã‚’å¤‰æ›´å¯èƒ½

#### API
- `GET /api/scenes/:sceneId/utterances` - ç™ºè©±ä¸€è¦§å–å¾—ï¼ˆlazy migrateå«ã‚€ï¼‰
- `POST /api/scenes/:sceneId/utterances` - ç™ºè©±è¿½åŠ 
- `PUT /api/utterances/:id` - ç™ºè©±æ›´æ–°
- `DELETE /api/utterances/:id` - ç™ºè©±å‰Šé™¤
- `PUT /api/scenes/:sceneId/utterances/reorder` - ä¸¦ã³æ›¿ãˆ
- `POST /api/utterances/:id/generate-audio` - ç™ºè©±å˜ä½ã®éŸ³å£°ç”Ÿæˆ

#### UI
- **SceneEditModal**: ã€Œã‚­ãƒ£ãƒ©å‰²ã‚Šå½“ã¦ã€ã€ŒéŸ³å£°ã€ã€Œç‰¹å¾´å¤‰åŒ–ã€ã®3ã‚¿ãƒ–æ§‹æˆ
- **éŸ³å£°ã‚¿ãƒ–**: ç™ºè©±ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã€è¿½åŠ /ç·¨é›†/å‰Šé™¤/ä¸¦ã³æ›¿ãˆã€éŸ³å£°ç”Ÿæˆ/å†ç”Ÿ

#### SSOT ãƒ«ãƒ¼ãƒ«ï¼ˆå‹•ç”»ç”Ÿæˆæ™‚ï¼‰
1. `scene_utterances`ãŒå­˜åœ¨ â†’ `voices[]`ã¨ã—ã¦å‡ºåŠ›
2. `scene_utterances`ãªã— â†’ æ—¢å­˜ã®`active_audio`ã‚’fallbackã§narrationå¤‰æ›
3. `duration_ms` = Î£(voices[].duration_ms) + paddingï¼ˆéŸ³å£°ãªã—ã¯æ¨å®šå€¤ï¼‰

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `0022_create_scene_utterances.sql`

---

## 2026-01-25 Phase2 UIçµ±åˆ

### æ¦‚è¦
Builder UI ã‚’ã€Œãƒˆãƒƒãƒ—ã¯çµæœè¡¨ç¤ºã®ã¿ã€ç·¨é›†ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å®Œçµã€ã®åŸå‰‡ã«æ²¿ã£ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€‚äºŒé‡ãƒ¢ãƒ¼ãƒ€ãƒ«å•é¡Œã‚’æ ¹çµ¶ã€‚

### Phase1: Builder Scene Card å†æ§‹æˆ
- **ã‚»ãƒªãƒ•æ¦‚è¦**: å…¨æ–‡è¡¨ç¤º â†’ 120æ–‡å­—çœç•¥ï¼ˆå‚ç…§å°‚ç”¨ï¼‰
- **ç™ºè©±ã‚µãƒãƒªãƒ¼**: ä¸‹éƒ¨ â†’ ä¸Šéƒ¨ã«ç§»å‹•ã€ç·¨é›†ãƒœã‚¿ãƒ³å‰Šé™¤
- **æ˜ åƒã‚¿ã‚¤ãƒ—**: ç”»åƒ/æ¼«ç”»ã‚’æ˜ç¤ºè¡¨ç¤º
- **ã‚«ãƒ¼ãƒ‰å†…ç·¨é›†UI**: å…¨å‰Šé™¤ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã«é›†ç´„ï¼‰
- **è©³ç´°æƒ…å ±**: ã‚¹ã‚¿ã‚¤ãƒ«/ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ/è¦ç‚¹ã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤º

### Phase2-PR2a: æ¼«ç”»ç™ºè©±åˆ†å‰²è¡¨ç¤º
- **Before**: ç™ºè©±ã‚’çµåˆã—ã¦1è¡Œè¡¨ç¤º
- **After**: `ç™ºè©±1: ã€‡ã€‡ / ç™ºè©±2: â–³â–³` ã¨è¡Œåˆ¥è¡¨ç¤ºï¼ˆæœ€å¤§3è¡Œ + ã€Œä»–nä»¶ã€ï¼‰

### Phase2-PR2b: éŸ³å£°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼(1äºº) å‰Šé™¤
- ã‚­ãƒ£ãƒ©å‰²å½“ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã€ŒéŸ³å£°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆ1äººï¼‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
- éŸ³å£°è¨­å®šã¯SceneEditModal ã®ã€ŒéŸ³å£°ã‚¿ãƒ–ã€ã«çµ±ä¸€

### Phase2-PR2c: äºŒé‡ãƒ¢ãƒ¼ãƒ€ãƒ«æ ¹çµ¶
- **Before**: ç™ºè©±ç·¨é›†ã§åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒ `document.body` ã«è¿½åŠ ã•ã‚Œã‚‹å•é¡Œ
  - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãŒåŠ¹ã‹ãªã„
  - é€£æ‰“ã§è¤‡æ•°ãƒ¢ãƒ¼ãƒ€ãƒ«ç”Ÿæˆ
- **After**: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ã«å¤‰æ›´
  - ç™ºè©±ã‚«ãƒ¼ãƒ‰å†…ã§ãƒ•ã‚©ãƒ¼ãƒ ã«å¤‰åŒ–
  - åŒã˜DOMå†…ã§å®Œçµ
  - çŠ¶æ…‹ã‚¬ãƒ¼ãƒ‰ã§é€£æ‰“é˜²æ­¢

### å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
- `public/static/project-editor.js`: renderSceneTextContent, renderDialogueSummaryç­‰
- `public/static/world-character-modal.js`: openAssign ã‹ã‚‰éŸ³å£°ã‚­ãƒ£ãƒ©å‰Šé™¤
- `public/static/utterances-tab.js`: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†å®Ÿè£…

---

## 2026-01-23 R3-A è¿½åŠ æ©Ÿèƒ½

### é€šã—BGMï¼ˆproject_audio_tracksï¼‰

#### æ¦‚è¦
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’é€šã—ã¦æµã‚Œã‚‹BGMã‚’ç®¡ç†ã€‚ãƒ€ãƒƒã‚­ãƒ³ã‚°ï¼ˆéŸ³å£°å†ç”Ÿæ™‚ã«BGMéŸ³é‡ã‚’è‡ªå‹•èª¿æ•´ï¼‰å¯¾å¿œã€‚

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
project_audio_tracks
â”œâ”€â”€ id (PK)
â”œâ”€â”€ project_id (FK â†’ projects.id)
â”œâ”€â”€ track_type ('bgm')
â”œâ”€â”€ r2_key, r2_url (R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)
â”œâ”€â”€ duration_ms
â”œâ”€â”€ volume (0.0-1.0, default: 0.25)
â”œâ”€â”€ loop (boolean, default: true)
â”œâ”€â”€ fade_in_ms, fade_out_ms (default: 800ms)
â”œâ”€â”€ ducking_enabled (default: false)
â”œâ”€â”€ ducking_volume (0.0-1.0, default: 0.12)
â”œâ”€â”€ ducking_attack_ms, ducking_release_ms
â”œâ”€â”€ is_active
â””â”€â”€ created_at, updated_at
```

#### API
- `GET /api/projects/:projectId/audio-tracks` - BGMãƒˆãƒ©ãƒƒã‚¯ä¸€è¦§
- `POST /api/projects/:projectId/audio-tracks/bgm/upload` - BGMã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- `PUT /api/projects/:projectId/audio-tracks/:id` - BGMè¨­å®šæ›´æ–°
- `DELETE /api/projects/:projectId/audio-tracks/:id` - BGMå‰Šé™¤

#### Remotionçµ±åˆ
`buildProjectJson`å‡ºåŠ›:
```json
{
  "assets": {
    "bgm": {
      "url": "https://.../bgm.mp3",
      "volume": 0.25,
      "loop": true,
      "fade_in_ms": 800,
      "fade_out_ms": 800,
      "ducking": {
        "enabled": true,
        "volume": 0.12,
        "attack_ms": 120,
        "release_ms": 220
      }
    }
  }
}
```

### ç„¡éŸ³ã‚·ãƒ¼ãƒ³ã®å°ºè¨­å®šï¼ˆduration_override_msï¼‰

#### æ¦‚è¦
ã‚»ãƒªãƒ•ã‚„éŸ³å£°ãŒãªã„ã‚·ãƒ¼ãƒ³ï¼ˆé¢¨æ™¯ã€æˆ¦é—˜ã€é–“ã®ã‚·ãƒ¼ãƒ³ç­‰ï¼‰ã®å°ºã‚’æ‰‹å‹•è¨­å®šå¯èƒ½ã«ã€‚

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
scenes
â””â”€â”€ duration_override_ms (INTEGER, NULL=è‡ªå‹•è¨ˆç®—)
```

#### å°ºè¨ˆç®—ã®å„ªå…ˆé †ä½ï¼ˆcomputeSceneDurationMsï¼‰
1. **video mode**: videoç´ æã®`duration_sec Ã— 1000`
2. **utteranceséŸ³å£°åˆè¨ˆ**: Î£(utterances[].duration_ms) + padding
3. **duration_override_ms**: æ‰‹å‹•è¨­å®šå€¤ï¼ˆ1-60ç§’ï¼‰
4. **dialogueæ¨å®š**: æ–‡å­—æ•° Ã— 300msï¼ˆæœ€å°2ç§’ï¼‰
5. **DEFAULT**: 5000ms

#### API
- `PUT /api/scenes/:id` - `duration_override_ms`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ ï¼ˆ1000-60000msï¼‰

### Preflight 2å±¤æ¤œè¨¼

#### æ¦‚è¦
preflightåˆ¤å®šã‚’ã€Œå¿…é ˆæ¡ä»¶ã€ã¨ã€Œæ¨å¥¨/è­¦å‘Šã€ã®2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åˆ†é›¢ã€‚

#### ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆå¿…é ˆ - can_generate ã«å½±éŸ¿ï¼‰
- ç´ æãŒå…¨ã‚·ãƒ¼ãƒ³ã«å­˜åœ¨ã™ã‚‹ã“ã¨

#### ãƒ¬ã‚¤ãƒ¤ãƒ¼2ï¼ˆè­¦å‘Š - utterance_errorsï¼‰
- utterancesãŒæœªç™»éŒ²ï¼ˆã€Œã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã™ãŒéŸ³å£°ãƒ‘ãƒ¼ãƒ„ãŒæœªç™»éŒ²ã§ã™ã€ï¼‰
- éŸ³å£°ãŒæœªç”Ÿæˆ

#### å‹•ä½œ
- **is_ready: true** â†’ ç´ æOK
- **can_generate: true** â†’ ç”Ÿæˆå¯èƒ½ï¼ˆutteranceè­¦å‘ŠãŒã‚ã£ã¦ã‚‚æ­¢ã‚ãªã„ï¼‰
- **utterance_errors** â†’ è­¦å‘Šã¨ã—ã¦è¡¨ç¤ºã€ç”Ÿæˆã¯è¨±å¯

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `0028_add_scene_duration_override_ms.sql`
- `0029_create_project_audio_tracks.sql`

---

## 2026-01-23 R3-B/R4 è¿½åŠ æ©Ÿèƒ½

### R3-B: ã‚·ãƒ¼ãƒ³åˆ¥SFXï¼ˆscene_audio_cuesï¼‰

#### æ¦‚è¦
ã‚·ãƒ¼ãƒ³ã«åŠ¹æœéŸ³ï¼ˆSFXï¼‰ã‚’è¿½åŠ ã™ã‚‹SSOTã‚·ã‚¹ãƒ†ãƒ ã€‚BGMã¨ä¸¦è¡Œã—ã¦ã€ã‚·ãƒ¼ãƒ³å›ºæœ‰ã®éŸ³éŸ¿æ¼”å‡ºãŒå¯èƒ½ã€‚

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
scene_audio_cues
â”œâ”€â”€ id (PK)
â”œâ”€â”€ scene_id (FK â†’ scenes.id)
â”œâ”€â”€ cue_type ('sfx')
â”œâ”€â”€ name (åŠ¹æœéŸ³å)
â”œâ”€â”€ r2_key, r2_url (R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)
â”œâ”€â”€ start_ms (é–‹å§‹æ™‚åˆ»)
â”œâ”€â”€ end_ms, duration_ms (çµ‚äº†/å°º)
â”œâ”€â”€ volume (0.0-1.0, default: 0.8)
â”œâ”€â”€ loop (boolean)
â”œâ”€â”€ fade_in_ms, fade_out_ms
â”œâ”€â”€ is_active
â””â”€â”€ created_at, updated_at
```

#### API
- `GET /api/scenes/:sceneId/audio-cues` - SFXä¸€è¦§å–å¾—
- `POST /api/scenes/:sceneId/audio-cues/sfx/upload` - SFXã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- `PUT /api/scenes/:sceneId/audio-cues/:id` - SFXè¨­å®šæ›´æ–°
- `DELETE /api/scenes/:sceneId/audio-cues/:id` - SFXå‰Šé™¤

#### Audio SSOTï¼ˆæœ€çµ‚3ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆï¼‰
1. **BGM**: `project_audio_tracks`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ï¼‰
2. **SFX**: `scene_audio_cues`ï¼ˆã‚·ãƒ¼ãƒ³å˜ä½ï¼‰
3. **Voice**: `scene_utterances`ï¼ˆç™ºè©±å˜ä½ï¼‰

#### Preflight UI
- ğŸµ BGM / ğŸ”Š SFX(N) / ğŸ™ Voice(N) ã®å½¢å¼ã§éŸ³å£°çŠ¶æ…‹ã‚’1è¡Œè¡¨ç¤º
- ç„¡éŸ³ã®å ´åˆã¯ ğŸ”‡ éŸ³ãªã—ï¼ˆè­¦å‘Šè¡¨ç¤ºï¼‰

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `0031_create_scene_audio_cues.sql`

---

### R4: SSOT Patch APIï¼ˆãƒãƒ£ãƒƒãƒˆä¿®æ­£ï¼‰

#### æ¦‚è¦
ãƒãƒ£ãƒƒãƒˆæŒ‡ç¤ºã‚’SSOTãƒ‘ãƒƒãƒã¨ã—ã¦é©ç”¨ã™ã‚‹APIã€‚dry-run â†’ apply ã®2æ®µéšãƒ•ãƒ­ãƒ¼ã§å®‰å…¨ã«å¤‰æ›´ã‚’é©ç”¨ã€‚

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
patch_requests
â”œâ”€â”€ id (PK)
â”œâ”€â”€ project_id (FK â†’ projects.id)
â”œâ”€â”€ video_build_id (ã‚½ãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰IDã€NULLå¯)
â”œâ”€â”€ source ('chat' | 'api')
â”œâ”€â”€ user_message (ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º)
â”œâ”€â”€ ops_json (ãƒ‘ãƒƒãƒæ“ä½œé…åˆ—)
â”œâ”€â”€ status ('draft' | 'dry_run_ok' | 'dry_run_failed' | 'apply_ok' | 'apply_failed')
â”œâ”€â”€ dry_run_result_json, apply_result_json
â””â”€â”€ created_at, updated_at

patch_effects
â”œâ”€â”€ id (PK)
â”œâ”€â”€ patch_request_id (FK)
â”œâ”€â”€ entity, record_id, op
â”œâ”€â”€ before_json, after_json (å¤‰æ›´å‰å¾Œã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ)
â””â”€â”€ created_at

video_buildsï¼ˆæ‹¡å¼µï¼‰
â”œâ”€â”€ source_video_build_id (æ´¾ç”Ÿå…ƒãƒ“ãƒ«ãƒ‰)
â””â”€â”€ patch_request_id (é©ç”¨ã•ã‚ŒãŸãƒ‘ãƒƒãƒ)
```

#### API
- `POST /api/projects/:id/patches/dry-run` - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
- `POST /api/projects/:id/patches/apply` - ãƒ‘ãƒƒãƒé©ç”¨ï¼ˆ+ æ–°ãƒ“ãƒ«ãƒ‰è‡ªå‹•ç”Ÿæˆï¼‰
- `GET /api/projects/:id/patches` - ãƒ‘ãƒƒãƒå±¥æ­´ä¸€è¦§
- `GET /api/projects/:id/patches/:patchId` - ãƒ‘ãƒƒãƒè©³ç´°

#### è¨±å¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼‰
- `scene_balloons`: ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ»ä½ç½®ãƒ»ã‚µã‚¤ã‚º
- `scene_audio_cues`: SFXã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ»éŸ³é‡
- `scene_motion`: ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒªã‚»ãƒƒãƒˆ
- `project_audio_tracks`: BGMéŸ³é‡ãƒ»æœ‰åŠ¹/ç„¡åŠ¹
- `scene_utterances`: éŸ³å£°ã‚¿ã‚¤ãƒŸãƒ³ã‚°

#### ç¦æ­¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
- `r2_key`, `r2_url`ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç›´æ¥æ“ä½œç¦æ­¢ï¼‰
- `audio_generation_id`ï¼ˆFKæ“ä½œç¦æ­¢ï¼‰
- `text`, `character_key`ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ“ä½œåˆ¶é™ï¼‰

#### applyå¾Œã®è‡ªå‹•ãƒ“ãƒ«ãƒ‰ç”Ÿæˆ
ãƒ‘ãƒƒãƒé©ç”¨æˆåŠŸæ™‚ã«è‡ªå‹•ã§æ–°ã—ã„`video_build`ã‚’ä½œæˆ:
1. `patch_request.status` = `apply_ok` ã«æ›´æ–°
2. æ–°ã—ã„`video_build`ä½œæˆï¼ˆ`patch_request_id`ã‚’è¨˜éŒ²ï¼‰
3. `project.json`ã‚’å†ç”Ÿæˆã—ã¦R2ã«ä¿å­˜
4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«`new_video_build_id`ã‚’è¿”å´

#### UI
- VideoBuildã‚¿ãƒ–å†…ã«ã€Œä¿®æ­£å±¥æ­´ï¼ˆãƒ‘ãƒƒãƒï¼‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³
- æ—¥æ™‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€å¤‰æ›´ã‚¿ã‚¤ãƒ—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
- ç”Ÿæˆã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰ã¸ã®ãƒªãƒ³ã‚¯
- è©³ç´°å±•é–‹ã§æ“ä½œå†…å®¹ï¼ˆops_jsonï¼‰è¡¨ç¤º

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `0032_create_patch_requests.sql`
- `0033_add_video_builds_patch_columns.sql`

---

### Safe Chat v1 - ãƒ†ãƒ­ãƒƒãƒ—ã‚³ãƒãƒ³ãƒ‰ (PR-5-3b)

#### æ¦‚è¦
Safe Chat ã§ãƒ†ãƒ­ãƒƒãƒ—è¨­å®šã‚’ã€Œäº‹æ•…ã‚‰ãªã„ç¯„å›²ã ã‘ã€å¤‰æ›´å¯èƒ½ã«ã€‚Buildå˜ä½ã®ä¸Šæ›¸ãã§å®Ÿç¾ï¼ˆDBã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯å¤‰æ›´ã—ãªã„ï¼‰ã€‚

#### è¨±å¯æ“ä½œï¼ˆ4ã¤ã®ã¿ï¼‰
| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
|---------|------|-----------|
| `telop.set_enabled` | å…¨ãƒ†ãƒ­ãƒƒãƒ— ON/OFF | `enabled: boolean` |
| `telop.set_position` | ä½ç½®ãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´ | `position_preset: 'bottom' \| 'center' \| 'top'` |
| `telop.set_size` | ã‚µã‚¤ã‚ºãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´ | `size_preset: 'sm' \| 'md' \| 'lg'` |

#### ç¦æ­¢äº‹é …
- æœ¬æ–‡ text ã¯ä¸€åˆ‡è§¦ã‚‰ãªã„
- ã‚·ãƒ¼ãƒ³æ§‹æˆï¼ˆä¸¦ã³æ›¿ãˆ/åˆ†å‰²çµ±åˆï¼‰ã¯è§¦ã‚‰ãªã„
- å­—å¹•ï¼ˆcaptionsï¼‰ã«ã¯å½±éŸ¿ã—ãªã„

#### SSOT ç½®ãå ´æ‰€
- **Buildå˜ä½ã®ä¸Šæ›¸ã**: `settings_json.telops.enabled / position_preset / size_preset`
- DBã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆ`scene_telops`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã¯æ›´æ–°ã—ãªã„

#### UIãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¾‹
```
ã€Œãƒ†ãƒ­ãƒƒãƒ—ã‚’å…¨éƒ¨OFFã€
ã€Œãƒ†ãƒ­ãƒƒãƒ—ã‚’å…¨éƒ¨ONã€
ã€Œãƒ†ãƒ­ãƒƒãƒ—ä½ç½®ã‚’ä¸Šã«ã€
ã€Œãƒ†ãƒ­ãƒƒãƒ—ä½ç½®ã‚’ä¸­å¤®ã«ã€
ã€Œãƒ†ãƒ­ãƒƒãƒ—ã‚µã‚¤ã‚ºã‚’å¤§ã«ã€
```

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `src/routes/patches.ts`: `TelopSetEnabledAction`, `TelopSetPositionAction`, `TelopSetSizeAction` å‹å®šç¾© + `resolveIntentToOps` ã§ã®telopå‡¦ç†
- `public/static/project-editor.js`: `parseMessageToIntent` ã«ãƒ†ãƒ­ãƒƒãƒ—ãƒ‘ãƒ¼ã‚µãƒ¼è¿½åŠ 

---

## 2026-01-19 è¿½åŠ æ©Ÿèƒ½

### Phase 1: Scene Splitç„¡é™å¾…ã¡ã‚¼ãƒ­åŒ–
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10åˆ†ã§ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
- **å¤±æ•—æ¤œå‡º**: status='failed' ã‚’æ¤œå‡ºã—ã¦UIè¡¨ç¤º
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼**: 3å›ãƒªãƒˆãƒ©ã‚¤å¾Œã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
- **LogIDè¡¨ç¤º**: ã‚µãƒãƒ¼ãƒˆç”¨ãƒ­ã‚°IDç”Ÿæˆ
- **å†è©¦è¡Œãƒœã‚¿ãƒ³**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ã‚¨ãƒ©ãƒ¼å¾Œã®å¾©å¸°å°ç·š
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `docs/SCENE_SPLIT_SSOT.md`

### Phase 2: voice-presets.jsonæ›´æ–°
- **provideréšå±¤åŒ–**: Google / Fish / ElevenLabs ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
- **ElevenLabsæº–å‚™ä¸­**: 8ãƒœã‚¤ã‚¹ã‚’ `status: 'coming_soon'` ã§è¿½åŠ 
- **tierè¿½åŠ **: basic / standard / premium

### Phase 3: æ¼«ç”»å¹ãå‡ºã—è¨­è¨ˆæ›¸
- **textStyle**: ç¸¦æ›¸ã/æ¨ªæ›¸ãã€ãƒ•ã‚©ãƒ³ãƒˆã€å¤ªå­—ã€ã‚µã‚¤ã‚º
- **timing**: è¡¨ç¤ºã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- **Remotionçµ±åˆæ¡ˆ**: BuildRequest v1.1 æ‹¡å¼µ
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `docs/BUBBLE_TEXTSTYLE_SPEC.md`

### Phase 4: TTSè¨ˆæ¸¬ãƒ»ä¸Šé™ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­è¨ˆæ›¸
- **tts_usage_logs**: ä½¿ç”¨é‡ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ
- **ä¸Šé™åˆ¶å¾¡**: æ®µéšè­¦å‘Šï¼ˆ70/85/95/100%ï¼‰
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: åŒä¸€ãƒ†ã‚­ã‚¹ãƒˆã®å†åˆ©ç”¨
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `docs/TTS_USAGE_LIMITS_SPEC.md`

---

## 2026-01-23 Safe Chat v1

### æ¦‚è¦
ãƒãƒ£ãƒƒãƒˆä¿®æ­£ï¼ˆSafe Chatï¼‰ã®ã‚³ã‚¹ãƒˆå¯è¦–åŒ–æ©Ÿèƒ½ã€‚ã™ã¹ã¦ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’`api_usage_logs`ã«çµ±ä¸€è¨˜éŒ²ã—ã€SuperAdminç”»é¢ã§è¿½è·¡å¯èƒ½ã«ã€‚

### ã‚³ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆï¼ˆapi_usage_logsï¼‰

| api_type | provider | ç”¨é€” | ãƒ­ã‚°ã‚¿ã‚¤ãƒŸãƒ³ã‚° |
|----------|----------|------|--------------|
| bgm_upload | r2 | BGMã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | POST /api/projects/:id/audio-tracks/bgm/upload |
| sfx_upload | r2 | SFXã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | POST /api/scenes/:id/audio-cues/sfx/upload |
| patch_apply | ssot | APIãƒ‘ãƒƒãƒé©ç”¨ | POST /api/projects/:id/patches/apply |
| chat_edit_apply | ssot | ãƒãƒ£ãƒƒãƒˆä¿®æ­£é©ç”¨ | POST /api/projects/:id/chat-edits/apply |
| video_build_render | remotion_lambda | å‹•ç”»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° | POST /api/video-builds/:id/refresh (å®Œäº†æ™‚) |
| llm_intent | openaiç­‰ | LLM Intentç”Ÿæˆ | (å°†æ¥å®Ÿè£…) |

### userId æ­£è¦åŒ–ï¼ˆNOT NULLç¶­æŒï¼‰

| ã‚¤ãƒ™ãƒ³ãƒˆ | userId æ±ºå®šãƒ«ãƒ¼ãƒ« |
|---------|-----------------|
| video_build_render | video_builds.owner_user_id â†’ project.user_id â†’ ã‚¹ã‚­ãƒƒãƒ— |
| bgm_upload / sfx_upload | session.user_id (èªè¨¼å¿…é ˆ) |
| patch_apply / chat_edit_apply | session.user_id â†’ project.user_id |
| backfill / cron | owner_user_id â†’ project.user_id |

### API
- `GET /api/admin/usage/operations` - ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ±è¨ˆï¼ˆç¨®åˆ¥/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ï¼‰
- `POST /api/admin/backfill-render-logs` - éå»ãƒ“ãƒ«ãƒ‰ã®ãƒ­ã‚°å›å
- `POST /api/admin/cron/collect-render-logs` - Cronç”¨å›åã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `GET /api/admin/orphan-builds` - userIdä¸æ˜ãƒ“ãƒ«ãƒ‰ä¸€è¦§

### Cron å›åè¨­å®š

#### GitHub Actionsï¼ˆæ¨å¥¨ï¼‰
`.github/workflows/cron-collect-render-logs.yml`:
```yaml
name: Collect Render Logs
on:
  schedule:
    - cron: '0 3 * * *'  # 03:00 UTC = 12:00 JST
  workflow_dispatch:
jobs:
  collect-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Collect unlogged render events
        run: |
          curl -X POST \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            "https://webapp-c7n.pages.dev/api/admin/cron/collect-render-logs"
```

**å¿…è¦ãªGitHub Secret**: `CRON_SECRET`

#### Stuck Build Cleanupï¼ˆ5åˆ†é–“éš”ã§å®Ÿè¡Œæ¨å¥¨ï¼‰

`.github/workflows/cron-cleanup-stuck-builds.yml`:
```yaml
name: Cleanup Stuck Builds
on:
  schedule:
    - cron: '*/5 * * * *'  # 5åˆ†ã”ã¨
  workflow_dispatch:
jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup stuck builds
        run: |
          curl -X POST \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            "https://webapp-c7n.pages.dev/api/admin/cron/cleanup-stuck-builds"
```

#### å¤–éƒ¨ Cron ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆUptimeRobot / cron-job.orgï¼‰

1. **UptimeRobot** (ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§5åˆ†é–“éš”å¯èƒ½)
   - URL: `https://webapp-c7n.pages.dev/api/admin/cron/cleanup-stuck-builds`
   - Method: `POST`
   - Custom HTTP Header: `X-Cron-Secret: your-secret`

2. **cron-job.org** (ç„¡æ–™ãƒ»1åˆ†é–“éš”ã‚‚å¯èƒ½)
   - URL: `https://webapp-c7n.pages.dev/api/admin/cron/cleanup-stuck-builds`
   - Request method: `POST`
   - Header: `X-Cron-Secret: your-secret`

#### æ‰‹å‹•å®Ÿè¡Œ
```bash
# Stuck Build Cleanup
curl -X POST \
  -H "X-Cron-Secret: your-secret" \
  "https://webapp-c7n.pages.dev/api/admin/cron/cleanup-stuck-builds"

# Render Log Collection
curl -X POST \
  -H "X-Cron-Secret: your-secret" \
  "https://webapp-c7n.pages.dev/api/admin/cron/collect-render-logs"
```

### Cron ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ç”¨é€” | æ¨å¥¨é–“éš” |
|---------------|------|---------|
| `POST /api/admin/cron/cleanup-stuck-builds` | 30åˆ†ä»¥ä¸Š stuck ã®ãƒ“ãƒ«ãƒ‰ã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ« | 5åˆ† |
| `POST /api/admin/cron/collect-render-logs` | æœªè¨˜éŒ²ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ­ã‚°ã‚’å›å | 1æ—¥1å› |

### SuperAdmin UI
ç®¡ç†ç”»é¢ â†’ ã‚³ã‚¹ãƒˆç®¡ç† â†’ ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨é‡:
- ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¨®åˆ¥ã”ã¨ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã€æ¨å®šã‚³ã‚¹ãƒˆï¼‰
- ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°/ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
- æœ€è¿‘ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `0034_add_video_builds_render_usage_logged.sql` - äºŒé‡è¨ˆä¸Šé˜²æ­¢ãƒ•ãƒ©ã‚°

---

## AWS Webhook (Callback) ä»•æ§˜

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
`POST /api/webhooks/video-build`

### èªè¨¼
- **Header**: `X-Webhook-Signature: HMAC-SHA256(body, WEBHOOK_SECRET)`
- ç’°å¢ƒå¤‰æ•° `WEBHOOK_SECRET` ã¾ãŸã¯ `CRON_SECRET` ã‚’ä½¿ç”¨

### Payload
```json
{
  "video_build_id": 123,
  "status": "rendering|uploading|completed|failed",
  "progress_percent": 50,
  "progress_stage": "Rendering frames",
  "progress_message": "Processing scene 3 of 10",
  "download_url": "https://...",
  "download_expires_at": "2026-01-25T12:00:00Z",
  "error_code": "RENDER_ERROR",
  "error_message": "Failed to render scene 5",
  "render_metadata": {
    "render_id": "remotion-render-id",
    "started_at": "2026-01-24T10:00:00Z",
    "completed_at": "2026-01-24T10:05:00Z",
    "duration_sec": 300,
    "estimated_cost_usd": 0.05
  }
}
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```json
{
  "success": true,
  "message": "Build updated",
  "status": "completed"
}
```

### ç‰¹å¾´
- **å†ªç­‰æ€§**: åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å†é€ã¯ç„¡è¦–
- **äºŒé‡è¨ˆä¸Šé˜²æ­¢**: `render_usage_logged` ãƒ•ãƒ©ã‚°ã§ lock-first ãƒ‘ã‚¿ãƒ¼ãƒ³
- **è‡ªå‹•ãƒ­ã‚°è¨˜éŒ²**: completed/failed æ™‚ã« `api_usage_logs` ã¸è¨˜éŒ²

---

## AWS Webhook Integration

AWS Orchestrator ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ä¾å­˜è„±å´ï¼‰ã€‚

### Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

`POST /api/webhooks/video-build`

**èªè¨¼**: HMAC-SHA256 ç½²åæ¤œè¨¼
```
X-Webhook-Signature: HMAC-SHA256(body, WEBHOOK_SECRET)
```

**Payload**:
```json
{
  "video_build_id": 123,
  "status": "completed",
  "progress_percent": 100,
  "progress_stage": "Completed",
  "download_url": "https://...",
  "download_expires_at": "2026-01-25T12:00:00Z",
  "render_metadata": {
    "render_id": "...",
    "started_at": "2026-01-24T10:00:00Z",
    "completed_at": "2026-01-24T10:05:00Z",
    "duration_sec": 300,
    "estimated_cost_usd": 0.50
  }
}
```

**Status å€¤**: `rendering`, `uploading`, `completed`, `failed`

### ç’°å¢ƒå¤‰æ•°

```bash
# Webhook ç½²åæ¤œè¨¼ç”¨ï¼ˆCRON_SECRET ã¨å…±ç”¨å¯èƒ½ï¼‰
WEBHOOK_SECRET=your-webhook-secret
```

### äºŒé‡è¨ˆä¸Šé˜²æ­¢

- `render_usage_logged` ãƒ•ãƒ©ã‚°ã§å†ªç­‰æ€§ã‚’ä¿è¨¼
- Webhook ã¨ Cron ã®ã©ã¡ã‚‰ãŒå…ˆã«å‡¦ç†ã—ã¦ã‚‚åŒã˜çµæœ

### Orchestratorå´ Webhooké€ä¿¡ã‚³ãƒ¼ãƒ‰ï¼ˆã‚³ãƒ”ãƒšç”¨ï¼‰

AWS Lambda / Node.js 18+ å‘ã‘ã®ç½²åä»˜ãWebhooké€ä¿¡å®Ÿè£…:

```typescript
// Orchestratorå´ã«è¿½åŠ ã™ã‚‹ Webhook é€ä¿¡ã‚³ãƒ¼ãƒ‰
import crypto from 'crypto';

const WEBHOOK_URL = process.env.WEBHOOK_URL || 'https://webapp-c7n.pages.dev/api/webhooks/video-build';
const WEBHOOK_SECRET = process.env.WEBHOOK_SECRET; // Cloudflareå´ã¨åŒã˜å€¤

interface WebhookPayload {
  video_build_id: number;
  status: 'rendering' | 'uploading' | 'completed' | 'failed';
  progress_percent?: number;
  progress_stage?: string;
  progress_message?: string;
  download_url?: string;
  download_expires_at?: string; // ISO8601
  error_code?: string;
  error_message?: string;
  render_metadata?: {
    render_id?: string;
    started_at?: string;
    completed_at?: string;
    duration_sec?: number;
    duration_ms?: number;
    estimated_cost_usd?: number;
  };
}

async function postWebhook(payload: WebhookPayload): Promise<void> {
  if (!WEBHOOK_SECRET) {
    console.warn('[Webhook] WEBHOOK_SECRET not configured, skipping');
    return;
  }

  const body = JSON.stringify(payload);
  const timestamp = Math.floor(Date.now() / 1000).toString();
  const message = `${timestamp}.${body}`;
  
  const signature = crypto
    .createHmac('sha256', WEBHOOK_SECRET)
    .update(message)
    .digest('hex');

  const eventId = crypto.randomUUID();

  const response = await fetch(WEBHOOK_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Rilarc-Timestamp': timestamp,
      'X-Rilarc-Signature': `sha256=${signature}`,
      'X-Rilarc-Event-Id': eventId,
    },
    body,
  });

  if (!response.ok) {
    const text = await response.text();
    throw new Error(`Webhook failed: ${response.status} ${text}`);
  }

  console.log(`[Webhook] Sent ${payload.status} for build ${payload.video_build_id}`);
}

// ä½¿ç”¨ä¾‹ - completed
await postWebhook({
  video_build_id: 123,
  status: 'completed',
  progress_percent: 100,
  progress_stage: 'Completed',
  download_url: 'https://your-bucket.s3.amazonaws.com/video.mp4?presigned...',
  download_expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
  render_metadata: {
    render_id: 'remotion-render-abc123',
    started_at: startTime.toISOString(),
    completed_at: new Date().toISOString(),
    duration_ms: totalDurationMs,
    estimated_cost_usd: estimatedCost,
  },
});

// ä½¿ç”¨ä¾‹ - failed
await postWebhook({
  video_build_id: 123,
  status: 'failed',
  error_code: 'RENDER_ERROR',
  error_message: 'Failed to render scene 5: Out of memory',
  render_metadata: {
    render_id: 'remotion-render-abc123',
    started_at: startTime.toISOString(),
  },
});
```

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
- `X-Rilarc-Timestamp` ã¯ç§’å˜ä½ã®UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
- ç½²åã¯ `timestamp.body` ã‚’ HMAC-SHA256 ã§è¨ˆç®—
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒ Â±5åˆ† ã‚’è¶…ãˆã‚‹ã¨æ‹’å¦ã•ã‚Œã‚‹ï¼ˆãƒªãƒ—ãƒ¬ã‚¤å¯¾ç­–ï¼‰
- `X-Rilarc-Event-Id` ã¯ç›£æŸ»ãƒ­ã‚°è¿½è·¡ç”¨

---

## å¾©æ—§æ‰‹é †ï¼ˆã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å†é–‹ç”¨ï¼‰

### æ–¹æ³•1: GitHubã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆæ¨å¥¨ï¼‰

```bash
# GitHub ã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³
cd /home/user
git clone https://github.com/matiuskuma2/webapp.git
cd webapp

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆ5åˆ†ç¨‹åº¦ã‹ã‹ã‚‹å ´åˆã‚ã‚Šï¼‰
npm install

# ãƒ­ãƒ¼ã‚«ãƒ«DBåˆæœŸåŒ–ï¼ˆ38å€‹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼‰
npm run db:migrate:local

# ãƒ“ãƒ«ãƒ‰
npm run build

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
pm2 start ecosystem.config.cjs

# å‹•ä½œç¢ºèª
curl http://localhost:3000/api/settings/motion-presets
```

### æ–¹æ³•2: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ€æ–°ã®tar.gzã‚’ä½¿ç”¨ï¼‰
curl -o backup.tar.gz "https://www.genspark.ai/api/files/s/LATEST_BACKUP_ID"

# å±•é–‹ï¼ˆ/home/userã«å±•é–‹ï¼‰
tar -xzf backup.tar.gz -C /home/user/

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
cd /home/user/webapp
npm install

# ãƒ­ãƒ¼ã‚«ãƒ«DBåˆæœŸåŒ–
npm run db:migrate:local

# ãƒ“ãƒ«ãƒ‰ï¼†èµ·å‹•
npm run build
pm2 start ecosystem.config.cjs
```

### æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

```bash
# 1. Cloudflare APIè¨­å®šç¢ºèª
npx wrangler whoami

# 2. æœ¬ç•ªDBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåˆå›ã®ã¿ï¼‰
npm run db:migrate:prod

# 3. ãƒ‡ãƒ—ãƒ­ã‚¤
npm run build
npx wrangler pages deploy dist --project-name webapp
```

### ç’°å¢ƒå¤‰æ•°ï¼ˆ.dev.varsï¼‰

```bash
# å¿…é ˆ
OPENAI_API_KEY=sk-...
GEMINI_API_KEY=...

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå‹•ç”»ç”Ÿæˆç”¨ï¼‰
AWS_REGION=ap-northeast-1
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
VIDEO_BUILD_ORCHESTRATOR_URL=...

# ç®¡ç†ç”¨
CRON_SECRET=...
WEBHOOK_SECRET=...
```

---

## 2026-01-30 PR-Audio-Video è¿½åŠ æ©Ÿèƒ½

### å‹•ç”»ç´ æã®å…ƒéŸ³å£°ãƒŸãƒ¥ãƒ¼ãƒˆ
Remotion Lambdaå´ã®`bundle.js`ã‚’ä¿®æ­£ã—ã€å‹•ç”»ã‚¯ãƒªãƒƒãƒ—ç´ æã®å…ƒéŸ³å£°ã‚’è‡ªå‹•ãƒŸãƒ¥ãƒ¼ãƒˆã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã€‚

**ä¿®æ­£å†…å®¹**:
- `Video`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«`muted: true`ã‚’è¿½åŠ 
- æœ€çµ‚å‹•ç”»ã§ã¯ç´ æå‹•ç”»ã®å…ƒéŸ³å£°ï¼ˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆéŸ³ç­‰ï¼‰ã¯æ¶ˆéŸ³ã•ã‚Œã‚‹
- TTSéŸ³å£°ã¨BGMã®ã¿ãŒæœ€çµ‚å‡ºåŠ›ã«å«ã¾ã‚Œã‚‹

**S3ãƒã‚±ãƒƒãƒˆ**: `remotionlambda-apnortheast1-ucgr0eo7k7`
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `sites/rilarc-video-build/bundle.js`

### display_asset_type 3æŠåˆ‡æ›¿UIï¼ˆPhase1.8ï¼‰
ã‚·ãƒ¼ãƒ³ã‚«ãƒ¼ãƒ‰ã§ç”»åƒ/æ¼«ç”»/å‹•ç”»ã‚’é¸æŠã§ãã‚‹UIã‚’è¿½åŠ ã€‚

**è¡¨ç¤ºæ¡ä»¶**:
- æ¼«ç”»ãƒœã‚¿ãƒ³: å…¬é–‹æ¸ˆã¿æ¼«ç”»ãŒã‚ã‚‹å ´åˆã«è¡¨ç¤ºï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
- å‹•ç”»ãƒœã‚¿ãƒ³: å®Œäº†æ¸ˆã¿å‹•ç”»ãŒã‚ã‚‹å ´åˆã«è¡¨ç¤ºï¼ˆç´«ï¼‰
- ç”»åƒãƒœã‚¿ãƒ³: å¸¸ã«è¡¨ç¤ºï¼ˆé’ï¼‰

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¯¾å¿œ**:
- `PUT /api/scenes/:id/display-asset-type` ã§ `video` ã‚¿ã‚¤ãƒ—ã‚’ã‚µãƒãƒ¼ãƒˆ
- å®Œäº†æ¸ˆã¿å‹•ç”»ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 

### éŸ³å£°ä¸€æ‹¬ç”Ÿæˆæ©Ÿèƒ½

#### Preflightã‹ã‚‰ã®ä¸€æ‹¬ç”Ÿæˆ
Video Buildç”»é¢ã®æº–å‚™çŠ¶æ³è¡¨ç¤ºã«ã€ŒéŸ³å£°ã‚’ä¸€æ‹¬ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã€‚

**è¡¨ç¤ºæ¡ä»¶**: æœªç”ŸæˆéŸ³å£°ï¼ˆAUDIO_MISSING/NO_UTTERANCESï¼‰ãŒã‚ã‚‹å ´åˆ
**æ©Ÿèƒ½**: å…¨ã‚·ãƒ¼ãƒ³ã®æœªç”Ÿæˆutteranceã«å¯¾ã—ã¦éŸ³å£°ç”Ÿæˆã‚’é †æ¬¡å®Ÿè¡Œ

#### ã‚·ãƒ¼ãƒ³ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ã®éŸ³å£°ç”Ÿæˆ
å„ã‚·ãƒ¼ãƒ³ã‚«ãƒ¼ãƒ‰ã«ã€ŒéŸ³å£°ç”Ÿæˆ Nä»¶ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã€‚

**è¡¨ç¤ºæ¡ä»¶**: æœªç”Ÿæˆã®utteranceãŒã‚ã‚‹å ´åˆ
**æ©Ÿèƒ½**: è©²å½“ã‚·ãƒ¼ãƒ³ã®æœªç”Ÿæˆutteranceã«å¯¾ã—ã¦éŸ³å£°ç”Ÿæˆã‚’å®Ÿè¡Œ

#### å‹•ç”»ãƒ“ãƒ«ãƒ‰å‰ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
å‹•ç”»ç”Ÿæˆé–‹å§‹æ™‚ã«æœªç”ŸæˆéŸ³å£°ãŒã‚ã‚‹å ´åˆã€3æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã€‚

**é¸æŠè‚¢**:
1. **å…ˆã«éŸ³å£°ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰**: ä¸€æ‹¬éŸ³å£°ç”Ÿæˆã‚’å®Ÿè¡Œ
2. **ç„¡éŸ³ã®ã¾ã¾å‹•ç”»ã‚’ä½œæˆ**: ãã®ã¾ã¾ç¶šè¡Œ
3. **ã‚­ãƒ£ãƒ³ã‚»ãƒ«**: ãƒ“ãƒ«ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

### utteranceå€‹åˆ¥éŸ³å£°ç”ŸæˆAPIä¿®æ­£
`generateSceneAudio`é–¢æ•°ã‚’ä¿®æ­£ã—ã€utteranceå€‹åˆ¥ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã€‚

**å•é¡Œ**: ä»¥å‰ã¯`/api/scenes/:id/generate-audio`ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€`order_no=1`ã®utteranceã®ã¿ãŒæ›´æ–°ã•ã‚Œã¦ã„ãŸ
**ä¿®æ­£**: `/api/utterances/:id/generate-audio`ã‚’ä½¿ç”¨ã—ã€å„utteranceã«å€‹åˆ¥ã«éŸ³å£°ã‚’ç”Ÿæˆ

### å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
- `public/static/project-editor.js`: UIè¿½åŠ ï¼ˆdisplay_asset_typeåˆ‡æ›¿ã€éŸ³å£°ç”Ÿæˆãƒœã‚¿ãƒ³ã€ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰
- `src/routes/comic.ts`: display-asset-type APIã§'video'ã‚’ã‚µãƒãƒ¼ãƒˆ
- **Remotion S3**: `bundle.js`ã«mutedè¨­å®šè¿½åŠ 

### Gitã‚³ãƒŸãƒƒãƒˆ
```
e8d1963 fix(PR-Audio-Fix): Use utterance-specific audio generation API
cd508c1 feat(PR-Audio-Video): Add video asset type selector and audio confirm dialog
3486880 feat(PR-Audio-Bulk): Preflightç”»é¢ã‹ã‚‰ä¸€æ‹¬éŸ³å£°ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
a706a3c feat(PR-Audio-Direct): ã‚·ãƒ¼ãƒ³ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ç›´æ¥éŸ³å£°ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
```

---

## 2026-01-30 P0: BGM/SFX SSOTåŒ– + éŸ³å£°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨­è¨ˆ

### P0-1: SFXå†ç”Ÿã‚µãƒãƒ¼ãƒˆï¼ˆRemotionï¼‰
Remotionã®Scene.tsxã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚·ãƒ¼ãƒ³å˜ä½ã®SFXå†ç”Ÿã‚’ã‚µãƒãƒ¼ãƒˆã€‚

**è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«**:
- `video-build-remotion/src/schemas/project-schema.ts`: SfxAssetã‚¹ã‚­ãƒ¼ãƒè¿½åŠ 
- `video-build-remotion/src/components/Scene.tsx`: SFXå†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 

**SfxAssetã‚¹ã‚­ãƒ¼ãƒ**:
```typescript
{
  id: string,
  name?: string,
  url: string,
  start_ms: number,  // ã‚·ãƒ¼ãƒ³å†…ã®é–‹å§‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
  end_ms?: number,
  duration_ms?: number,
  volume: number,    // 0.0-1.0 (default: 0.8)
  loop: boolean,
  fade_in_ms: number,
  fade_out_ms: number,
}
```

**Remotionçµ±åˆ**:
- scene.sfx[]é…åˆ—ã‚’Sequence + Audioã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å†ç”Ÿ
- start_msã§ã‚·ãƒ¼ãƒ³å†…ã®é–‹å§‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æŒ‡å®š
- duration_msãŒã‚ã‚Œã°ãã®é•·ã•ã€ãªã‘ã‚Œã°ã‚·ãƒ¼ãƒ³çµ‚äº†ã¾ã§å†ç”Ÿ
- volume/loopã®è¨­å®šã‚’åæ˜ 

### éŸ³å£°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨­è¨ˆï¼ˆP1/P2æº–å‚™ï¼‰

#### 0040: user_audio_libraryï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼éŸ³ç´ æãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
BGM/SFXã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨ªæ–­ã§å†åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

**ç‰¹å¾´**:
- user_idãƒ™ãƒ¼ã‚¹ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªããƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ä»˜ãï¼‰
- tags/mood/categoryã§AIææ¡ˆã«å¯¾å¿œ
- use_countã§ä½¿ç”¨å›æ•°ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨åŒã˜ã€Œå†åˆ©ç”¨å‰æã‚¢ã‚»ãƒƒãƒˆã€ã¨ã—ã¦è¨­è¨ˆ

**ã‚«ãƒ©ãƒ **:
```sql
id, user_id, audio_type('bgm'|'sfx'), name, description,
category, mood, tags(JSON),
r2_key, r2_url, duration_ms, file_size,
default_volume, default_loop, default_fade_in_ms, default_fade_out_ms,
is_active, use_count, created_at, updated_at
```

#### 0041: scene_audio_assignmentsï¼ˆã‚·ãƒ¼ãƒ³ã¸ã®éŸ³ç´ æå‰²å½“ï¼‰
ã‚·ãƒ¼ãƒ³ã¨BGM/SFXã®ç´ä»˜ã‘ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

**ç‰¹å¾´**:
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå‚ç…§ï¼ˆsystem/userï¼‰ã¾ãŸã¯ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆdirectï¼‰ã«å¯¾å¿œ
- audio_type='bgm'ã¯1ã‚·ãƒ¼ãƒ³1ä»¶ã®ã¿ã€'sfx'ã¯è¤‡æ•°å¯
- volume/loop/fadeè¨­å®šã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½
- æ—¢å­˜project_audio_tracksã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‘ã‚¹ã‚’ç¢ºä¿

**ã‚«ãƒ©ãƒ **:
```sql
id, scene_id,
audio_library_type('system'|'user'|'direct'),
system_audio_id, user_audio_id,
direct_r2_key, direct_r2_url, direct_name, direct_duration_ms,
audio_type('bgm'|'sfx'),
start_ms, end_ms,
volume_override, loop_override, fade_in_ms_override, fade_out_ms_override,
is_active, created_at, updated_at
```

### Audio SSOTã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆæœ€çµ‚å½¢ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Audio Sources (SSOT)                                    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ system_audio_library â”‚  â”‚ user_audio_library â”‚        â”‚
â”‚  â”‚ (ç®¡ç†è€…ç™»éŒ²)         â”‚  â”‚ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²)      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚            â”‚                        â”‚                   â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                        â–¼                                â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚            â”‚ scene_audio_assignments â”‚                 â”‚
â”‚            â”‚ (ã‚·ãƒ¼ãƒ³å‰²å½“SSOT)        â”‚                 â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                        â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                                            â”‚        â”‚
â”‚  â–¼                                            â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ project_audio_tracks â”‚  â”‚ scene_audio_cues   â”‚        â”‚
â”‚  â”‚ (BGM: ç§»è¡ŒæœŸé–“ä¸­)    â”‚  â”‚ (SFX: ç§»è¡ŒæœŸé–“ä¸­)  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ buildProjectJson()               â”‚
        â”‚ (video-build-helpers.ts)         â”‚
        â”‚ ãƒ»assets.bgm: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆBGM    â”‚
        â”‚ ãƒ»scene[].sfx: ã‚·ãƒ¼ãƒ³SFXé…åˆ—     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Remotion                          â”‚
        â”‚ (RilarcVideo.tsx + Scene.tsx)    â”‚
        â”‚ ãƒ»BGM: projectJson.assets.bgm    â”‚
        â”‚ ãƒ»SFX: scene.sfx[]               â”‚
        â”‚ ãƒ»Voice: scene.assets.voices[]   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### P1: User Audio Library APIï¼ˆå®Ÿè£…å®Œäº†ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸBGM/SFXã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨ªæ–­ã§å†åˆ©ç”¨ã™ã‚‹APIã€‚

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `GET /api/audio-library` - ä¸€è¦§å–å¾—ï¼ˆtype=bgm|sfx, category, mood, search, sortï¼‰
- `GET /api/audio-library/system` - **ã‚·ã‚¹ãƒ†ãƒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸€è¦§**ï¼ˆç®¡ç†è€…ç™»éŒ²ã€category=bgm|sfxï¼‰â­ P3è¿½åŠ 
- `GET /api/audio-library/user` - **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸€è¦§**ï¼ˆå€‹äººéŸ³ç´ æã€category=bgm|sfxï¼‰â­ P3è¿½åŠ 
- `GET /api/audio-library/:id` - å˜ä¸€å–å¾—
- `POST /api/audio-library/upload` - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆFormData: file, audio_type, name, tagsç­‰ï¼‰
- `PUT /api/audio-library/:id` - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
- `DELETE /api/audio-library/:id` - å‰Šé™¤ï¼ˆR2ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤ï¼‰
- `POST /api/audio-library/:id/increment-use` - ä½¿ç”¨å›æ•°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "items": [{
    "id": 1,
    "audio_type": "bgm",
    "name": "Calm Piano",
    "tags": ["calm", "piano", "background"],
    "r2_url": "https://app.marumuviai.com/audio/library/user_1/bgm/xxx.mp3",
    "duration_ms": 120000,
    "default_volume": 0.25,
    "default_loop": true,
    "use_count": 5
  }],
  "pagination": { "total": 10, "limit": 50, "offset": 0, "has_more": false },
  "filters": { "categories": ["bgm", "relaxing"], "moods": ["calm", "happy"] }
}
```

### P2: Scene Audio Assignments APIï¼ˆå®Ÿè£…å®Œäº†ï¼‰

ã‚·ãƒ¼ãƒ³ã¸ã®BGM/SFXå‰²å½“ã‚’ç®¡ç†ã™ã‚‹APIã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå‚ç…§ or ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¯¾å¿œã€‚

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `GET /api/scenes/:sceneId/audio-assignments` - ã‚·ãƒ¼ãƒ³ã®éŸ³å‰²å½“ä¸€è¦§ï¼ˆbgm + sfx[]ï¼‰
- `POST /api/scenes/:sceneId/audio-assignments` - æ–°è¦å‰²å½“ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ï¼‰
- `PUT /api/scenes/:sceneId/audio-assignments/:id` - å‰²å½“è¨­å®šæ›´æ–°
- `DELETE /api/scenes/:sceneId/audio-assignments/:id` - å‰²å½“å‰Šé™¤
- `POST /api/scenes/:sceneId/audio-assignments/direct` - ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼†å‰²å½“
- `POST /api/scenes/:sceneId/audio-assignments/deactivate-all` - å…¨éŸ³å‰²å½“ã‚’ç„¡åŠ¹åŒ–

**ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¿ã‚¤ãƒ—**:
- `system`: system_audio_libraryï¼ˆç®¡ç†è€…ç™»éŒ²ï¼‰
- `user`: user_audio_libraryï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼‰
- `direct`: ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªç™»éŒ²ï¼‰

**ãƒ«ãƒ¼ãƒ«**:
- BGM: 1ã‚·ãƒ¼ãƒ³æœ€å¤§1ã¤ï¼ˆæ–°è¦è¿½åŠ æ™‚ã¯æ—¢å­˜ã‚’è‡ªå‹•ç„¡åŠ¹åŒ–ï¼‰
- SFX: 1ã‚·ãƒ¼ãƒ³ã«è¤‡æ•°å¯èƒ½ï¼ˆstart_msã§ã‚¿ã‚¤ãƒŸãƒ³ã‚°æŒ‡å®šï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰å‰²å½“ï¼‰**:
```json
POST /api/scenes/123/audio-assignments
{
  "audio_library_type": "user",
  "user_audio_id": 5,
  "audio_type": "bgm",
  "volume_override": 0.3
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "scene_id": 123,
  "bgm": {
    "id": 1,
    "audio_library_type": "user",
    "audio_type": "bgm",
    "library": {
      "type": "user",
      "id": 5,
      "name": "Calm Piano",
      "r2_url": "https://...",
      "duration_ms": 120000,
      "default_volume": 0.25
    },
    "effective": {
      "r2_url": "https://...",
      "name": "Calm Piano",
      "volume": 0.3,
      "loop": true
    }
  },
  "sfx": [],
  "total": 1
}
```

### P3: BGM/SFXãƒ©ã‚¤ãƒ–ãƒ©ãƒªUIï¼ˆå®Ÿè£…å®Œäº†ï¼‰

ã‚·ãƒ¼ãƒ³ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã§BGM/SFXã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ©Ÿèƒ½ã€‚

**BGMã‚¿ãƒ–ã®æ©Ÿèƒ½**:
1. **ã‚·ã‚¹ãƒ†ãƒ BGMé¸æŠ**: ç®¡ç†è€…ç™»éŒ²ã®BGMãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠ
2. **ãƒã‚¤BGMé¸æŠ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸBGMãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠ
3. **ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**: æ–°ã—ã„BGMãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ€å¤§50MBï¼‰
4. **è¨­å®šå¤‰æ›´**: éŸ³é‡ãƒ»ãƒ«ãƒ¼ãƒ—ã®èª¿æ•´
5. **å‰Šé™¤**: å‰²å½“è§£é™¤

**SFXã‚¿ãƒ–ã®æ©Ÿèƒ½**:
1. **ã‚·ã‚¹ãƒ†ãƒ SFXé¸æŠ**: ç®¡ç†è€…ç™»éŒ²ã®SFXãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠ
2. **ãƒã‚¤SFXé¸æŠ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸSFXãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠ
3. **ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**: æ–°ã—ã„SFXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ€å¤§10MBï¼‰
4. **è¨­å®šå¤‰æ›´**: é–‹å§‹æ™‚é–“ã€éŸ³é‡ã€ãƒ«ãƒ¼ãƒ—ã®èª¿æ•´
5. **è¤‡æ•°è¿½åŠ å¯èƒ½**: 1ã‚·ãƒ¼ãƒ³ã«è¤‡æ•°ã®SFXã‚’è¨­å®šå¯èƒ½

**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä»•æ§˜**:
| é …ç›® | BGM | SFX |
|------|-----|-----|
| æœ€å¤§ã‚µã‚¤ã‚º | 50MB | 10MB |
| å¯¾å¿œå½¢å¼ | MP3, WAV, M4A, OGG | MP3, WAV, M4A, OGG |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³é‡ | 0.25 | 0.8 |
| ãƒ«ãƒ¼ãƒ— | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFF |

### P4: ã‚·ãƒ¼ãƒ³åˆ¥BGMé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆP3ã«çµ±åˆæ¸ˆã¿ï¼‰

ã‚·ãƒ¼ãƒ³ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®BGMã‚¿ãƒ–å†…ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’çµ±åˆã€‚

### P5: å‹•ç”»ãƒ“ãƒ«ãƒ‰ã§scene_audio_assignmentsã‚’å„ªå…ˆå–å¾—ï¼ˆå®Ÿè£…å®Œäº†ï¼‰

`video-generation.ts`ã§projectJsonç”Ÿæˆæ™‚ã«scene_audio_assignmentsã‹ã‚‰ã‚·ãƒ¼ãƒ³åˆ¥BGMã‚’å–å¾—ã€‚

### P6: Remotionã§ã‚·ãƒ¼ãƒ³åˆ¥BGMå†ç”Ÿï¼ˆå®Ÿè£…å®Œäº†ï¼‰

- **Scene.tsx**: ã‚·ãƒ¼ãƒ³åˆ¥BGMãŒã‚ã‚Œã°å„ªå…ˆå†ç”Ÿ
- **RilarcVideo.tsx**: ã‚·ãƒ¼ãƒ³åˆ¥BGMå†ç”Ÿä¸­ã¯å…¨ä½“BGMã‚’0.12ï¼ˆãƒ€ãƒƒã‚­ãƒ³ã‚°ï¼‰

### ä¾å­˜é–¢ä¿‚å›³ï¼ˆBGM/SFXãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®¡ç†è€…ç”»é¢                                                        â”‚
â”‚ /admin                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚ â”‚ system_audio_library            â”‚                             â”‚
â”‚ â”‚ - BGMï¼ˆéŸ³æ¥½ï¼‰                    â”‚                             â”‚
â”‚ â”‚ - SFXï¼ˆåŠ¹æœéŸ³ï¼‰                  â”‚                             â”‚
â”‚ â”‚ â€»ç®¡ç†è€…ãŒSunoAIç­‰ã§ä½œæˆã—ã¦URLã§ç™»éŒ²â”‚                             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼ /api/audio-library/system
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢                                                      â”‚
â”‚ /projects/:id                                                   â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚ â”‚ user_audio_library              â”‚ â† /api/audio-library/user   â”‚
â”‚ â”‚ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸBGM/SFX â”‚                             â”‚
â”‚ â”‚ - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨ªæ–­ã§å†åˆ©ç”¨å¯èƒ½     â”‚                             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                       â”‚                                         â”‚
â”‚                       â–¼ POST /api/scenes/:id/audio-assignments  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚ â”‚ scene_audio_assignments (SSOT)  â”‚                             â”‚
â”‚ â”‚ - ã‚·ãƒ¼ãƒ³æ¯ã®BGM/SFXå‰²å½“          â”‚                             â”‚
â”‚ â”‚ - audio_library_type: system/user/direct                      â”‚
â”‚ â”‚ - volume_override, loop_override â”‚                             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼ /api/projects/:id/video-build/start
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‹•ç”»ç”Ÿæˆ (Remotion)                                              â”‚
â”‚                                                                 â”‚
â”‚ projectJson.scenes[].bgm â† scene_audio_assignments ã‹ã‚‰å–å¾—      â”‚
â”‚ projectJson.assets.bgm  â† project_audio_tracks ã‹ã‚‰å–å¾—ï¼ˆå…¨ä½“BGMï¼‰ â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚ â”‚ å†ç”Ÿãƒ«ãƒ¼ãƒ«                       â”‚                             â”‚
â”‚ â”‚ 1. ã‚·ãƒ¼ãƒ³åˆ¥BGMå„ªå…ˆ              â”‚                             â”‚
â”‚ â”‚ 2. ã‚·ãƒ¼ãƒ³åˆ¥BGMå†ç”Ÿä¸­ã¯å…¨ä½“BGMã‚’ãƒ€ãƒƒã‚¯ï¼ˆ0.12ï¼‰                    â”‚
â”‚ â”‚ 3. ã‚·ãƒ¼ãƒ³åˆ¥BGMãªã—ã®å ´åˆã¯å…¨ä½“BGMã‚’é€šå¸¸å†ç”Ÿ                      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Gitã‚³ãƒŸãƒƒãƒˆ
```
a500998 P0: Add SFX playback support to Remotion + Audio library schema
acee3aa P1/P2: User Audio Library & Scene Audio Assignments API
c6b5ad9 P3: ã‚·ãƒ¼ãƒ³ã‚«ãƒ¼ãƒ‰UIæ”¹å–„ - BGM/SFXè©³ç´°è¡¨ç¤ºã¨SceneEditModalã¸ã®ãƒªãƒ³ã‚¯
285e77d P6: Remotionã§ã‚·ãƒ¼ãƒ³åˆ¥BGMå†ç”Ÿã¨å…¨ä½“BGMã®duckå‡¦ç†ã‚’å®Ÿè£…
ed49664 P5: ã‚·ãƒ¼ãƒ³åˆ¥BGMã‚’æ–°SSOTå„ªå…ˆã§å–å¾—ãƒ»projectJsonã«åæ˜ 
d47dfa0 P3-5: SceneEditModal.open(source)ã§ãƒãƒ£ãƒƒãƒˆä¿®æ­£ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’SSOTåŒ–
33254e2 P3: BGM/SFXãƒ©ã‚¤ãƒ–ãƒ©ãƒªAPIè¿½åŠ ã¨SFXã‚¿ãƒ–ã®UIæ”¹å–„
```

---

