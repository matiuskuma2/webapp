# ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è²«æ€§ã‚·ã‚¹ãƒ†ãƒ  - åŒ…æ‹¬çš„æŠ€è¡“ãƒ¬ãƒ“ãƒ¥ãƒ¼

**ä½œæˆæ—¥**: 2026-01-20  
**å¯¾è±¡**: RILARC ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã‚¢ãƒ—ãƒª  
**æœ¬ç•ªURL**: https://webapp-c7n.pages.dev

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ç›®çš„
Geminiç³»åˆ—ã®AIç”»åƒç”Ÿæˆã«ãŠã„ã¦ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¦–è¦šçš„ä¸€è²«æ€§ã‚’ç¶­æŒã™ã‚‹ã€‚

### 1.2 å¯¾å¿œãƒ¢ãƒ‡ãƒ«
- **gemini-2.5-flash-image**: æœ€å¤§3æšã®å‚ç…§ç”»åƒ
- **gemini-3-pro-image-preview**: æœ€å¤§14æšã®å‚ç…§ç”»åƒï¼ˆäººç‰©ä¸€è²«æ€§ç”¨ã¯æœ€å¤§5æšï¼‰

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 2.1 ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     project_character_models â”‚ â† ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å®šç¾©ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                          â”‚
â”‚ project_id (FK)             â”‚
â”‚ character_key (UNIQUE)      â”‚
â”‚ character_name              â”‚
â”‚ description                 â”‚
â”‚ appearance_description      â”‚ â† æ‰‹å‹•è¨­å®šã®å¤–è¦‹èª¬æ˜
â”‚ story_traits                â”‚ â† ç‰©èªã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸç‰¹å¾´ [Migration 0021]
â”‚ reference_image_r2_key      â”‚ â† R2ã‚­ãƒ¼
â”‚ reference_image_r2_url      â”‚ â† å…¬é–‹URLï¼ˆ/images/characters/...ï¼‰
â”‚ voice_preset_id             â”‚
â”‚ aliases_json                â”‚ â† åˆ¥åï¼ˆè‡ªå‹•å‰²å½“ç”¨ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 1:N
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      scene_character_map    â”‚ â† ã‚·ãƒ¼ãƒ³-ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç´ä»˜ã‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ scene_id (FK)               â”‚
â”‚ character_key               â”‚
â”‚ is_primary                  â”‚ â† ä¸»å½¹ãƒ•ãƒ©ã‚°ï¼ˆéŸ³å£°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰
â”‚ role [deprecated?]          â”‚ â† 'image' ã®ã¿ä½¿ç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 1:1
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   scene_character_traits    â”‚ â† ã‚·ãƒ¼ãƒ³åˆ¥ç‰¹å¾´ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ [Migration 0021]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ scene_id (FK)               â”‚
â”‚ character_key               â”‚
â”‚ override_type               â”‚ â† 'transform', 'add', 'remove'
â”‚ trait_description           â”‚ â† ã“ã®ã‚·ãƒ¼ãƒ³ã§ã®ç‰¹å¾´
â”‚ source                      â”‚ â† 'auto' or 'manual'
â”‚ confidence                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç‰¹å¾´å„ªå…ˆåº¦SSOT

ç”»åƒç”Ÿæˆæ™‚ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç‰¹å¾´å–å¾—å„ªå…ˆåº¦ï¼ˆ`world-character-helper.ts:141`ï¼‰:

```
1. scene_override      (æœ€é«˜) â† ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆå¤‰èº«ãªã©ï¼‰
2. story_traits        (é«˜)   â† ç‰©èªã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸç‰¹å¾´
3. appearance_description (ä½) â† æ‰‹å‹•è¨­å®šã®å¤–è¦‹èª¬æ˜
```

---

## 3. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### 3.1 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç† (`character-models.ts`)

| Method | Endpoint | èª¬æ˜ |
|--------|----------|------|
| GET | `/api/projects/:projectId/characters` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ |
| GET | `/api/projects/:projectId/characters/:characterKey` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´° |
| POST | `/api/projects/:projectId/characters` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆ |
| PUT | `/api/projects/:projectId/characters/:characterKey` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ›´æ–° |
| DELETE | `/api/projects/:projectId/characters/:characterKey` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤ |
| POST | `/api/projects/:projectId/characters/:characterKey/reference-image` | å‚ç…§ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| POST | `/api/projects/:projectId/characters/auto-assign` | è‡ªå‹•å‰²å½“å®Ÿè¡Œ |
| POST | `/api/projects/:projectId/characters/generate-preview` | ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒç”Ÿæˆ |
| GET | `/api/projects/:projectId/character-traits-summary` | ç‰¹å¾´ã‚µãƒãƒªãƒ¼å–å¾— |
| PUT | `/api/projects/:projectId/characters/:characterKey/story-traits` | å…±é€šç‰¹å¾´æ›´æ–° |

### 3.2 ã‚·ãƒ¼ãƒ³-ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç† (`scene-characters.ts`)

| Method | Endpoint | èª¬æ˜ |
|--------|----------|------|
| GET | `/api/scenes/:sceneId/characters` | ã‚·ãƒ¼ãƒ³ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ |
| POST | `/api/scenes/:sceneId/characters` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ  |
| POST | `/api/scenes/:sceneId/characters/batch` | ä¸€æ‹¬æ›´æ–° |
| DELETE | `/api/scenes/:sceneId/characters/:characterKey` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤ |
| GET | `/api/scenes/:sceneId/character-traits` | ã‚·ãƒ¼ãƒ³åˆ¥ç‰¹å¾´å–å¾— |
| POST | `/api/scenes/:sceneId/character-traits` | ã‚·ãƒ¼ãƒ³åˆ¥ç‰¹å¾´è¿½åŠ  |
| DELETE | `/api/scenes/:sceneId/character-traits/:characterKey` | ã‚·ãƒ¼ãƒ³åˆ¥ç‰¹å¾´å‰Šé™¤ |

### 3.3 ç”»åƒç”Ÿæˆ (`image-generation.ts`)

| Method | Endpoint | èª¬æ˜ |
|--------|----------|------|
| POST | `/api/scenes/:id/generate-image` | å˜ä½“ç”»åƒç”Ÿæˆ |
| POST | `/api/projects/:id/generate-images` | ãƒãƒƒãƒç”»åƒç”Ÿæˆï¼ˆ1ä»¶ãšã¤ï¼‰ |
| POST | `/api/projects/:id/generate-all-images` | å…¨ç”»åƒä¸€æ‹¬ç”Ÿæˆ |
| GET | `/api/projects/:id/generate-images/status` | ç”Ÿæˆé€²æ—å–å¾— |

---

## 4. ç”»åƒç”Ÿæˆãƒ•ãƒ­ãƒ¼

### 4.1 ç¾åœ¨ã®å®Ÿè£… (`image-generation.ts`)

```
1. ã‚·ãƒ¼ãƒ³æƒ…å ±å–å¾—ï¼ˆis_prompt_customizedå«ã‚€ï¼‰
2. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—ï¼ˆfetchSceneCharactersï¼‰
   â†“
3. å‚ç…§ç”»åƒå–å¾—ï¼ˆR2ã‹ã‚‰ï¼‰
   - r2_url â†’ r2_keyå¤‰æ›ï¼ˆå…ˆé ­ã®/ã‚’é™¤å»ï¼‰
   - R2.get() â†’ arrayBuffer â†’ base64å¤‰æ›
   - æœ€å¤§5æšã¾ã§
   â†“
4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
   - ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å ´åˆ: ãƒ†ã‚­ã‚¹ãƒˆå¼·åŒ–ã‚¹ã‚­ãƒƒãƒ—
   - é€šå¸¸ã®å ´åˆ: world + charactersæƒ…å ±ã‚’è¿½åŠ 
   - æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆæŒ‡ç¤ºè¿½åŠ ï¼ˆã‚«ã‚¹ã‚¿ãƒ æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
   â†“
5. Gemini APIå‘¼ã³å‡ºã—
   - parts[]: å‚ç…§ç”»åƒ(inline_data) + ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
   - 429ãƒªãƒˆãƒ©ã‚¤ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
   â†“
6. R2ä¿å­˜ + DBæ›´æ–°
```

### 4.2 Gemini API ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼

```json
{
  "contents": [{
    "parts": [
      { "inline_data": { "data": "BASE64...", "mime_type": "image/png" } },
      { "inline_data": { "data": "BASE64...", "mime_type": "image/png" } },
      { "text": "IMPORTANT: Any text must be in Japanese...\n\nUsing the provided reference images for character consistency (ã‚­ãƒ£ãƒ©A, ã‚­ãƒ£ãƒ©B), generate: <prompt>" }
    ]
  }],
  "generationConfig": {
    "responseModalities": ["Image"],
    "imageConfig": { "aspectRatio": "16:9", "imageSize": "2K" }
  }
}
```

---

## 5. æŠ€è¡“è² å‚µãƒ»å•é¡Œç‚¹

### 5.1 ğŸ”´ é‡å¤§ãªå•é¡Œ

#### P0-1: ãƒãƒƒãƒç”Ÿæˆã§ `r2_url` ãŒä¿å­˜ã•ã‚Œãªã„
**ãƒ•ã‚¡ã‚¤ãƒ«**: `image-generation.ts:733-737`
```typescript
// å•é¡Œ: r2_url ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
await c.env.DB.prepare(`
  UPDATE image_generations 
  SET status = 'completed', r2_key = ?, is_active = 1  // â† r2_url ãŒãªã„!
  WHERE id = ?
`).bind(r2Key, generationId).run()
```

**å½±éŸ¿**: ãƒãƒƒãƒç”Ÿæˆå¾Œã®ç”»åƒãŒUIè¡¨ç¤ºã•ã‚Œãªã„å¯èƒ½æ€§

#### P0-2: ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆæœªé©ç”¨ï¼ˆãƒãƒƒãƒç”Ÿæˆï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `image-generation.ts:651`
```typescript
const finalPrompt = buildImagePrompt(scene.image_prompt as string)
// â†‘ composeStyledPrompt() ã‚’ä½¿ã£ã¦ã„ãªã„ï¼ˆå˜ä½“ç”Ÿæˆã§ã¯ä½¿ç”¨ï¼‰
```

**å½±éŸ¿**: ãƒãƒƒãƒç”Ÿæˆæ™‚ã«ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆãŒåæ˜ ã•ã‚Œãªã„

#### P0-3: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†æ•£
**å•é¡Œ**: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãŒè¤‡æ•°ç®‡æ‰€ã«åˆ†æ•£
- `image-generation.ts:363` (å˜ä½“)
- `image-generation.ts:656` (ãƒãƒƒãƒ)
- `character-auto-assign.ts` (è‡ªå‹•å‰²å½“)

**å½±éŸ¿**: ãƒ­ã‚¸ãƒƒã‚¯ä¸æ•´åˆã®ãƒªã‚¹ã‚¯

### 5.2 ğŸŸ¡ ä¸­ç¨‹åº¦ã®å•é¡Œ

#### P1-1: `scene_character_map.role` ã‚«ãƒ©ãƒ ã®ä¸æ•´åˆ
**ç¾çŠ¶**: `0001_full_schema_from_production.sql:222` ã§ã¯ `role` ã‚«ãƒ©ãƒ ãŒå­˜åœ¨
**å•é¡Œ**: `0010_world_character_bible.sql` ã§ã¯ `role` ã‚«ãƒ©ãƒ ãŒãªã„
**ä½¿ç”¨çŠ¶æ³**: ã‚³ãƒ¼ãƒ‰ã§ã¯ `role` ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„

#### P1-2: `project_character_instances` ãƒ†ãƒ¼ãƒ–ãƒ«æœªä½¿ç”¨
**ãƒ•ã‚¡ã‚¤ãƒ«**: `0001_full_schema_from_production.sql:201-214`
**å•é¡Œ**: ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã™ã‚‹ãŒã€ã‚³ãƒ¼ãƒ‰ã§ä¸€åˆ‡ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„

#### P1-3: å‚ç…§ç”»åƒã®é‡è¤‡å–å¾—
**ãƒ•ã‚¡ã‚¤ãƒ«**: `image-generation.ts:376-410`, `image-generation.ts:656-686`
**å•é¡Œ**: ãƒãƒƒãƒå‡¦ç†ã§åŒã˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å‚ç…§ç”»åƒã‚’æ¯å›R2ã‹ã‚‰å–å¾—

### 5.3 ğŸŸ¢ è»½å¾®ãªå•é¡Œ

#### P2-1: ç‰¹å¾´æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã®é™å®šæ€§
**ãƒ•ã‚¡ã‚¤ãƒ«**: `character-trait-extractor.ts:33-48`
**å•é¡Œ**: æ—¥æœ¬èªç‰¹æœ‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ã€‚è‹±èªæ··åœ¨ãƒ†ã‚­ã‚¹ãƒˆã«å¯¾å¿œã—ã¦ã„ãªã„

#### P2-2: ãƒ¢ãƒ¼ãƒ€ãƒ«JSãŒç›´æ¥DOMã‚’æ“ä½œ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `character-trait-modal.js`
**å•é¡Œ**: ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¸ä½¿ç”¨ã«ã‚ˆã‚‹DOMæ“ä½œã®è¤‡é›‘æ€§

---

## 6. ä¿®æ­£è¨ˆç”»

### Phase 1: é‡å¤§ãƒã‚°ä¿®æ­£ï¼ˆå³åº§ï¼‰

```typescript
// P0-1 ä¿®æ­£: r2_url ã‚’è¿½åŠ 
await c.env.DB.prepare(`
  UPDATE image_generations 
  SET status = 'completed', r2_key = ?, r2_url = ?, is_active = 1
  WHERE id = ?
`).bind(r2Key, `/${r2Key}`, generationId).run()

// P0-2 ä¿®æ­£: ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨
const finalPrompt = await composeStyledPrompt(
  c.env.DB,
  parseInt(projectId),
  scene.id as number,
  buildImagePrompt(scene.image_prompt as string)
)
```

### Phase 2: SSOTå¼·åŒ–

```typescript
// æ–°è¦ãƒ˜ãƒ«ãƒ‘ãƒ¼: src/utils/character-reference-helper.ts
export async function getSceneReferenceImages(
  db: D1Database,
  r2: R2Bucket,
  sceneId: number,
  maxImages: number = 5
): Promise<ReferenceImage[]> {
  // 1. ã‚·ãƒ¼ãƒ³ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
  // 2. å„ªå…ˆåº¦é †ã«ä¸¦ã³æ›¿ãˆï¼ˆis_primaryå„ªå…ˆï¼‰
  // 3. R2ã‹ã‚‰ç”»åƒå–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œï¼‰
  // 4. base64å¤‰æ›ã—ã¦è¿”å´
}
```

### Phase 3: æœªä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«æ•´ç†

```sql
-- Migration: 0022_cleanup_unused_tables.sql
DROP TABLE IF EXISTS project_character_instances;
ALTER TABLE scene_character_map DROP COLUMN role;
```

---

## 7. ä¾å­˜é–¢ä¿‚å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend JS    â”‚â”€â”€â”€â”€â–¶â”‚   character-models   â”‚
â”‚                 â”‚     â”‚        API           â”‚
â”‚ - project-      â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   editor.js     â”‚                â”‚
â”‚ - character-    â”‚                â–¼
â”‚   trait-modal   â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - world-        â”‚â”€â”€â”€â”€â–¶â”‚  scene-characters    â”‚
â”‚   character-ui  â”‚     â”‚        API           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  world-character-    â”‚
                        â”‚     helper.ts        â”‚
                        â”‚                      â”‚
                        â”‚ - fetchWorldSettings â”‚
                        â”‚ - fetchSceneChars    â”‚
                        â”‚ - enhancePrompt      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  image-generation.ts â”‚
                        â”‚                      â”‚
                        â”‚ - generateImage      â”‚
                        â”‚   WithRetry()        â”‚
                        â”‚ - R2ã‹ã‚‰base64å¤‰æ›    â”‚
                        â”‚ - Gemini APIå‘¼å‡º     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. é‹ç”¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé˜²æ­¢ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ç”»åƒç”Ÿæˆå‰
- [ ] ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒ `project_character_models` ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
- [ ] å‚ç…§ç”»åƒãŒ `reference_image_r2_url` ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚·ãƒ¼ãƒ³ã« `scene_character_map` ãŒç´ä»˜ã„ã¦ã„ã‚‹
- [ ] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ `formatted` ä»¥é™

### ç”»åƒç”Ÿæˆä¸­
- [ ] 5åˆ†ä»¥ä¸Šã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒå‹•ä½œã—ã¦ã„ã‚‹
- [ ] 429ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹
- [ ] R2ä¿å­˜å¾Œã«DBæ›´æ–°ãŒæˆåŠŸã—ã¦ã„ã‚‹

### ç”»åƒç”Ÿæˆå¾Œ
- [ ] `r2_url` ãŒNULLã§ãªã„
- [ ] `is_active = 1` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] å¤ã„ç”»åƒãŒ `is_active = 0` ã«ãªã£ã¦ã„ã‚‹

---

## 9. ãƒ†ã‚¹ãƒˆé …ç›®

### å˜ä½“ãƒ†ã‚¹ãƒˆå¿…é ˆé …ç›®
1. `fetchSceneCharacters` ãŒã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’æ­£ã—ãå–å¾—
2. `enhancePromptWithWorldAndCharacters` ãŒå„ªå…ˆåº¦é †ã«ç‰¹å¾´ã‚’é©ç”¨
3. `generateImageWithRetry` ãŒå‚ç…§ç”»åƒã‚’æ­£ã—ãpartsé…åˆ—ã«è¿½åŠ 
4. R2ã‹ã‚‰ã®ç”»åƒå–å¾—â†’base64å¤‰æ›ãŒæ­£å¸¸å‹•ä½œ

### çµ±åˆãƒ†ã‚¹ãƒˆå¿…é ˆé …ç›®
1. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ² â†’ ã‚·ãƒ¼ãƒ³å‰²å½“ â†’ ç”»åƒç”Ÿæˆ ã®ä¸€é€£ãƒ•ãƒ­ãƒ¼
2. ã‚·ãƒ¼ãƒ³åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰è¨­å®š â†’ ç”»åƒç”Ÿæˆã§åæ˜ ç¢ºèª
3. ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ™‚ã«æ—¥æœ¬èªæŒ‡ç¤ºãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
4. ãƒãƒƒãƒç”Ÿæˆã§å…¨ã‚·ãƒ¼ãƒ³ã«åŒã˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒé©ç”¨ã•ã‚Œã‚‹

---

## 10. æ”¹å–„ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

| å„ªå…ˆåº¦ | é …ç›® | å·¥æ•° | å½±éŸ¿ç¯„å›² |
|--------|------|------|----------|
| P0 | ãƒãƒƒãƒç”Ÿæˆã®r2_urlä¿®æ­£ | 0.5h | ç”»åƒè¡¨ç¤º |
| P0 | ãƒãƒƒãƒç”Ÿæˆã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ | 1h | ç”»åƒå“è³ª |
| P0 | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠSSOTåŒ– | 2h | ä¸€è²«æ€§ |
| P1 | å‚ç…§ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ | 2h | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ |
| P1 | æœªä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ | 1h | ä¿å®ˆæ€§ |
| P2 | ç‰¹å¾´æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³æ‹¡å¼µ | 2h | ç²¾åº¦å‘ä¸Š |

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|------|----------|
| 2026-01-20 | åˆç‰ˆä½œæˆï¼ˆã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼‰ |
| 2026-01-20 | P0-1ï½P0-5, P1-1 å®Ÿè£…å®Œäº† |

---

## 11. å®Ÿè£…å®Œäº†å ±å‘Š (2026-01-20)

### âœ… å®Œäº†é …ç›®

#### P0-1: r2_urlä¿å­˜ä¸å…·åˆä¿®æ­£
- **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/routes/image-generation.ts`
- **å†…å®¹**: ãƒãƒƒãƒç”Ÿæˆæ™‚ã® `UPDATE` ã‚¯ã‚¨ãƒªã« `r2_url` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
- **æ¤œè¨¼**: ãƒ“ãƒ«ãƒ‰æˆåŠŸ

#### P0-2: ãƒãƒƒãƒç”Ÿæˆã§ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨
- **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/routes/image-generation.ts`
- **å†…å®¹**: `composeStyledPrompt()` ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†å¤‰æ›´
- **æ¤œè¨¼**: ãƒ“ãƒ«ãƒ‰æˆåŠŸ

#### P0-3: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§ç”»åƒå–å¾—ã®SSOTåŒ–
- **æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `src/utils/character-reference-helper.ts`
- **æ©Ÿèƒ½**:
  - `getSceneReferenceImages()`: ã‚·ãƒ¼ãƒ³ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§ç”»åƒã‚’å–å¾—
  - `fetchReferenceImageFromR2()`: R2ã‹ã‚‰ç”»åƒå–å¾—â†’base64å¤‰æ›
  - æœ€å¤§5æšã®åˆ¶é™ã‚’é©ç”¨ï¼ˆGemini APIä»•æ§˜ï¼‰
  - å„ªå…ˆåº¦: `is_primary=1` â†’ `created_at` é †
- **æ¤œè¨¼**: ãƒ“ãƒ«ãƒ‰æˆåŠŸ

#### P0-4: ãƒãƒƒãƒç”Ÿæˆã‚‚SSOTåŒ–ã•ã‚ŒãŸãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ç”¨
- **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/routes/image-generation.ts`
- **å†…å®¹**: `getSceneReferenceImages()` ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†å¤‰æ›´
- **æ¤œè¨¼**: ãƒ“ãƒ«ãƒ‰æˆåŠŸ

#### P0-5: å…¨ç”»åƒç”Ÿæˆãƒœã‚¿ãƒ³ã®éæ´»æ€§åŒ–UI
- **ç¢ºèªãƒ•ã‚¡ã‚¤ãƒ«**: `public/static/project-editor.*.js`
- **å†…å®¹**: æ—¢å­˜å®Ÿè£…ã‚’ç¢ºèª
  - å…¨ç”Ÿæˆæ¸ˆã¿æ™‚: ãƒœã‚¿ãƒ³disabledã€ãƒ†ã‚­ã‚¹ãƒˆã€Œå…¨ç”»åƒç”Ÿæˆæ¸ˆã¿ã€
  - æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³: APIå‘¼ã³å‡ºã—å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
- **çŠ¶æ…‹**: å®Ÿè£…æ¸ˆã¿

#### P1-1: å‚ç…§ç”»åƒã‚’æœ€å¤§5æšã«çµã‚‹å„ªå…ˆåº¦SSOTãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/utils/character-reference-helper.ts` ã®ã‚³ãƒ¡ãƒ³ãƒˆ
- **å†…å®¹**: 
  - MAX_REFERENCE_IMAGES = 5 ã®å®šæ•°
  - å„ªå…ˆåº¦ãƒ«ãƒ¼ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### â³ ä¿ç•™é …ç›®

#### P2: å‚ç…§ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆR2â†’base64ã®äºŒé‡å–å¾—é˜²æ­¢ï¼‰
- **çŠ¶æ…‹**: æœªç€æ‰‹
- **ç†ç”±**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã¯å„ªå…ˆåº¦ä½
- **å°†æ¥å¯¾å¿œ**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‚ç…§ç”»åƒã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### ğŸ”§ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒ

- **URL**: https://3000-ifuxiog3lbf1ljqeq3f8e-d0b9e1e2.sandbox.novita.ai
- **èµ·å‹•ã‚³ãƒãƒ³ãƒ‰**: `pm2 start ecosystem.config.cjs`
- **ãƒ“ãƒ«ãƒ‰**: `npm run build`

### ğŸ“ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

- **çŠ¶æ…‹**: Cloudflare API key æœªè¨­å®š
- **æ‰‹é †**: Deploy ã‚¿ãƒ–ã§ API key ã‚’è¨­å®šå¾Œã€`npx wrangler pages deploy dist` ã‚’å®Ÿè¡Œ
