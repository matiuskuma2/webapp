# Phaseè²¬å‹™è¡¨ãƒ»ãƒ­ãƒƒã‚¯è¨­è¨ˆè¡¨ãƒ»Preserveãƒ¢ãƒ¼ãƒ‰ä»•æ§˜

ä½œæˆæ—¥: 2026-02-13
ç›®çš„: å¯è¦–åŒ–ãƒ»æ•´ç†ãŒä¸è¶³ã—ã¦ã„ãŸ 3 ã¤ã®è¨­è¨ˆé ˜åŸŸã‚’ 1 å†Šã«ã¾ã¨ã‚ã€é–‹ç™ºãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»é‹ç”¨ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã¨ã™ã‚‹

---

## ç›®æ¬¡

1. [Phase Ã— è²¬å‹™ãƒãƒˆãƒªã‚¯ã‚¹](#1-phase--è²¬å‹™ãƒãƒˆãƒªã‚¯ã‚¹)
2. [ãƒ­ãƒƒã‚¯è¨­è¨ˆè¡¨](#2-ãƒ­ãƒƒã‚¯è¨­è¨ˆè¡¨)
3. [Preserve ãƒ¢ãƒ¼ãƒ‰ä»•æ§˜](#3-preserve-ãƒ¢ãƒ¼ãƒ‰ä»•æ§˜)
4. [SSOT æ±ºå®šè¨˜éŒ²ï¼ˆBæ¡ˆï¼‰](#4-ssot-æ±ºå®šè¨˜éŒ²bæ¡ˆ)
5. [ã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆ åˆ†é¡è¡¨](#5-ã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆ-åˆ†é¡è¡¨)
6. [AI é§†å‹•é–‹ç™ºç”¨ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](#6-ai-é§†å‹•é–‹ç™ºç”¨ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³)
7. [å¤‰æ›´å±¥æ­´](#7-å¤‰æ›´å±¥æ­´)
8. [ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ç§»è¡Œè¨˜éŒ²](#8-ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ç§»è¡Œè¨˜éŒ²)
9. [formatting.ts è²¬å‹™åˆ†å‰²ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](#9-formattingts-è²¬å‹™åˆ†å‰²ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—)
10. [CI ã‚²ãƒ¼ãƒˆæ­£å¼ãƒãƒªã‚·ãƒ¼](#10-ci-ã‚²ãƒ¼ãƒˆæ­£å¼ãƒãƒªã‚·ãƒ¼)
11. [execution_context ãƒ­ã‚°ä»•æ§˜](#11-execution_context-ãƒ­ã‚°ä»•æ§˜)

---

## 1. Phase Ã— è²¬å‹™ãƒãƒˆãƒªã‚¯ã‚¹

### 1.1 ä¸¸æŠ•ã’ãƒãƒ£ãƒƒãƒˆï¼ˆMarunage Chatï¼‰

```
init â”€â”€â–º formatting â”€â”€â–º awaiting_ready â”€â”€â–º generating_images â”€â”€â–º generating_audio â”€â”€â–º ready
  â”‚          â”‚                â”‚                    â”‚                     â”‚              â”‚
  â”‚          â””â”€â”€ failed â—„â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
  â”‚                                                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ canceled â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Phase | ãƒˆãƒªã‚¬ãƒ¼ | ã‚µãƒ¼ãƒãƒ¼å´ã®è²¬å‹™ | å®Œäº†åˆ¤å®š | æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆUIè¡¨ç¤ºï¼‰ | ãƒ­ãƒƒã‚¯ |
|-------|---------|-----------------|---------|---------------------|--------|
| `init` | `POST /api/marunage/:projectId/start` | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã€config ä¿å­˜ã€run ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ | å³åº§ï¼ˆåŒæœŸï¼‰ | advance ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ | ãªã— |
| `formatting` | `transitionPhase(initâ†’formatting)` + `waitUntil(formatLoop)` | æ—¢å­˜ `/api/projects/:id/format` ã‚’ HTTP å‘¼ã³å‡ºã—ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°æœ€å¤§30å›Ã—3ç§’ï¼‰ | `project.status === 'formatted'` | ã€Œæ•´å½¢ä¸­â€¦ã€ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ | ãªã—ï¼ˆformatLoop ãŒ waitUntil å†…ã§å®Œçµï¼‰ |
| `awaiting_ready` | `advance` â†’ formatting å®Œäº†ã‚’ç¢ºèª | scene ã® utterance ã‚’æ¤œè¨¼ (`utt_count > 0` å…¨ã‚·ãƒ¼ãƒ³)ã€‚è¶…éã‚·ãƒ¼ãƒ³ã‚’ `is_hidden=1` ã«è¨­å®š | å…¨ã‚·ãƒ¼ãƒ³ã« utterance å­˜åœ¨ | ã€Œæº–å‚™ç¢ºèªä¸­â€¦ã€ | ãªã— |
| `generating_images` | `advance` â†’ awaiting_ready å®Œäº†ã‚’ç¢ºèª | **1å›ã® advance ã§ 1æšãšã¤ç”Ÿæˆ**ï¼ˆGemini API â†’ R2 upload â†’ DBæ›´æ–°ï¼‰ã€‚60ç§’è¶…ãˆã® generating ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ auto-failã€‚å¤±æ•—ã¯æœ€å¤§3å› auto-retry | `completed === total && noImage === 0 && generating === 0` | ã€Œç”»åƒç”Ÿæˆä¸­ (3/5)ã€ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ | ãªã—ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã®ãƒãƒ¼ãƒªãƒ³ã‚°ãŒåˆ¶å¾¡ï¼‰ |
| `generating_audio` | `advance` â†’ ç”»åƒå®Œäº†ã‚’ç¢ºèª + `waitUntil(marunageStartAudioGeneration)` | bulk-audio API ã‚’å‘¼ã³å‡ºã—ã€`project_audio_jobs` ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆã€‚advance ã¯ job status ã‚’ãƒãƒ¼ãƒªãƒ³ã‚° | `audioJob.status === 'completed'` | ã€ŒéŸ³å£°ç”Ÿæˆä¸­â€¦ã€ | ãªã—ï¼ˆ`transitionPhase` ãŒãƒ­ãƒƒã‚¯è§£é™¤ï¼‰ |
| `ready` | `transitionPhase(generating_audioâ†’ready)` | `completed_at` ã‚’è¨˜éŒ² | çµ‚ç«¯çŠ¶æ…‹ | **ã€ŒğŸ‰ ç´ æå®Œæˆï¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°ã‚’é–‹ãã€ãƒœã‚¿ãƒ³** | N/A |
| `failed` | ã„ãšã‚Œã® phase ã‹ã‚‰ã‚‚ã‚¨ãƒ©ãƒ¼æ™‚ | `error_code`/`error_message`/`error_phase` ã‚’è¨˜éŒ² | çµ‚ç«¯çŠ¶æ…‹ï¼ˆretry å¯èƒ½ï¼‰ | ã€Œã‚¨ãƒ©ãƒ¼: {message}ã€+ å†è©¦è¡Œãƒœã‚¿ãƒ³ | ãƒ­ãƒƒã‚¯è§£é™¤æ¸ˆã¿ |
| `canceled` | `POST /:projectId/cancel` | `locked_at/locked_until` ã‚’ã‚¯ãƒªã‚¢ã€‚audio_job ã‚‚ best-effort ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ« | çµ‚ç«¯çŠ¶æ…‹ | ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€ | ãƒ­ãƒƒã‚¯è§£é™¤æ¸ˆã¿ |

### 1.2 åˆ¶ä½œãƒœãƒ¼ãƒ‰ï¼ˆProduction Boardï¼‰

```
created â†’ uploaded â†’ [transcribing â†’ transcribed â†’] parsing â†’ parsed â†’ formatting â†’ formatted
                                                                                        â”‚
                                                              generating_images â†’ completed
```

| Phase | ãƒˆãƒªã‚¬ãƒ¼ | ã‚µãƒ¼ãƒãƒ¼å´ã®è²¬å‹™ | å®Œäº†åˆ¤å®š | æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆUIãƒœã‚¿ãƒ³ï¼‰ |
|-------|---------|-----------------|---------|---------------------|
| `created` | `POST /api/projects` | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ | å³åº§ | ã€Œãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã€orã€ŒéŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ |
| `uploaded` | ãƒ†ã‚­ã‚¹ãƒˆ/éŸ³å£°ä¿å­˜ | source_text ä¿å­˜ or R2 ã«éŸ³å£°ä¿å­˜ | å³åº§ | ã€Œã‚·ãƒ¼ãƒ³åˆ†å‰²ã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ |
| `transcribing` | `POST /api/projects/:id/transcribe` | Whisper API å‘¼ã³å‡ºã— | transcription å®Œäº† | è‡ªå‹•é·ç§» |
| `transcribed` | Whisper å®Œäº† | transcriptions ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ | å³åº§ | ã€Œã‚·ãƒ¼ãƒ³åˆ†å‰²ã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ |
| `formatting` | `POST /api/projects/:id/format` | chunk å˜ä½ã§ AI/preserve å‡¦ç† | å…¨ chunk ãŒ done | è‡ªå‹•ãƒãƒ¼ã‚¸ â†’ formatted |
| `formatted` | autoMergeScenes | ã‚·ãƒ¼ãƒ³ä¸€è¦§ç¢ºå®š | å³åº§ | ã€Œç”»åƒä¸€æ‹¬ç”Ÿæˆã€ãƒœã‚¿ãƒ³ |
| `generating_images` | `POST /api/projects/:id/generate-images` | ãƒãƒƒãƒç”»åƒç”Ÿæˆï¼ˆGemini APIï¼‰ | å…¨ã‚·ãƒ¼ãƒ³ completed | è‡ªå‹•é·ç§» â†’ completed |
| `completed` | å…¨ç”»åƒå®Œäº† | N/A | çµ‚ç«¯ | ã€Œå‹•ç”»ãƒ“ãƒ«ãƒ‰ã€ãƒœã‚¿ãƒ³ |

### 1.3 ãƒ•ãƒ­ãƒ¼åˆ†é›¢ã®ç¢ºèªçµæœ

| è¦³ç‚¹ | ä¸¸æŠ•ã’ãƒãƒ£ãƒƒãƒˆ | åˆ¶ä½œãƒœãƒ¼ãƒ‰ | åˆ†é›¢çŠ¶æ…‹ |
|------|-------------|-----------|---------|
| **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ** | ç‹¬è‡ªï¼ˆ`POST /api/marunage/:id/start`ï¼‰ | ç‹¬è‡ªï¼ˆ`POST /api/projects`ï¼‰ | âœ… å®Œå…¨åˆ†é›¢ |
| **Run ç®¡ç†** | `marunage_runs` ãƒ†ãƒ¼ãƒ–ãƒ« | ãªã— | âœ… å®Œå…¨åˆ†é›¢ |
| **Format API** | HTTP çµŒç”±ã§ `/api/projects/:id/format` ã‚’æ¶ˆè²» | ç›´æ¥ `POST /api/projects/:id/format` | âš ï¸ **å…±æœ‰**ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã¯ç‹¬ç«‹ï¼‰ |
| **Image ç”Ÿæˆ** | `advance` å†…ã§ç›´æ¥ Gemini API å‘¼ã³å‡ºã— | `/api/projects/:id/generate-images` ãƒãƒƒãƒ API | âœ… å®Ÿè³ªåˆ†é›¢ |
| **Audio ç”Ÿæˆ** | `waitUntil` + bulk-audio API | UIãƒãƒ¼ãƒªãƒ³ã‚° + å€‹åˆ¥ API | âš ï¸ **bulk-audio API ã‚’å…±æœ‰** |
| **DB ãƒ†ãƒ¼ãƒ–ãƒ«** | `projects`, `scenes`, `image_generations` ã‚’å…±æœ‰ | åŒå·¦ | âš ï¸ **å…±æœ‰**ï¼ˆ`project_id` ã§åˆ†é›¢ï¼‰ |

---

## 2. ãƒ­ãƒƒã‚¯è¨­è¨ˆè¡¨

### 2.1 ãƒ­ãƒƒã‚¯ã®ç›®çš„

`marunage_runs.locked_at` / `locked_until` ã¯ **äºŒé‡å®Ÿè¡Œé˜²æ­¢** ã‚’å”¯ä¸€ã®ç›®çš„ã¨ã™ã‚‹ã€‚

### 2.2 Phase åˆ¥ãƒ­ãƒƒã‚¯çŠ¶æ…‹

| Phase | ãƒ­ãƒƒã‚¯è¨­å®š | ãƒ­ãƒƒã‚¯æœŸé–“ | è§£é™¤ã‚¿ã‚¤ãƒŸãƒ³ã‚° | è§£é™¤è²¬å‹™ |
|-------|----------|----------|-------------|---------|
| `init` | ãªã— | â€” | â€” | â€” |
| `formatting` | ãªã— | â€” | â€” | formatLoop ã¯ `waitUntil` å†…ã§å®Œçµã€‚äºŒé‡èµ·å‹•ã¯ `phase` ãƒã‚§ãƒƒã‚¯ã§é˜²æ­¢ |
| `awaiting_ready` | ãªã— | â€” | â€” | advance ã¯å†ªç­‰ï¼ˆutterance ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰ |
| `generating_images` | **ãªã—**ï¼ˆv4f40a05 ã§å»ƒæ­¢ï¼‰ | â€” | â€” | advance ãŒ 1æšãšã¤åŒæœŸç”Ÿæˆã€‚ãƒ•ãƒ­ãƒ³ãƒˆã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ï¼ˆ10ç§’ï¼‰ãŒå®Ÿè³ªçš„ãªæ’ä»–åˆ¶å¾¡ |
| `generating_audio` | **è¨­å®šã•ã‚Œãªã„**ï¼ˆ`transitionPhase` ãŒ `generating_audio` ã¸é·ç§»æ™‚ã«ãƒ­ãƒƒã‚¯è§£é™¤ï¼‰ | â€” | é·ç§»æ™‚ã«ã‚¯ãƒªã‚¢ | `transitionPhase()` L133-136 |
| `ready` | **ã‚¯ãƒªã‚¢** | â€” | é·ç§»æ™‚ | `transitionPhase()` (TERMINAL_PHASES) |
| `failed` | **ã‚¯ãƒªã‚¢** | â€” | retry/cancel æ™‚ | `retry` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ L1920ã€`cancel` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ L1963 |
| `canceled` | **ã‚¯ãƒªã‚¢** | â€” | cancel æ™‚ | `cancel` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ L1963 |

### 2.3 ãƒ­ãƒƒã‚¯è§£é™¤ã®ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹

```
1. transitionPhase()          â€” TERMINAL_PHASES (ready/failed/canceled) + generating_audio é·ç§»æ™‚
2. POST /:projectId/retry     â€” failed â†’ rollback phase é·ç§»æ™‚ã« locked_at/locked_until = NULL
3. POST /:projectId/cancel    â€” ä»»æ„ã®éçµ‚ç«¯ phase â†’ canceled é·ç§»æ™‚ã« locked_at/locked_until = NULL
4. advance() Lock bypass      â€” generating_images: stuck æ¤œå‡ºæ™‚ï¼ˆnoImage > 0 && inProgress === 0ï¼‰
5. advance() Lock bypass      â€” generating_audio: å¸¸ã«ã‚¯ãƒªã‚¢ï¼ˆaudio polling è¨±å¯ï¼‰
```

### 2.4 æ­´å²çš„çµŒç·¯ã¨ç¾åœ¨ã®çŠ¶æ…‹

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | çŠ¶æ…‹ | èª¬æ˜ |
|-----------|------|------|
| v1 (åˆæœŸ) | å…¨ phase ã«ãƒ­ãƒƒã‚¯ | `transitionPhaseWithLock()` ã§ 10 åˆ†ãƒ­ãƒƒã‚¯ã‚’è¨­å®š |
| v2 (409 CONFLICT ãƒã‚°ä¿®æ­£) | generating_audio ã®ãƒ­ãƒƒã‚¯å»ƒæ­¢ | 10 åˆ†ãƒ­ãƒƒã‚¯ãŒ audio polling ã‚’é˜»å®³ã—ã¦ã„ãŸ |
| v3 (Issue-2 ä¿®æ­£) | generating_images ã®ãƒ­ãƒƒã‚¯å»ƒæ­¢ | 1 æšãšã¤åŒæœŸç”Ÿæˆã«å¤‰æ›´ã€waitUntil ä¸ä½¿ç”¨ |
| **v4 (ç¾åœ¨)** | **å…¨ phase ãƒ­ãƒƒã‚¯ãªã—** | `transitionPhaseWithLock()` ã¯å­˜åœ¨ã™ã‚‹ãŒå‘¼ã³å‡ºã—å…ƒãªã—ã€‚Dead code |

### 2.5 æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **`transitionPhaseWithLock()` ã‚’å‰Šé™¤** â€” Dead codeã€‚å‘¼ã³å‡ºã—ç®‡æ‰€ãªã—
2. **`locked_at`/`locked_until` ã‚«ãƒ©ãƒ ã¯ç¶­æŒ** â€” retry/cancel ã® NULL ã‚¯ãƒªã‚¢ã«ä½¿ç”¨ã€‚å°†æ¥ã®å®‰å…¨å¼
3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°** â€” ã€Œãƒ­ãƒƒã‚¯ã¯ä½¿ç”¨ã—ã¦ã„ãªã„ã€ã“ã¨ã‚’æ˜è¨˜

---

## 3. Preserve ãƒ¢ãƒ¼ãƒ‰ä»•æ§˜

### 3.1 æ¦‚è¦

preserve ãƒ¢ãƒ¼ãƒ‰ï¼ˆUIè¡¨ç¤ºå: ã€ŒåŸæ–‡ãã®ã¾ã¾ã€ã€ŒRawã€ï¼‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŸæ–‡ãƒ†ã‚­ã‚¹ãƒˆã‚’ **ä¸€åˆ‡æ”¹å¤‰ã›ãšã«** ã‚·ãƒ¼ãƒ³ã«åˆ†å‰²ã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã€‚

### 3.2 SSOTï¼ˆSingle Source of Truthï¼‰

```
+-------------------+     HTTP POST body      +-------------------+
| project-editor.js | â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º | formatting.ts     |
| (ãƒ•ãƒ­ãƒ³ãƒˆ)         |   split_mode            | (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰)     |
|                   |   target_scene_count    |                   |
+-------------------+                         +-------------------+
        â”‚                                             â”‚
        â”‚ UI: #targetSceneCount                       â”‚ Default:
        â”‚     input value                             â”‚   ai mode â†’ 5
        â”‚                                             â”‚   preserve mode â†’ æ®µè½æ•°
        â”‚                                             â”‚   (bodyTarget æœªæŒ‡å®šæ™‚)
        â”‚                                             â”‚
        â–¼                                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ scene_split_     â”‚  â˜… å‚ç…§ã•ã‚Œãªã„       â”‚ projects ãƒ†ãƒ¼ãƒ–ãƒ«     â”‚
  â”‚ settings ãƒ†ãƒ¼ãƒ–ãƒ« â”‚  ï¼ˆBæ¡ˆã§å»ƒæ­¢äºˆå®šï¼‰     â”‚   split_mode         â”‚
  â”‚   target_scene_  â”‚                      â”‚   target_scene_count â”‚
  â”‚   count          â”‚                      â”‚   ï¼ˆçµæœã‚’è¨˜éŒ²ï¼‰       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Bæ¡ˆï¼ˆæ¡ç”¨æ¸ˆã¿ï¼‰**: `/format` API ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãŒå”¯ä¸€ã®çœŸå®Ÿã€‚`scene_split_settings` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å‚ç…§ã—ãªã„ã€‚

### 3.3 åˆ†å‰²ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```
å…¥åŠ›: sourceText (åŸæ–‡), targetSceneCount (ç›®æ¨™ã‚·ãƒ¼ãƒ³æ•°)

1. æ”¹è¡Œæ­£è¦åŒ– (NBSP â†’ åŠè§’, CRLF â†’ LF)
2. ç©ºè¡Œ (\n\s*\n) ã§æ®µè½åˆ†å‰²
3. ç©ºæ®µè½ã‚’é™¤å»ã€å„æ®µè½ã‚’ trim()

4. if targetSceneCount === 0 (æœªæŒ‡å®šã‚»ãƒ³ãƒãƒãƒ«):
     targetSceneCount = paragraphs.length  // æ®µè½æ•°ã‚’è‡ªå‹•æ¡ç”¨

5. if paragraphs.length > targetSceneCount:
     mergeParagraphsPreserve()  // æ®µè½ã‚’çµåˆï¼ˆçœç•¥ãªã—ï¼‰
   elif paragraphs.length < targetSceneCount:
     splitParagraphsPreserve()  // æ–‡å¢ƒç•Œã§åˆ†å‰²ï¼ˆçœç•¥ãƒ»è¨€ã„æ›ãˆç¦æ­¢ï¼‰

6. æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯: 
     originalæ–‡å­—æ•° === å‡¦ç†å¾Œæ–‡å­—æ•° (ç©ºç™½é™¤å¤–)
     å¤±æ•—æ™‚: 400 PRESERVE_INTEGRITY_ERROR

7. å„æ®µè½ â†’ scene ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ (dialogue = åŸæ–‡ãã®ã¾ã¾)
```

### 3.4 æ®µè½çµåˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆmergeParagraphsPreserveï¼‰

```
ä¾‹: 8æ®µè½ â†’ 5ã‚·ãƒ¼ãƒ³
é…åˆ†: [2, 2, 2, 1, 1]

1. base = floor(8 / 5) = 1
2. extra = 8 % 5 = 3
3. å…ˆé ­ 3 ã‚°ãƒ«ãƒ¼ãƒ—ã¯ base+1 = 2 æ®µè½
4. æ®‹ã‚Š 2 ã‚°ãƒ«ãƒ¼ãƒ—ã¯ base = 1 æ®µè½
5. å„ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®æ®µè½ã‚’ \n\n ã§çµåˆ
```

### 3.5 æ®µè½åˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆsplitParagraphsPreserveï¼‰

```
ä¾‹: 3æ®µè½ â†’ 5ã‚·ãƒ¼ãƒ³
è¿½åŠ åˆ†å‰²: 5 - 3 = 2 å›

1. æœ€ã‚‚é•·ã„æ®µè½ã‚’é¸æŠ
2. æ–‡å¢ƒç•Œï¼ˆã€‚ï¼ï¼Ÿ.!?ï¼‰ã§åˆ†å‰²
3. 2å›ç¹°ã‚Šè¿”ã—
4. çœç•¥ãƒ»è¨€ã„æ›ãˆã¯ä¸€åˆ‡ç¦æ­¢
```

### 3.6 ã€Œ11æ®µè½â†’5ã‚·ãƒ¼ãƒ³ã€å•é¡Œã®åŸå› ã¨ä¿®æ­£

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ (v=4f40a05) |
|------|--------|-------------------|
| `formatting.ts` ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | `body.target_scene_count \|\| 5` â†’ å¸¸ã«5 | `bodyTarget` æœªæŒ‡å®š â†’ preserve ãƒ¢ãƒ¼ãƒ‰ã¯æ®µè½æ•°è‡ªå‹•æ¡ç”¨ï¼ˆã‚»ãƒ³ãƒãƒãƒ«0ï¼‰ |
| `project-editor.js` åˆæœŸå€¤ | `value="5"` ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ | `initialTarget = raw ? paragraphCount : (savedTarget \|\| 5)` |
| `project-editor.js` ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ | `onSplitModeChange` ã§ targetSceneCount å¤‰æ›´ãªã— | raw åˆ‡æ›¿æ™‚ã«æ®µè½æ•°ã‚’ input ã«è‡ªå‹•è¨­å®š |
| `/format` ãƒ¬ã‚¹ãƒãƒ³ã‚¹ | ä½¿ç”¨ã—ãŸ target å€¤ã‚’è¿”ã•ãªã„ | `received_target_scene_count` ã‚’è¿½åŠ  |

### 3.7 åŸæ–‡ä¸å¤‰ã‚¬ãƒ¼ãƒ‰

preserve ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä»¥ä¸‹ã®ã‚¬ãƒ¼ãƒ‰ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆ:

1. **dialogue ã¯ AI ã«æ¸¡ã•ãªã„** â€” `image_prompt` ç”Ÿæˆã®ã¿ AI ä½¿ç”¨
2. **dialogue ã‚’å†æ•´å½¢ã—ãªã„** â€” `trim()` ä»¥å¤–ã®æ–‡å­—åˆ—æ“ä½œç¦æ­¢
3. **å¥èª­ç‚¹ãƒ»æ”¹è¡Œã‚’ç¶­æŒ** â€” çµåˆæ™‚ã¯ `\n\n`
4. **æ–‡å­—æ•°æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯** â€” å‡¦ç†å‰å¾Œã®éç©ºç™½æ–‡å­—æ•°ãŒä¸€è‡´ã—ãªã„å ´åˆã¯ 400 ã‚¨ãƒ©ãƒ¼

---

## 4. SSOT æ±ºå®šè¨˜éŒ²ï¼ˆBæ¡ˆï¼‰

### 4.1 é¸æŠè‚¢

| æ¡ˆ | æ–¹é‡ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|----|------|---------|-----------|
| Aæ¡ˆ | `/format` ãŒ `scene_split_settings` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’èª­ã‚€ | è¨­å®šã®æ°¸ç¶šåŒ– | ãƒ†ãƒ¼ãƒ–ãƒ«åŒæœŸå•é¡Œã€è¤‡é›‘åŒ– |
| **Bæ¡ˆï¼ˆæ¡ç”¨ï¼‰** | **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãŒå”¯ä¸€ã®çœŸå®Ÿã€‚`scene_split_settings` ã¯å‚ç…§ã—ãªã„** | ã‚·ãƒ³ãƒ—ãƒ«ã€ãƒã‚°ä½æ¸› | è¨­å®šã®æ°¸ç¶šåŒ–ã¯åˆ¥é€” |

### 4.2 Bæ¡ˆã®å®Ÿè£…ãƒ«ãƒ¼ãƒ«

1. `formatting.ts` ã® `/format` API ã¯ `body.target_scene_count` ã¨ `body.split_mode` ã®ã¿ä½¿ç”¨
2. `scene_split_settings` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ UI ã®ã€Œæ¬¡å›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã€ä¿æŒç”¨ã«æ®‹ã™ï¼ˆå°†æ¥å‰Šé™¤å¯èƒ½ï¼‰ã€‚**å®Ÿè¡Œæ™‚ã¯çµ¶å¯¾ã«å‚ç…§ã—ãªã„**
3. `world-character-ui.js` ã®è¨­å®š UI ã¯ UI ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å¤‰æ›´ã™ã‚‹ã®ã¿ï¼ˆã‚³ãƒ¼ãƒ‰å†…ã«SSOTæ³¨æ„ã‚³ãƒ¡ãƒ³ãƒˆæ˜è¨˜æ¸ˆã¿ï¼‰
4. å®Ÿè¡Œæ™‚ã«ä½¿ç”¨ã•ã‚ŒãŸå€¤ã¯ `/format` ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® `received_target_scene_count` ã§ç¢ºèªå¯èƒ½
5. preserve ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« `detected_paragraph_count`ï¼ˆã‚µãƒ¼ãƒãƒ¼å´æ®µè½æ¤œå‡ºæ•°ï¼‰ã‚’è¿½åŠ 
6. AI ãƒ¢ãƒ¼ãƒ‰ï¼ˆ`autoMergeScenes`ï¼‰ã§ã‚‚ `received_target_scene_count` ã‚’çµ±ä¸€è¿”å´
7. å…¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« `received_target_scene_count` ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€UI ã¯åˆ†å²ä¸è¦

### 4.4 ç›£æŸ»ãƒ­ã‚°ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰

`/format` API ã®å†’é ­ã§ä»¥ä¸‹ã‚’ `console.log` å‡ºåŠ›ï¼ˆCloudflare Workers ãƒ­ã‚°ï¼‰:

```
[Format:AUDIT] project=238, mode=preserve, target=0, bodyTarget=NOT_SET, explicitlySet=false, reset=true
[Format:AUDIT:Preserve] project=238, paragraphCount=11, target=11, explicitlySet=false
```

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ |
|-----------|------|
| `mode` | split_modeï¼ˆai / preserveï¼‰ |
| `target` | å®Ÿéš›ã«ä½¿ç”¨ã™ã‚‹ targetSceneCountï¼ˆ0 ã¯ã‚»ãƒ³ãƒãƒãƒ«â†’æ®µè½æ•°ã«ç½®æ›ã•ã‚Œã‚‹ï¼‰ |
| `bodyTarget` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ç”Ÿå€¤ï¼ˆ`NOT_SET` = æœªé€ä¿¡ï¼‰ |
| `explicitlySet` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã« target ã‚’æŒ‡å®šã—ãŸã‹ |
| `paragraphCount` | preserve ãƒ¢ãƒ¼ãƒ‰ã®ã¿ã€‚ã‚µãƒ¼ãƒãƒ¼ãŒæ¤œå‡ºã—ãŸæ®µè½æ•° |

### 4.5 UI å¯è¦–åŒ–

| UIè¦ç´  | å ´æ‰€ | ç›®çš„ |
|--------|------|------|
| **å®Ÿè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼** | å®Ÿè¡Œãƒœã‚¿ãƒ³ç›´ä¸Š | ã€Œä»Šå›ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹å€¤ã€ã‚’å›ºå®šè¡¨ç¤ºï¼ˆsplit_mode + target_scene_countï¼‰ |
| **æˆåŠŸToast** | formatå®Œäº†æ™‚ | `received_target_scene_count` ã‚’ãƒˆãƒ¼ã‚¹ãƒˆå†…ã«è¡¨ç¤º |
| **æ®µè½æ•°è¡¨ç¤º** | targetSceneCountå…¥åŠ›æ¨ª | UIã®æ®µè½ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼å´ã®ä¸ä¸€è‡´ã‚’å³ç™ºè¦‹å¯èƒ½ã« |

---

## 4ï¼ˆç¶šãï¼‰. ä¸¸æŠ•ã’ãƒãƒ£ãƒƒãƒˆã¸ã®å½±éŸ¿

- **å½±éŸ¿ãªã—**: `marunage.ts` ã¯å¸¸ã« `config.target_scene_count`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5ï¼‰ã‚’æ˜ç¤ºé€ä¿¡
- `bodyTargetSceneCount` ãŒ number ã‹ã¤ > 0 â†’ ã‚»ãƒ³ãƒãƒãƒ«0ã«ãªã‚‰ãªã„
- æ—¢å­˜å‹•ä½œã¨å®Œå…¨ã«åŒä¸€

---

## 5. ã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆ åˆ†é¡è¡¨

`npm run check:schema` ã§æ¤œå‡ºã•ã‚ŒãŸ 18 ä»¶ï¼ˆã†ã¡ MISSING_COLUMN 11 ä»¶ï¼‰ã®åˆ†é¡:

### 5.1 å½±éŸ¿åº¦åˆ¥åˆ†é¡

| # | ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ãƒ¼ãƒ–ãƒ«.ã‚«ãƒ©ãƒ  | ç¨®åˆ¥ | ä¸¸æŠ•ã’å½±éŸ¿ | åˆ¶ä½œãƒœãƒ¼ãƒ‰å½±éŸ¿ | å¯¾å‡¦æ–¹é‡ |
|---|---------|---------------|------|----------|-------------|---------|
| 1 | admin.ts | `api_usage_logs.operation` | MISSING_COLUMN | âŒ ãªã— | âŒ ãªã—ï¼ˆç®¡ç†ç”»é¢ã®ã¿ï¼‰ | migration è¿½åŠ  or ã‚³ãƒ¼ãƒ‰å‰Šé™¤ |
| 2 | patches.ts | `project_audio_tracks.track_url` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä½ï¼ˆãƒ‘ãƒƒãƒé©ç”¨æ™‚ï¼‰ | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆr2_url ã«çµ±ä¸€æ¸ˆã¿ï¼‰ |
| 3 | patches.ts | `project_audio_tracks.original_filename` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä½ | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆä¸è¦ã‚«ãƒ©ãƒ ï¼‰ |
| 4 | patches.ts | `project_audio_tracks.source_type` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä½ | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆaudio_library_type ã«çµ±ä¸€æ¸ˆã¿ï¼‰ |
| 5 | patches.ts | `scene_audio_cues.audio_url` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä½ | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆr2_url ã«çµ±ä¸€æ¸ˆã¿ï¼‰ |
| 6 | patches.ts | `scene_audio_cues.original_filename` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä½ | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ |
| 7 | patches.ts | `scene_audio_cues.trigger_type` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä½ | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ |
| 8 | patches.ts | `scene_audio_cues.source_type` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä½ | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ |
| 9 | patches.ts | `scene_audio_cues.system_audio_id` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä½ | migration è¿½åŠ  |
| 10 | runs-v2.ts | `text_chunks.length` | MISSING_COLUMN | âŒ ãªã— | âš ï¸ ä¸­ï¼ˆruns v2ï¼‰ | `.length` ã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‚ç…§ã®èª¤æ¤œå‡ºã®å¯èƒ½æ€§ã‚ã‚Šã€‚è¦ç¢ºèª |
| 11 | webhooks.ts | `api_usage_logs.operation` | MISSING_COLUMN | âŒ ãªã— | âŒ ãªã—ï¼ˆwebhook ã®ã¿ï¼‰ | #1 ã¨åŒä¸€ã€‚migration è¿½åŠ  or ã‚³ãƒ¼ãƒ‰å‰Šé™¤ |
| 12-18 | projects.ts, scenes.ts | `utterances`, `scene_characters` | UNKNOWN_TABLE | âŒ ãªã— | âš ï¸ ä½ | ãƒ†ãƒ¼ãƒ–ãƒ«åã®åˆ¥å or å­˜åœ¨ã™ã‚‹ãŒæ¤œå‡ºæ¼ã‚Œã€‚WARNING ã®ã¿ |

### 5.2 CI ã‚²ãƒ¼ãƒˆæ®µéšå°å…¥è¨ˆç”»

| ãƒ•ã‚§ãƒ¼ã‚º | å¯¾è±¡ | ã‚²ãƒ¼ãƒˆæ¡ä»¶ | æ™‚æœŸ |
|---------|------|----------|------|
| Phase 1 | `src/routes/marunage.ts` ã®ã¿ | MISSING_COLUMN = 0 | å³åº§ |
| Phase 2 | `src/routes/formatting.ts`, `src/routes/scenes.ts` | MISSING_COLUMN = 0 | P0 å®Œäº†å¾Œ |
| Phase 3 | å…¨ `src/routes/*.ts` | MISSING_COLUMN = 0 | ã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆä¿®æ­£å¾Œ |
| Phase 4 | å…¨ãƒ•ã‚¡ã‚¤ãƒ« + UNKNOWN_TABLE | å…¨ issue = 0 | é•·æœŸç›®æ¨™ |

### 5.3 å³åº§ã«ä¿®æ­£å¯èƒ½ãªä¸æ•´åˆ

- **patches.ts**: 6 ä»¶ã™ã¹ã¦æ—§ã‚«ãƒ©ãƒ åã®å‚ç…§ã€‚patches.ts ã¯ DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãªã®ã§ã€æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³å‘ã‘ãƒ‘ãƒƒãƒã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤å¯èƒ½
- **admin.ts + webhooks.ts**: `api_usage_logs.operation` â†’ migration ã§ `operation TEXT` ã‚’è¿½åŠ ã™ã‚‹ã‹ã€ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‚ç…§ã‚’å‰Šé™¤

---

## 6. AI é§†å‹•é–‹ç™ºç”¨ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### 6.1 ç›®çš„

AIï¼ˆCopilot / Claude / GPTï¼‰ãŒã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆãƒ»ä¿®æ­£ã™ã‚‹éš›ã«ã€å“è³ªä½ä¸‹ã‚’é˜²ããŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‚

### 6.2 SQL æ•´åˆæ€§

1. **INSERT/UPDATE ã®å¯¾è±¡ã‚«ãƒ©ãƒ ãŒ DB ã‚¹ã‚­ãƒ¼ãƒã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª**
2. **SELECT ã®å‚ç…§ã‚«ãƒ©ãƒ ãŒå®Ÿãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª**
3. **JOIN æ¡ä»¶ã®ã‚«ãƒ©ãƒ ãŒä¸¡ãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª**
4. **`npm run check:schema` ã‚’å®Ÿè¡Œã—ã¦ MISSING_COLUMN = 0 ã‚’ç¢ºèª**
5. **æ–°ãƒ†ãƒ¼ãƒ–ãƒ«/ã‚«ãƒ©ãƒ è¿½åŠ æ™‚ã¯ migration ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«ä½œæˆ**

### 6.3 SSOT éµå®ˆ

6. **åŒä¸€ãƒ‡ãƒ¼ã‚¿ã®çœŸå®Ÿã¯ 1 ç®‡æ‰€ã®ã¿**ï¼ˆä¾‹: `target_scene_count` ã¯ `/format` ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ã¿ï¼‰
7. **UI ã®è¡¨ç¤ºå€¤ã¨ API ã®é€ä¿¡å€¤ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª**
8. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã¯ 1 ç®‡æ‰€ã®ã¿**ï¼ˆå‹å®šç¾© or å®šæ•°ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
9. **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã€Œã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿéš›ã«ä½¿ç”¨ã—ãŸå€¤ã€ã‚’å«ã‚ã‚‹**

### 6.4 Phase é·ç§»ã®å®‰å…¨æ€§

10. **`ALLOWED_TRANSITIONS` ãƒãƒƒãƒ—ã«å®šç¾©ã•ã‚ŒãŸé·ç§»ã®ã¿è¨±å¯**
11. **çµ‚ç«¯çŠ¶æ…‹ï¼ˆready/failed/canceledï¼‰ã‹ã‚‰ã®é·ç§»ã¯ retry/cancel ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿**
12. **ãƒ­ãƒƒã‚¯è§£é™¤å¿˜ã‚ŒãŒãªã„ã‹ç¢ºèªï¼ˆç‰¹ã« error ãƒ‘ã‚¹ï¼‰**
13. **`transitionPhase()` ã®æˆ»ã‚Šå€¤ï¼ˆbooleanï¼‰ã‚’å¿…ãšãƒã‚§ãƒƒã‚¯**

### 6.5 åŸæ–‡ä¿å…¨ã‚¬ãƒ¼ãƒ‰ï¼ˆPreserve ãƒ¢ãƒ¼ãƒ‰ï¼‰

14. **dialogue ã‚’ AI ã«æ¸¡ã•ãªã„**
15. **æ–‡å­—åˆ—æ“ä½œã¯ `trim()` ã®ã¿**
16. **å‡¦ç†å‰å¾Œã®æ–‡å­—æ•°æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’çœç•¥ã—ãªã„**
17. **`normalizeWhitespace()` ã¯ç©ºç™½ã®ç¨®é¡çµ±ä¸€ã®ã¿ã€‚å†…å®¹å¤‰æ›´ç¦æ­¢**

### 6.6 ãƒ•ãƒ­ãƒ¼åˆ†é›¢

18. **ä¸¸æŠ•ã’ãƒãƒ£ãƒƒãƒˆã®ã‚³ãƒ¼ãƒ‰ãŒåˆ¶ä½œãƒœãƒ¼ãƒ‰ã«å½±éŸ¿ã—ãªã„ã“ã¨ã‚’ç¢ºèª**
19. **å…±æœ‰ APIï¼ˆ`/format`, bulk-audioï¼‰ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ä¸¡ãƒ•ãƒ­ãƒ¼ã§ãƒ†ã‚¹ãƒˆ**
20. **`marunage_runs` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ ã‚’ä»–ã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰å‚ç…§ã—ãªã„**

### 6.7 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

21. **CDN ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆTailwind ç­‰ï¼‰éä¾å­˜ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ CSS ã‚’ç”¨æ„**
22. **`onerror` ãƒãƒ³ãƒ‰ãƒ©ã§ç”»åƒ/éŸ³å£°ã®èª­è¾¼å¤±æ•—ã‚’å‡¦ç†**
23. **ãƒãƒ¼ãƒªãƒ³ã‚°ã«ã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10 åˆ†ï¼‰ã‚’è¨­å®š**
24. **ã‚°ãƒ­ãƒ¼ãƒãƒ«å‡¦ç†ä¸­ã¯ã™ã¹ã¦ã®å€‹åˆ¥ãƒœã‚¿ãƒ³ã‚’ disabled åŒ–**

### 6.8 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

25. **API ã‚­ãƒ¼ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«éœ²å‡ºã—ãªã„**
26. **ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã‚’å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å®Ÿæ–½**
27. **ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å†…éƒ¨æƒ…å ±ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ç­‰ï¼‰ã‚’å«ã‚ãªã„**
28. **SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³é˜²æ­¢: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‰ã‚’å¿…ãšä½¿ç”¨**

---

## 7. å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å†…å®¹ |
|------|------|
| 2026-02-13 | åˆç‰ˆä½œæˆï¼ˆP1-4 phase è²¬å‹™è¡¨ã€P1-5 ãƒ­ãƒƒã‚¯è¨­è¨ˆè¡¨ã€P2-7 preserve ãƒ¢ãƒ¼ãƒ‰ä»•æ§˜ã‚’çµ±åˆï¼‰ |
| 2026-02-13 | SSOT B æ¡ˆæ±ºå®šè¨˜éŒ²ã€ã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆåˆ†é¡ã€AI é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³è¿½åŠ  |
| 2026-02-13 | Â§8 ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ç§»è¡Œè¨˜éŒ²ã€Â§9 formatting.ts è²¬å‹™åˆ†å‰²ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã€Â§10 CI ã‚²ãƒ¼ãƒˆæ­£å¼ãƒãƒªã‚·ãƒ¼ã€Â§11 execution_context ãƒ­ã‚°ä»•æ§˜ è¿½åŠ  |

---

## 8. ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ç§»è¡Œè¨˜éŒ²

### 8.1 ãƒ¢ãƒ‡ãƒ«å¯¾å¿œè¡¨ï¼ˆ2026-02-13 æ›´æ–°ï¼‰

| å•†å“å | API ãƒ¢ãƒ‡ãƒ«å | ç‰¹å¾´ | é€Ÿåº¦ | å“è³ª |
|--------|-------------|------|------|------|
| **Nano Banana** | `gemini-2.5-flash-image` | Flash-tierã€é«˜é€Ÿã€å®‰å®š | é€Ÿã„ï¼ˆ~5s/æšï¼‰ | â—‹ è‰¯å¥½ |
| **Nano Banana Pro** | `gemini-3-pro-image-preview` | Thinkingæ­è¼‰ã€4Kå¯¾å¿œã€é«˜å¿ å®Ÿãƒ†ã‚­ã‚¹ãƒˆ | é…ã„ï¼ˆ~19s/æšï¼‰ | â— æœ€é«˜ |

### 8.2 ç§»è¡Œå†…å®¹

| é …ç›® | å¤‰æ›´å‰ | å¤‰æ›´å¾Œ |
|------|--------|--------|
| **marunage.ts** `GEMINI_MODEL` | `gemini-2.5-flash-image` | `gemini-3-pro-image-preview` |
| **image-generation.ts** ãƒ¢ãƒ‡ãƒ« | `gemini-3-pro-image-preview` | **å¤‰æ›´ãªã—**ï¼ˆæ—¢ã« Proï¼‰ |
| `responseModalities` | `['Image']` | `['TEXT', 'IMAGE']` |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ1å›ã‚ãŸã‚Šï¼‰ | 25ç§’ | 45ç§’ |
| ç”»åƒé–“ãƒ‡ã‚£ãƒ¬ã‚¤ | 3000ms | 5000ms |
| ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | `TIMEOUT_25s` | `TIMEOUT_45s: Gemini API (Nano Banana Pro)` |

### 8.3 REST ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
POST https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent
Header: x-goog-api-key: {API_KEY}
Body: {
  "contents": [{ "parts": [{ "text": "..." }] }],
  "generationConfig": {
    "responseModalities": ["TEXT", "IMAGE"],
    "imageConfig": { "aspectRatio": "16:9" }
  }
}
```

### 8.4 æ³¨æ„äº‹é …

- Pro ãƒ¢ãƒ‡ãƒ«ã¯ã€ŒThinkingã€ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« TEXT ãƒ‘ãƒ¼ãƒˆï¼ˆæ€è€ƒéç¨‹ï¼‰ãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚‹
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‘ãƒ¼ã‚µãƒ¼ã¯ `inlineData` ã‚’æŒã¤ part ã®ã¿ã‚’ç”»åƒã¨ã—ã¦å–å¾—ï¼ˆTEXT part ã¯ç„¡è¦–ï¼‰
- `gemini-2.5-flash-image-preview` ã¯ **2026-01-16 ã«å»ƒæ­¢æ¸ˆã¿**ï¼ˆ`gemini-2.5-flash-image` stable ã¯æœ‰åŠ¹ï¼‰

---

## 9. formatting.ts è²¬å‹™åˆ†å‰²ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### 9.1 ç¾åœ¨ã®çŠ¶æ…‹

`formatting.ts`ï¼ˆ~76KBï¼‰ã¯ä»¥ä¸‹ã® 5 ã¤ã®è²¬å‹™ã‚’ 1 ãƒ•ã‚¡ã‚¤ãƒ«ã«æŒã¤:

| # | è²¬å‹™ | é–¢æ•°/å‡¦ç† | è¡Œæ•°ï¼ˆæ¦‚ç®—ï¼‰ |
|---|------|----------|------------|
| 1 | **Preserve Engine** | `processPreserveMode()`, `mergeParagraphsPreserve()`, `splitParagraphsPreserve()`, æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ | ~300è¡Œ |
| 2 | **AI Split Engine** | `processTextChunks()`, OpenAI API å‘¼ã³å‡ºã—ã€JSON ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | ~400è¡Œ |
| 3 | **Merge Engine** | `autoMergeScenes()`, idxæ­£è¦åŒ–ã€roleè¨­å®šã€ã‚­ãƒ£ãƒ©è‡ªå‹•å‰²ã‚Šå½“ã¦ã€utteranceç”Ÿæˆ | ~200è¡Œ |
| 4 | **Integrity Guard** | `checkRawIntegrity()`, ç©ºç™½æ­£è¦åŒ–ã€æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ | ~100è¡Œï¼ˆä¸€éƒ¨ utils/split-mode-ssot.ts ã«ç§»å‹•æ¸ˆã¿ï¼‰ |
| 5 | **Scene Persistence** | DB INSERT/UPDATEã€chunkç®¡ç†ã€statusæ›´æ–° | ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã«åˆ†æ•£ |

### 9.2 ç›®æ¨™æ§‹é€ ï¼ˆPhaseåˆ¥ï¼‰

```
src/
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ formatting.ts          â† ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã¿ï¼ˆè–„ã„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼‰
â”œâ”€â”€ engines/
â”‚   â”œâ”€â”€ preserve-engine.ts     â† â‘ 
â”‚   â”œâ”€â”€ ai-split-engine.ts     â† â‘¡
â”‚   â””â”€â”€ merge-engine.ts        â† â‘¢
â”œâ”€â”€ guards/
â”‚   â””â”€â”€ integrity-guard.ts     â† â‘£ï¼ˆæ—¢å­˜ utils/split-mode-ssot.ts ã‚’æ‹¡å¼µï¼‰
â””â”€â”€ repositories/
    â””â”€â”€ scene-persistence.ts   â† â‘¤
```

### 9.3 ç§»è¡Œãƒ•ã‚§ãƒ¼ã‚º

| ãƒ•ã‚§ãƒ¼ã‚º | å¯¾è±¡ | ãƒªã‚¹ã‚¯ | å‰ææ¡ä»¶ |
|---------|------|--------|---------|
| Phase A | `integrity-guard.ts` æŠ½å‡º | ä½ï¼ˆç´”é–¢æ•°ï¼‰ | ãªã— |
| Phase B | `preserve-engine.ts` æŠ½å‡º | ä½ï¼ˆDBä¾å­˜å°‘ãªã„ï¼‰ | Phase A å®Œäº† |
| Phase C | `ai-split-engine.ts` æŠ½å‡º | ä¸­ï¼ˆOpenAI APIä¾å­˜ï¼‰ | ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è¿½åŠ  |
| Phase D | `merge-engine.ts` æŠ½å‡º | ä¸­ï¼ˆå‰¯ä½œç”¨å¤šã„ï¼‰ | Phase B, C å®Œäº† |
| Phase E | `scene-persistence.ts` æŠ½å‡º | é«˜ï¼ˆå…¨ä½“ã«åˆ†æ•£ï¼‰ | Phase A-D å®Œäº† |

### 9.4 ç¾æ™‚ç‚¹ã§ã®æ–¹é‡

- **å³åº§ã®åˆ†å‰²ã¯è¡Œã‚ãªã„** â€” ç¾åœ¨ã®å®‰å®šå‹•ä½œã‚’å„ªå…ˆ
- Phase A, B ã¯ä½ãƒªã‚¹ã‚¯ãªã®ã§ã€æ¬¡ã®å¤§ããªæ©Ÿèƒ½è¿½åŠ æ™‚ã«ä¸¦è¡Œã—ã¦å®Ÿæ–½
- å„ engine ã¯**pure function ä¸­å¿ƒ**ã«è¨­è¨ˆã—ã€ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã‚’ç¢ºä¿

---

## 10. CI ã‚²ãƒ¼ãƒˆæ­£å¼ãƒãƒªã‚·ãƒ¼

### 10.1 ã‚²ãƒ¼ãƒˆæ–¹é‡

**åŸå‰‡**: `MISSING_COLUMN` ãŒæ¤œå‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ï¼ˆæ®µéšå°å…¥ï¼‰

### 10.2 æ®µéšå°å…¥ãƒ†ãƒ¼ãƒ–ãƒ«

| Phase | å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ« | ã‚²ãƒ¼ãƒˆæ¡ä»¶ | å®Ÿæ–½æ™‚æœŸ | çŠ¶æ…‹ |
|-------|------------|----------|---------|------|
| **Phase 1** | `marunage.ts` | `MISSING_COLUMN = 0` | å³åº§ | âœ… 0ä»¶ï¼ˆã‚²ãƒ¼ãƒˆå¯èƒ½ï¼‰ |
| **Phase 2** | `formatting.ts`, `scenes.ts` | `MISSING_COLUMN = 0` | P0å®Œäº†å¾Œ | â³ è¦ç¢ºèª |
| **Phase 3** | å…¨ `src/routes/*.ts` | `MISSING_COLUMN = 0` | ã‚¹ã‚­ãƒ¼ãƒä¿®æ­£å¾Œ | â³ |
| **Phase 4** | å…¨ãƒ•ã‚¡ã‚¤ãƒ« + `UNKNOWN_TABLE` | å…¨ issue = 0 | é•·æœŸç›®æ¨™ | â³ |

### 10.3 Warning ãƒ¬ãƒ™ãƒ«å®šç¾©

| ãƒ¬ãƒ™ãƒ« | åŸºæº– | å¯¾å¿œ |
|--------|------|------|
| ğŸ”´ **BLOCK** | Phase å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã§ MISSING_COLUMN > 0 | ãƒ‡ãƒ—ãƒ­ã‚¤ä¸å¯ã€‚ä¿®æ­£å¿…é ˆ |
| ğŸŸ¡ **WARN** | Phase å¯¾è±¡å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã§ MISSING_COLUMN > 0 | ãƒ­ã‚°å‡ºåŠ›ã®ã¿ã€‚ä¿®æ­£æ¨å¥¨ |
| ğŸŸ¢ **INFO** | `UNKNOWN_TABLE` | ãƒ­ã‚°å‡ºåŠ›ã®ã¿ã€‚Phase 4 ã§å¯¾å¿œ |

### 10.4 CI ã‚¹ã‚¯ãƒªãƒ—ãƒˆä»•æ§˜ï¼ˆ`npm run check:schema`ï¼‰

```bash
# Exit code:
#   0 = No issues in gated files
#   1 = MISSING_COLUMN found in gated files (BLOCK)
#
# Output format:
#   [BLOCK] marunage.ts:L42 â€” MISSING_COLUMN: api_usage_logs.operation
#   [WARN]  patches.ts:L128 â€” MISSING_COLUMN: project_audio_tracks.track_url
#   [INFO]  projects.ts:L345 â€” UNKNOWN_TABLE: utterances
```

### 10.5 ä¸æ•´åˆä¿®æ­£ã®å„ªå…ˆé †ä½

1. **patches.ts ã® 6 ä»¶**: æ—§ã‚«ãƒ©ãƒ åå‚ç…§ â†’ ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆæ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”¨ãƒ‘ãƒƒãƒã¯ä¸è¦ï¼‰
2. **admin.ts + webhooks.ts**: `api_usage_logs.operation` â†’ migration è¿½åŠ  or ã‚³ãƒ¼ãƒ‰å‰Šé™¤
3. **runs-v2.ts**: `text_chunks.length` â†’ `.length` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£èª¤æ¤œå‡ºã®å¯èƒ½æ€§ã‚ã‚Šã€‚æ‰‹å‹•ç¢ºèª
4. **projects.ts, scenes.ts**: `utterances`, `scene_characters` â†’ UNKNOWN_TABLEï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèªï¼‰

---

## 11. execution_context ãƒ­ã‚°ä»•æ§˜

### 11.1 ç›®çš„

`/format` API ãŒ **åˆ¶ä½œãƒœãƒ¼ãƒ‰ï¼ˆbuilderï¼‰** ã¨ **ä¸¸æŠ•ã’ãƒãƒ£ãƒƒãƒˆï¼ˆmarunageï¼‰** ã®ä¸¡æ–¹ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ãŸã‚ã€ãƒ­ã‚°ã§å‘¼ã³å‡ºã—å…ƒã‚’æ˜ç¢ºã«åŒºåˆ¥ã™ã‚‹ã€‚

### 11.2 å®Ÿè£…æ–¹å¼

| è¦ç´  | è©³ç´° |
|------|------|
| **è­˜åˆ¥æ–¹æ³•** | HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ `X-Execution-Context: marunage` |
| **é€ä¿¡å…ƒ** | `marunage.ts` ã® `startFormatLoop()` å†…ã® `fetch()` å‘¼ã³å‡ºã— |
| **å—ä¿¡å´** | `formatting.ts` ã® `/format` ãƒãƒ³ãƒ‰ãƒ©å†’é ­ã§ `c.req.header('X-Execution-Context')` ã‚’èª­ã¿å–ã‚Š |
| **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ** | ãƒ˜ãƒƒãƒ€ãƒ¼ãªã— â†’ `'builder'` |
| **ãƒ­ã‚°å‡ºåŠ›** | `[Format:AUDIT]` ã¨ `[Format:AUDIT:Preserve]` ã®ä¸¡æ–¹ã« `context=` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ  |

### 11.3 ãƒ­ã‚°å‡ºåŠ›ä¾‹

```
[Format:AUDIT] project=238, context=builder, mode=preserve, target=0, bodyTarget=NOT_SET, explicitlySet=false, reset=true
[Format:AUDIT] project=239, context=marunage, mode=ai, target=5, bodyTarget=5, explicitlySet=true, reset=false
[Format:AUDIT:Preserve] project=238, context=builder, paragraphCount=11, target=11, explicitlySet=false
```

### 11.4 æ´»ç”¨ã‚·ãƒŠãƒªã‚ª

- **ãƒã‚°èª¿æŸ»**: ã€Œ11â†’5å•é¡Œã€ã®ã‚ˆã†ãª SSOT ã‚ºãƒ¬ã‚’ context ã§å³åº§ã«ç‰¹å®š
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ**: builder vs marunage ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†æ™‚é–“ã‚’æ¯”è¼ƒ
- **å°†æ¥ã®ãƒ•ãƒ­ãƒ¼åˆ†é›¢**: context ã«å¿œã˜ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¤‰æ›´ã™ã‚‹åŸºç›¤
