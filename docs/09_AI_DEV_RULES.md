# AI開発ルール

## 🎯 最優先事項

**「前提条件を壊さず、矛盾を作らないこと」**

"それっぽく良くする"判断は**禁止**します。

---

## ✅ 必須ルール（毎回厳守）

### 1. 実装前の必読
- ✅ 本ファイル（09_AI_DEV_RULES.md）を読むこと
- ✅ 関連ドキュメントを必ず確認すること
  - 04_DB_SCHEMA.md（データの真実）
  - 05_API_SPEC.md（通信の真実）
  - 02_ARCHITECTURE.md（外部API固定表）

### 2. 仕様変更時の手順
- ✅ **必ず先に** 08_CHANGELOG.md を更新すること
- ✅ 影響範囲を明示すること（UI / API / DB / Worker / Storage）
- ✅ 関連ドキュメントを更新すること

### 3. 実装前の出力
各作業開始時、必ず以下の順で出力せよ：

```
1. 今回やること（箇条書き）
2. 影響範囲（UI / API / DB / Worker / Storage）
3. 更新する docs ファイル一覧
4. 実装方針
5. 実装内容（ファイル単位）
```

### 4. ドキュメント更新義務
- ✅ **docs更新なしでコード変更をしてはいけない**
- ✅ コードとドキュメントは必ず同期させる

---

## ❌ 禁止事項

### 1. 外部API関連
- ❌ 外部APIを勝手に追加・変更すること
- ❌ 固定表（02_ARCHITECTURE.md）に記載されていないAPIを使うこと
- ❌ モデル名を独自判断で変更すること

### 2. データ構造関連
- ❌ APIレスポンスやDBスキーマを暗黙に変更すること
- ❌ JSON構造を勝手に拡張すること
- ❌ バリデーションルールを無視すること

### 3. 仕様解釈関連
- ❌ docsに書かれていない仕様を独自解釈で実装すること
- ❌ "おそらくこうだろう"という推測で実装すること
- ❌ ユーザーへの確認なしに仕様を拡張すること

### 4. ドキュメント作成関連（追加）
- ❌ **placeholder/簡易版でdocsを作成すること**
- ❌ **"..."で省略してdocsを作成すること**
- ❌ **"後で埋める"でdocsを作成すること**
- ❌ **docsを消失させる運用（rm -rf）をすること**

### 5. APIキー・機密情報管理（追加）
- ❌ **実APIキーをAIチャットやGitコミットに含めること**
- ❌ **実APIキーをコード内にハードコーディングすること**
- ✅ **ローカル開発:** `.dev.vars` に実キーを保存（`.gitignore` 必須）
- ✅ **本番環境:** Cloudflare Secrets (`wrangler secret put`) で管理
- ✅ **ドキュメント:** `your-api-key-here` などのプレースホルダーを使用
- ❌ **`.dev.vars` をGitに追加しないこと**（`.gitignore` で除外済み）

---

## 🔍 判断基準

### 実装してよい場合
✅ docsに明記されている仕様
✅ 既存の設計方針に沿った実装
✅ 影響範囲が明確で、docs更新済み

### 実装を止めるべき場合
❌ docsに記載がない
❌ 既存仕様と矛盾する可能性がある
❌ 判断が分かれる点がある

**→ 実装せず、docsに「決め」を追加してから進むこと**

---

## 📋 作業フロー

### 標準フロー
```
1. ユーザー指示受領
   ↓
2. 関連ドキュメント確認
   ↓
3. 影響範囲特定
   ↓
4. 仕様変更の有無確認
   - 変更あり → 08_CHANGELOG.md 更新
   - 変更なし → 次へ
   ↓
5. 実装計画出力
   ↓
6. ユーザー承認待ち
   ↓
7. 実装実行（コード + docs同時更新）
   ↓
8. 動作確認
   ↓
9. 完了報告
```

---

## 🎯 フェーズ別チェックリスト

### Phase 1: アップロード
- [ ] 04_DB_SCHEMA.md の projects テーブル仕様確認
- [ ] 05_API_SPEC.md の POST /api/projects 仕様確認
- [ ] 02_ARCHITECTURE.md の R2設定確認
- [ ] 07_WORKFLOWS.md のアップロードフロー確認

### Phase 2: 文字起こし
- [ ] 02_ARCHITECTURE.md の OpenAI Whisper 仕様確認
- [ ] 04_DB_SCHEMA.md の transcriptions テーブル確認
- [ ] 05_API_SPEC.md の /transcribe 仕様確認

### Phase 3: 整形・分割
- [ ] 03_DOMAIN_MODEL.md の JSON Schema 確認
- [ ] 04_DB_SCHEMA.md の scenes テーブル確認
- [ ] 07_WORKFLOWS.md のバリデーション確認

### Phase 4: 画像生成
- [ ] 02_ARCHITECTURE.md の Gemini 仕様確認
- [ ] 12_IMAGE_PROMPT_TEMPLATE.md 確認
- [ ] 04_DB_SCHEMA.md の image_generations 確認

---

## ✅ 完了基準

### 各タスク完了時
- ✅ コード実装完了
- ✅ 関連docs更新完了
- ✅ 08_CHANGELOG.md 更新（仕様変更時）
- ✅ 動作確認完了

---

最終更新: 2025-01-13
