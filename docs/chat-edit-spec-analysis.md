# ãƒãƒ£ãƒƒãƒˆä¿®æ­£ã‚·ã‚¹ãƒ†ãƒ  ä»•æ§˜æ•´ç†ãƒ»åˆ†æãƒ»æ”¹å–„è¨ˆç”»

## 1. ç¾çŠ¶ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€Œãƒ†ãƒ­ãƒƒãƒ—ã‚’æ¶ˆã—ã¦ã€                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è§£æï¼ˆparseMessageToIntentï¼‰                    â”‚
â”‚   ãƒ»æ­£è¦è¡¨ç¾ã§å³æ™‚è§£æã‚’è©¦ã¿ã‚‹                                      â”‚
â”‚   ãƒ»æˆåŠŸ â†’ ç›´æ¥ dry-run ã¸                                         â”‚
â”‚   ãƒ»å¤±æ•— â†’ Step 2 ã¸                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    ï¼ˆãƒ«ãƒ¼ãƒ«è§£æå¤±æ•—æ™‚ã®ã¿ï¼‰
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: AIä¼šè©±APIï¼ˆ/chat-edits/chatï¼‰                              â”‚
â”‚   ãƒ»Gemini 2.0 Flash ã‚’ä½¿ç”¨                                        â”‚
â”‚   ãƒ»è‡ªç„¶è¨€èª â†’ JSON Intent å¤‰æ›                                    â”‚
â”‚   ãƒ»assistant_message + suggestion ã‚’è¿”ã™                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: ææ¡ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤º                                              â”‚
â”‚   ãƒ»ã€Œç¢ºèªã™ã‚‹ã€ã€Œã‚„ã‚ã‚‹ã€ãƒœã‚¿ãƒ³                                    â”‚
â”‚   ãƒ»pendingSuggestion ã« intent ã‚’ä¿å­˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                      ï¼ˆã€Œç¢ºèªã™ã‚‹ã€æŠ¼ä¸‹æ™‚ï¼‰
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: confirmSuggestion â†’ processDryRunWithIntent                 â”‚
â”‚   ãƒ»/chat-edits/dry-run API ã‚’å‘¼ã³å‡ºã—                             â”‚
â”‚   ãƒ»intent â†’ SafeOps å¤‰æ›ï¼ˆresolveIntentToOpsï¼‰                    â”‚
â”‚   ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ + å¤‰æ›´ãƒ—ãƒ©ãƒ³ç”Ÿæˆ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: DryRunResultè¡¨ç¤º                                            â”‚
â”‚   ãƒ»å¤‰æ›´å†…å®¹ã‚’è¡¨ç¤ºï¼ˆshowDryRunResultï¼‰                              â”‚
â”‚   ãƒ»ã€Œã“ã®å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹ã€ãƒœã‚¿ãƒ³                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                      ï¼ˆã€Œé©ç”¨ã™ã‚‹ã€æŠ¼ä¸‹æ™‚ï¼‰
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: applyChatEdit â†’ /chat-edits/apply                           â”‚
â”‚   ãƒ»patch_request_id ã‚’ä½¿ã£ã¦å¤‰æ›´ã‚’é©ç”¨                             â”‚
â”‚   ãƒ»æ–°ã—ã„ video_build ã‚’ç”Ÿæˆ                                       â”‚
â”‚   ãƒ»Remotion ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ç¾çŠ¶ã®å•é¡Œç‚¹

### 2.1 ã€Œç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€å•é¡Œ

**è€ƒãˆã‚‰ã‚Œã‚‹åŸå› ï¼š**

1. **pendingSuggestion ãŒ null ã«ãªã£ã¦ã„ã‚‹**
   - ææ¡ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤ºå¾Œã€åˆ¥ã®æ“ä½œã§ state ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹å¯èƒ½æ€§
   - `window.chatEditState.pendingSuggestion` ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œ

2. **intent ã®ã‚¹ã‚­ãƒ¼ãƒä¸ä¸€è‡´**
   - AIãŒè¿”ã™ intent ãŒ `rilarc_intent_v1` ã‚¹ã‚­ãƒ¼ãƒã«å®Œå…¨æº–æ‹ ã—ã¦ã„ãªã„
   - actions é…åˆ—ãŒç©ºã€ã¾ãŸã¯ç„¡åŠ¹ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å«ã‚€

3. **dry-run API ã§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼**
   - `resolveIntentToOps` ã§ scene_idx, balloon_no ã®è§£æ±ºã«å¤±æ•—
   - DB ã«è©²å½“ã™ã‚‹ã‚·ãƒ¼ãƒ³/ãƒãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„

4. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼**
   - API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
   - èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆPROJECT_ID ãŒ undefined ãªã©ï¼‰

**èª¿æŸ»æ–¹æ³•ï¼š**
```javascript
// DevTools Console ã§ç¢ºèª
console.log(window.chatEditState);
console.log(window.chatEditState?.pendingSuggestion);
```

### 2.2 ã€Œæ„å›³ã‚’æ±²ã¿å–ã‚Œãªã„ã€å•é¡Œ

**åŸå› ï¼š**

1. **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã®ä¸è¶³**
   - ç¾çŠ¶ã¯ `scene_idx`, `balloon_no`, `video_build_id` ã®ã¿
   - ã‚·ãƒ¼ãƒ³ã®è©³ç´°ï¼ˆç”»åƒæœ‰ç„¡ã€ãƒ†ãƒ­ãƒƒãƒ—çŠ¶æ…‹ã€ãƒãƒ–ãƒ«æ•°ãªã©ï¼‰ãŒAIã«æ¸¡ã•ã‚Œã¦ã„ãªã„

2. **ä»£åè©ã®è§£æ±ºãŒã§ããªã„**
   - ã€Œã“ã“ã€ã€Œã“ã‚Œã€ã€Œã“ã®ç”»åƒã€ãªã©ã®æŒ‡ç¤ºèªã‚’è§£æ±ºã™ã‚‹ä»•çµ„ã¿ãŒãªã„
   - ã€Œç¾åœ¨æ˜ ã£ã¦ã„ã‚‹ã‚·ãƒ¼ãƒ³ã€ã‚’ç‰¹å®šã§ããªã„

3. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ”¹å–„ä½™åœ°**
   - ä¾‹æ–‡ãŒå°‘ãªã„ï¼ˆç‰¹ã«ã‚·ãƒ¼ãƒ³å˜ä½ã®æ“ä½œï¼‰
   - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®å‡¦ç†ãŒå¼±ã„

---

## 3. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ä»•æ§˜

### 3.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆproject-editor.jsï¼‰

#### çŠ¶æ…‹ç®¡ç†
```javascript
window.chatEditState = {
  // åŸºæœ¬æƒ…å ±
  buildId: number | null,           // å¯¾è±¡ãƒ“ãƒ«ãƒ‰ID
  projectId: number,                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
  videoUrl: string | null,          // å‹•ç”»URL

  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆâ˜…èª²é¡Œ: æ‰‹å‹•è¨­å®šã®ã¿ï¼‰
  contextSceneIdx: number,          // 1-indexed
  contextBalloonNo: number,         // 1-indexed
  
  // ææ¡ˆç®¡ç†
  pendingSuggestion: {
    id: string,                     // DOMè¦ç´ ID
    intent: RilarcIntent,           // è§£æã•ã‚ŒãŸIntent
    summary: string,                // Beforeâ†’Afterè¦ç´„
  } | null,
  
  // ãƒ‡ãƒãƒƒã‚°
  explain: {
    mode: 'ai' | 'regex',
    userMessage: string,
    intent: object,
    rejectedActions: array,
    context: object,
    error: string | null,
  } | null,
};
```

#### ä¸»è¦é–¢æ•°
| é–¢æ•°å | å½¹å‰² | å…¥åŠ› | å‡ºåŠ› |
|--------|------|------|------|
| `sendChatEditMessage()` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å‡¦ç† | message string | void (UIæ›´æ–°) |
| `parseMessageToIntent(message)` | ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è§£æ | message string | { ok, intent, error } |
| `processDryRunWithIntent(intent, ...)` | dry-runå‘¼ã³å‡ºã— | intent object | void (UIæ›´æ–°) |
| `confirmSuggestion(suggestionId)` | ææ¡ˆç¢ºèª | suggestionId string | void (dry-runã¸) |
| `showDryRunResult(result)` | çµæœè¡¨ç¤º | result object | void (UIæ›´æ–°) |
| `applyChatEdit()` | å¤‰æ›´é©ç”¨ | void | void (æ–°ãƒ“ãƒ«ãƒ‰ç”Ÿæˆ) |

### 3.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆpatches.tsï¼‰

#### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
| ãƒ‘ã‚¹ | ãƒ¡ã‚½ãƒƒãƒ‰ | å½¹å‰² | å…¥åŠ› | å‡ºåŠ› |
|------|----------|------|------|------|
| `/chat-edits/chat` | POST | AIä¼šè©± | user_message, context, history | assistant_message, suggestion |
| `/chat-edits/dry-run` | POST | å¤‰æ›´æ¤œè¨¼ | user_message, intent, video_build_id | ok, patch_request_id, plan, summary |
| `/chat-edits/apply` | POST | å¤‰æ›´é©ç”¨ | patch_request_id | ok, new_build |
| `/chat-edits/parse-ai` | POST | Intentè§£æã®ã¿ | user_message | intent, rejected_actions |

#### ä¸»è¦é–¢æ•°
| é–¢æ•°å | å½¹å‰² |
|--------|------|
| `geminiChatWithSuggestion()` | Gemini APIå‘¼ã³å‡ºã—ã€Intent + ä¼šè©±ç”Ÿæˆ |
| `resolveIntentToOps()` | Intent â†’ SafeOps å¤‰æ›ï¼ˆDBæ¤œè¨¼å«ã‚€ï¼‰ |
| `executeDryRun()` | dry-runå®Ÿè¡Œã€å¤‰æ›´ãƒ—ãƒ©ãƒ³ç”Ÿæˆ |
| `executeApply()` | å¤‰æ›´é©ç”¨ã€patch_effectsè¨˜éŒ² |
| `generateDiffSummary()` | UIç”¨ã‚µãƒãƒªãƒ¼ç”Ÿæˆ |

### 3.3 è¨±å¯ã•ã‚ŒãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆALLOWED_CHAT_ACTIONSï¼‰

```typescript
const ALLOWED_CHAT_ACTIONS = new Set([
  // ãƒãƒ–ãƒ«é–¢é€£
  'balloon.adjust_window',    // ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´
  'balloon.adjust_position',  // ä½ç½®èª¿æ•´
  'balloon.set_policy',       // è¡¨ç¤ºãƒãƒªã‚·ãƒ¼è¨­å®š

  // SFXé–¢é€£
  'sfx.set_volume',           // éŸ³é‡è¨­å®š
  'sfx.set_timing',           // ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´
  'sfx.remove',               // å‰Šé™¤
  'sfx.add_from_library',     // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰è¿½åŠ ï¼ˆâ˜…æœªå®Œå…¨å®Ÿè£…ï¼‰

  // BGMé–¢é€£
  'bgm.set_volume',           // éŸ³é‡è¨­å®š
  'bgm.set_loop',             // ãƒ«ãƒ¼ãƒ—è¨­å®š

  // ãƒ†ãƒ­ãƒƒãƒ—é–¢é€£
  'telop.set_enabled',        // å…¨ä½“ON/OFF
  'telop.set_enabled_scene',  // ã‚·ãƒ¼ãƒ³å˜ä½ON/OFF
  'telop.set_position',       // ä½ç½®è¨­å®š (top/center/bottom)
  'telop.set_size',           // ã‚µã‚¤ã‚ºè¨­å®š (sm/md/lg)
]);
```

### 3.4 æœªå®Ÿè£…ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¦æœ›ã‚ã‚Šï¼‰

| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | èª¬æ˜ | é›£æ˜“åº¦ | å„ªå…ˆåº¦ |
|-----------|------|--------|--------|
| `image.set_active` | ç”»åƒå¤‰æ›´ | ä¸­ | é«˜ |
| `motion.set_preset` | ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š | ä¸­ | é«˜ |
| `utterance.adjust_timing` | éŸ³å£°ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´ | ä½ | ä¸­ |
| `utterance.remove` | éŸ³å£°å‰Šé™¤ | ä½ | ä¸­ |
| `sfx.add` | SFXè¿½åŠ ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªä»¥å¤–ï¼‰ | ä¸­ | ä½ |

---

## 4. æ”¹å–„è¨ˆç”»

### Phase 1: ãƒã‚°ä¿®æ­£ãƒ»å®‰å®šåŒ–ï¼ˆ1-2æ—¥ï¼‰

#### 1.1 ç¢ºèªãƒœã‚¿ãƒ³ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£
**ä½œæ¥­å†…å®¹ï¼š**
- `confirmSuggestion` ã§ `pendingSuggestion` ãŒ null ã®å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
- dry-run API ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚ˆã‚Šè©³ç´°ã«
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ”¹å–„

**ä¿®æ­£ç®‡æ‰€ï¼š**
- `project-editor.js`: `confirmSuggestion()` é–¢æ•°
- `patches.ts`: `/chat-edits/dry-run` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### 1.2 ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å¼·åŒ–
**ä½œæ¥­å†…å®¹ï¼š**
- å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®çŠ¶æ…‹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
- `window.chatEditDebug` ãƒ•ãƒ©ã‚°ã§è©³ç´°ãƒ­ã‚°ã‚’ON/OFF

### Phase 2: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¼·åŒ–ï¼ˆ3-5æ—¥ï¼‰

#### 2.1 å†ç”Ÿä½ç½®ã‹ã‚‰ã‚·ãƒ¼ãƒ³ã‚’ç‰¹å®š
**è¨­è¨ˆï¼š**
```javascript
// å†ç”Ÿä¸­ã®ã‚·ãƒ¼ãƒ³æƒ…å ±ã‚’å–å¾—
function getCurrentSceneFromVideo(currentTime) {
  const scenes = window.lastLoadedScenes; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿
  let accumulatedTime = 0;
  
  for (let i = 0; i < scenes.length; i++) {
    const sceneDuration = scenes[i].duration_ms || 5000;
    if (currentTime * 1000 < accumulatedTime + sceneDuration) {
      return {
        scene_idx: i + 1,
        scene_id: scenes[i].id,
        has_image: !!scenes[i].image_url,
        has_audio: !!scenes[i].utterances?.length,
        balloon_count: scenes[i].balloons?.length || 0,
        sfx_count: scenes[i].audio_cues?.length || 0,
        telop_enabled: scenes[i].telop_enabled !== false,
      };
    }
    accumulatedTime += sceneDuration;
  }
  return null;
}
```

**å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®é€£æºï¼š**
```javascript
// videoè¦ç´ ã®timeupdateã‚¤ãƒ™ãƒ³ãƒˆã§æ›´æ–°
videoElement.addEventListener('timeupdate', () => {
  const currentScene = getCurrentSceneFromVideo(videoElement.currentTime);
  if (currentScene) {
    window.chatEditState.currentScene = currentScene;
  }
});
```

#### 2.2 AI ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¸ã‚·ãƒ¼ãƒ³çŠ¶æ…‹è¿½åŠ 
**ç¾çŠ¶ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼š**
```javascript
{
  scene_idx: 1,
  balloon_no: 1,
  video_build_id: 123,
  has_bgm: true,
  has_sfx: false,
}
```

**å¼·åŒ–å¾Œã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼š**
```javascript
{
  // åŸºæœ¬æƒ…å ±
  scene_idx: 1,
  balloon_no: 1,
  video_build_id: 123,
  
  // ç´ æçŠ¶æ…‹ï¼ˆæ—¢å­˜ï¼‰
  has_bgm: true,
  has_sfx: false,
  has_system_bgm: true,
  has_system_sfx: true,
  
  // ã‚·ãƒ¼ãƒ³è©³ç´°ï¼ˆâ˜…æ–°è¦è¿½åŠ ï¼‰
  current_scene: {
    scene_id: 456,
    has_image: true,
    has_audio: true,
    balloon_count: 2,
    sfx_count: 1,
    telop_enabled: true,
    duration_ms: 5000,
  },
  
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ï¼ˆâ˜…æ–°è¦è¿½åŠ ï¼‰
  total_scenes: 10,
  current_playback_time_ms: 12500,
}
```

### Phase 3: æ–°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆ1-2é€±é–“ï¼‰

#### 3.1 ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆmotion.set_presetï¼‰
**ã‚¹ã‚­ãƒ¼ãƒï¼š**
```typescript
interface MotionSetPresetAction {
  action: 'motion.set_preset';
  scene_idx: number;
  preset: 'ken_burns' | 'zoom_in' | 'zoom_out' | 'pan_left' | 'pan_right' | 'static';
}
```

#### 3.2 ç”»åƒå¤‰æ›´ï¼ˆimage.set_activeï¼‰
**ã‚¹ã‚­ãƒ¼ãƒï¼š**
```typescript
interface ImageSetActiveAction {
  action: 'image.set_active';
  scene_idx: number;
  image_generation_id: number; // åˆ‡ã‚Šæ›¿ãˆå…ˆã®ç”»åƒID
}
```

---

## 5. å®Ÿè£…å„ªå…ˆåº¦ã¾ã¨ã‚

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | å·¥æ•° | åŠ¹æœ |
|--------|--------|------|------|
| ğŸ”´ é«˜ | ç¢ºèªãƒœã‚¿ãƒ³ã‚¨ãƒ©ãƒ¼ä¿®æ­£ | 2-4h | ãƒã‚°ä¿®æ­£ï¼ˆå¿…é ˆï¼‰ |
| ğŸ”´ é«˜ | ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å¼·åŒ– | 1-2h | èª¿æŸ»åŠ¹ç‡å‘ä¸Š |
| ğŸŸ  ä¸­ | å†ç”Ÿä½ç½®â†’ã‚·ãƒ¼ãƒ³é€£æº | 4-6h | UXå¤§å¹…å‘ä¸Š |
| ğŸŸ  ä¸­ | AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚·ãƒ¼ãƒ³çŠ¶æ…‹è¿½åŠ  | 2-4h | æ„å›³ç†è§£å‘ä¸Š |
| ğŸŸ¡ ä½ | motion.set_preset è¿½åŠ  | 6-8h | æ©Ÿèƒ½æ‹¡å¼µ |
| ğŸŸ¡ ä½ | image.set_active è¿½åŠ  | 6-8h | æ©Ÿèƒ½æ‹¡å¼µ |

---

## 6. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å³æ™‚å¯¾å¿œï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ»èª¿æŸ»ï¼‰

1. **DevToolsã§ç¢ºèªãƒœã‚¿ãƒ³ã‚¨ãƒ©ãƒ¼ã®å†ç¾ãƒ»èª¿æŸ»**
   ```javascript
   // DevTools Console ã§å®Ÿè¡Œ
   console.log('State:', JSON.stringify(window.chatEditState, null, 2));
   console.log('Pending:', window.chatEditState?.pendingSuggestion);
   ```

2. **Network ã‚¿ãƒ–ã§APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª**
   - `/chat-edits/chat` ã® suggestion å†…å®¹
   - `/chat-edits/dry-run` ã®ã‚¨ãƒ©ãƒ¼è©³ç´°

### çŸ­æœŸå¯¾å¿œï¼ˆ1-2æ—¥ï¼‰

3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**
   - `confirmSuggestion` ã§ intent ã®äº‹å‰æ¤œè¨¼ã‚’è¿½åŠ 
   - dry-run API ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã‚ˆã‚Šè©³ç´°ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’æ”¹å–„ï¼ˆå…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼åŸå› ã‚’è¡¨ç¤ºï¼‰

### ä¸­æœŸå¯¾å¿œï¼ˆ1é€±é–“ï¼‰

4. **ã‚·ãƒ¼ãƒ³é€£æºã®å®Ÿè£…**
   - å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã® `timeupdate` ã‚¤ãƒ™ãƒ³ãƒˆã§ç¾åœ¨ã‚·ãƒ¼ãƒ³ã‚’ç‰¹å®š
   - `window.chatEditState.currentScene` ã«è©³ç´°æƒ…å ±ã‚’æ ¼ç´
   - AIä¼šè©±APIã«ç¾åœ¨ã‚·ãƒ¼ãƒ³æƒ…å ±ã‚’è¿½åŠ 

5. **AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„**
   - ç¾åœ¨ã‚·ãƒ¼ãƒ³ã®è©³ç´°æƒ…å ±ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
   - ã€Œã“ã“ã€ã€Œã“ã‚Œã€ãªã©ã®ä»£åè©è§£æ±ºã®ãƒ’ãƒ³ãƒˆè¿½åŠ 

---

## 7. è¨­è¨ˆæ–¹é‡ã®ç¢ºå®šäº‹é …

### 7.1 ã‚·ãƒ¼ãƒ³ç‰¹å®šã®ä»•çµ„ã¿

**æ–¹é‡**: å‹•ç”»å†ç”Ÿä½ç½®ã‹ã‚‰ã‚·ãƒ¼ãƒ³ã‚’ç‰¹å®šã—ã€ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è‡ªå‹•åæ˜ 

```javascript
// å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸
function syncCurrentScene() {
  const video = document.getElementById('chatEditVideo');
  if (!video) return;
  
  const currentTimeMs = video.currentTime * 1000;
  const scenes = window.lastLoadedScenes || [];
  
  let accTime = 0;
  for (let i = 0; i < scenes.length; i++) {
    const dur = scenes[i].duration_ms || 5000;
    if (currentTimeMs < accTime + dur) {
      window.chatEditState.currentScene = {
        idx: i + 1,
        id: scenes[i].id,
        has_image: !!scenes[i].image_url,
        balloon_count: scenes[i].balloons?.length || 0,
        telop_enabled: scenes[i].telop_enabled !== false,
      };
      // UIæ›´æ–°
      updateContextDisplay();
      return;
    }
    accTime += dur;
  }
}

// å‹•ç”»ã® timeupdate ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒãƒ¼ãƒªãƒ³ã‚°
video.addEventListener('timeupdate', syncCurrentScene);
```

### 7.2 ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¼·åŒ–ã®APIè¨­è¨ˆ

**å¤‰æ›´å‰**:
```json
{
  "context": {
    "scene_idx": 1,
    "balloon_no": 1,
    "video_build_id": 123
  }
}
```

**å¤‰æ›´å¾Œ**:
```json
{
  "context": {
    "scene_idx": 1,
    "balloon_no": 1,
    "video_build_id": 123,
    "current_scene": {
      "id": 456,
      "has_image": true,
      "has_audio": true,
      "balloon_count": 2,
      "sfx_count": 1,
      "telop_enabled": true
    },
    "total_scenes": 10,
    "playback_time_ms": 12500
  }
}
```

### 7.3 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ–¹é‡

**åŸå‰‡**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤º |
|-------------------|-------------------|
| `Scene not found: scene_idx=X` | ã€Œã‚·ãƒ¼ãƒ³XãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒ¼ãƒ³ç•ªå·ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã€ |
| `Balloon not found` | ã€ŒæŒ‡å®šã•ã‚ŒãŸãƒãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã“ã®ã‚·ãƒ¼ãƒ³ã«ã¯Xå€‹ã®ãƒãƒ–ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚ã€ |
| `ops array is empty` | ã€Œå¤‰æ›´å†…å®¹ã‚’ç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ˆã‚Šå…·ä½“çš„ã«æŒ‡ç¤ºã—ã¦ãã ã•ã„ã€‚ã€ |
| `Invalid scene_idx` | ã€Œã‚·ãƒ¼ãƒ³ç•ªå·ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚1ä»¥ä¸Šã®æ•°å€¤ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚ã€ |
